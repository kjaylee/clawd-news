<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Conveyor Sort Factory</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0f0f23;touch-action:none;user-select:none;-webkit-user-select:none}
canvas{display:block;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
'use strict';
const C=document.getElementById('c'), X=C.getContext('2d');

// ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê
const COLORS=['#FF4444','#4488FF','#44CC44','#FFCC00','#CC44CC'];
const COLOR_GLOW=['#ff666640','#66aaff40','#66ee6640','#ffdd4440','#ee66ee40'];
const BG='#1a1a2e';
const BIN_CAP=5, MATCH=3, WAVE_TARGET=20;

// ‚ïê‚ïê‚ïê SIZING ‚ïê‚ïê‚ïê
const BW=400, BH=750;
let W,H,sc;
function resize(){
  const dpr=window.devicePixelRatio||1;
  const ar=BW/BH;
  let cw,ch;
  if(innerWidth/innerHeight<ar){cw=innerWidth;ch=innerWidth/ar}
  else{ch=innerHeight;cw=innerHeight*ar}
  C.style.width=cw+'px'; C.style.height=ch+'px';
  C.width=cw*dpr; C.height=ch*dpr;
  W=BW; H=BH; sc=cw*dpr/BW;
  X.setTransform(sc,0,0,sc,0,0);
}
addEventListener('resize',resize); resize();

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let ST='menu'; // menu|play|over
let score=0, hi=0, wave=1, combo=0, cleared=0;
let items=[], bins=[], sws=[], fx=[], pops=[];
let spawnT=0, spawnI=2500, beltSpd=1.5;
let nBelts=2, nColors=3, nSw=1;
let lt=0, mt=0;
let beltX=[], binData=[];

try{hi=parseInt(localStorage.getItem('csf-hi'))||0}catch(e){}

// ‚ïê‚ïê‚ïê WAVE CONFIG ‚ïê‚ïê‚ïê
function cfgWave(w){
  if(w<=5){nBelts=2;nColors=3;nSw=1}
  else if(w<=10){nBelts=3;nColors=4;nSw=2}
  else{nBelts=3;nColors=5;nSw=3}
  const t=Math.min(w-1,20)/20;
  spawnI=2500-(2500-800)*t;
  beltSpd=1.5+(4.0-1.5)*t;
}

// ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê
const TOP_Y=90, BOT_Y=560;

function buildLayout(){
  beltX=[];
  for(let i=0;i<nBelts;i++) beltX.push(W*(i+1)/(nBelts+1));
  
  // Bins: one per belt at bottom
  binData=[];
  for(let i=0;i<nBelts;i++){
    binData.push({x:beltX[i], y:BOT_Y+70, items:[], w:60, h:90});
  }
  
  // Switches between adjacent belts
  sws=[];
  const gap=(BOT_Y-TOP_Y-60)/(nSw+1);
  for(let s=0;s<nSw;s++){
    const bi=s%(nBelts-1);
    const sy=TOP_Y+60+(s+1)*gap;
    sws.push({
      x:(beltX[bi]+beltX[bi+1])/2, y:sy,
      lb:bi, rb:bi+1,
      dir:0, // 0=straight, 1=swap
      w:70, h:44, flash:0
    });
  }
}

// ‚ïê‚ïê‚ïê SPAWN ‚ïê‚ïê‚ïê
function spawn(){
  const b=Math.floor(Math.random()*nBelts);
  const ci=Math.floor(Math.random()*nColors);
  items.push({belt:b, x:beltX[b], y:TOP_Y-25, color:COLORS[ci], ci, r:15, passed:new Set()});
}

// ‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê
function emitFX(x,y,col,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2, sp=1.5+Math.random()*3.5;
    fx.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2.5,life:1,d:.015+Math.random()*.02,col,sz:2+Math.random()*5});
  }
}
function addPop(txt,x,y,col){pops.push({txt,x,y,col:col||'#fff',life:1,d:.018})}

// ‚ïê‚ïê‚ïê BIN LOGIC ‚ïê‚ïê‚ïê
function itemToBin(item){
  const bi=item.belt;
  if(bi<0||bi>=binData.length)return;
  const bin=binData[bi];
  bin.items.push({color:item.color, ci:item.ci, flash:1});
  checkMatch(bi);
  if(bin.items.length>BIN_CAP) return gameOver();
}

function checkMatch(bi){
  const bin=binData[bi];
  const cnt={};
  for(const it of bin.items) cnt[it.color]=(cnt[it.color]||0)+1;
  for(const col in cnt){
    if(cnt[col]>=MATCH){
      let rm=0;
      bin.items=bin.items.filter(it=>{
        if(it.color===col&&rm<MATCH){rm++;return false}
        return true;
      });
      combo++;
      cleared+=MATCH;
      const pts=100*combo;
      score+=pts;
      emitFX(bin.x,bin.y-30,col,25);
      addPop(combo>1?`COMBO x${combo}! +${pts}`:`+${pts}`,bin.x,bin.y-70,col);
      if(cleared>=WAVE_TARGET){
        cleared-=WAVE_TARGET;
        wave++;
        cfgWave(wave);
        // Preserve items in transit, clamp belt indices
        const oldItems=[...items];
        buildLayout();
        items=oldItems;
        for(const it of items){
          it.belt=Math.min(it.belt,nBelts-1);
          it.x=beltX[it.belt];
          it.passed=new Set(); // reset switch tracking for new layout
        }
        // Wave bonus score
        score+=50*wave;
        addPop(`‚öô WAVE ${wave} ‚öô`,W/2,H/3,'#FFD700');
        addPop(`+${50*wave} BONUS`,W/2,H/3+30,'#44CC44');
      }
      return;
    }
  }
  combo=0;
}

function gameOver(){
  ST='over';
  if(score>hi){hi=score;try{localStorage.setItem('csf-hi',hi)}catch(e){}}
}

function startGame(){
  ST='play';score=0;combo=0;wave=1;cleared=0;
  items=[];fx=[];pops=[];spawnT=0;
  cfgWave(1);buildLayout();
}

// ‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê
function tap(px,py){
  const r=C.getBoundingClientRect();
  const x=(px-r.left)/r.width*W, y=(py-r.top)/r.height*H;
  if(ST==='menu'){startGame();return}
  if(ST==='over'){
    if(y>H/2+50&&y<H/2+120){startGame()}
    return;
  }
  for(const s of sws){
    if(Math.abs(x-s.x)<s.w/2+20&&Math.abs(y-s.y)<s.h/2+20){
      s.dir=s.dir?0:1;
      s.flash=1;
      return;
    }
  }
}
C.addEventListener('pointerdown',e=>{e.preventDefault();tap(e.clientX,e.clientY)});

// ‚ïê‚ïê‚ïê UPDATE ‚ïê‚ïê‚ïê
function update(dt){
  if(ST!=='play')return;
  spawnT+=dt;
  if(spawnT>=spawnI){spawnT-=spawnI;spawn()}
  
  for(let i=items.length-1;i>=0;i--){
    const it=items[i];
    const tx=beltX[it.belt];
    it.x+=(tx-it.x)*0.12;
    it.y+=beltSpd*(dt/16);
    // Switch check
    for(let si=0;si<sws.length;si++){
      const s=sws[si];
      if(it.passed.has(si))continue;
      if(Math.abs(it.y-s.y)<10){
        it.passed.add(si);
        if(s.dir===1){
          if(it.belt===s.lb)it.belt=s.rb;
          else if(it.belt===s.rb)it.belt=s.lb;
        }
      }
    }
    if(it.y>=BOT_Y+10){
      itemToBin(it);
      items.splice(i,1);
      if(ST!=='play')return;
    }
  }
  // FX update
  for(let i=fx.length-1;i>=0;i--){
    const p=fx[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life-=p.d;
    if(p.life<=0)fx.splice(i,1);
  }
  for(let i=pops.length-1;i>=0;i--){
    const p=pops[i];
    p.y-=.7;p.life-=p.d;
    if(p.life<=0)pops.splice(i,1);
  }
  // Switch flash decay
  for(const s of sws)if(s.flash>0)s.flash=Math.max(0,s.flash-.03);
  // Bin item flash decay
  for(const b of binData)for(const it of b.items)if(it.flash>0)it.flash=Math.max(0,it.flash-.04);
}

// ‚ïê‚ïê‚ïê DRAW HELPERS ‚ïê‚ïê‚ïê
function rr(x,y,w,h,r){
  X.beginPath();
  X.moveTo(x+r,y);
  X.arcTo(x+w,y,x+w,y+h,r);
  X.arcTo(x+w,y+h,x,y+h,r);
  X.arcTo(x,y+h,x,y,r);
  X.arcTo(x,y,x+w,y,r);
  X.closePath();
}

function drawBelt(bx,idx){
  const w=34;
  // Belt shadow
  X.fillStyle='#0003';
  rr(bx-w/2+3,TOP_Y+3,w,BOT_Y-TOP_Y,5);X.fill();
  // Belt body
  const grd=X.createLinearGradient(bx-w/2,0,bx+w/2,0);
  grd.addColorStop(0,'#2a2a4e');
  grd.addColorStop(0.5,'#353560');
  grd.addColorStop(1,'#2a2a4e');
  X.fillStyle=grd;
  rr(bx-w/2,TOP_Y,w,BOT_Y-TOP_Y,5);X.fill();
  // Animated belt ribs - direction arrows
  X.strokeStyle='#4a4a7040';
  X.lineWidth=1;
  const off=(Date.now()/(30/beltSpd))%18;
  for(let y=TOP_Y+off;y<BOT_Y;y+=18){
    X.beginPath();X.moveTo(bx-w/2+4,y);X.lineTo(bx+w/2-4,y);X.stroke();
    // Small chevrons
    X.beginPath();
    X.moveTo(bx-5,y-3);X.lineTo(bx,y);X.lineTo(bx+5,y-3);
    X.strokeStyle='#5a5a8a30';X.stroke();
    X.strokeStyle='#4a4a7040';
  }
  // Metal edges
  X.strokeStyle='#5a5a8a50';
  X.lineWidth=2;
  X.beginPath();X.moveTo(bx-w/2,TOP_Y);X.lineTo(bx-w/2,BOT_Y);X.stroke();
  X.beginPath();X.moveTo(bx+w/2,TOP_Y);X.lineTo(bx+w/2,BOT_Y);X.stroke();
  // Top funnel with belt number
  X.fillStyle='#3a3a5a';
  X.beginPath();
  X.moveTo(bx-w/2-10,TOP_Y-8);X.lineTo(bx+w/2+10,TOP_Y-8);
  X.lineTo(bx+w/2,TOP_Y+5);X.lineTo(bx-w/2,TOP_Y+5);
  X.closePath();X.fill();
  X.strokeStyle='#5a5a8a';X.lineWidth=1;
  X.beginPath();
  X.moveTo(bx-w/2-10,TOP_Y-8);X.lineTo(bx+w/2+10,TOP_Y-8);
  X.lineTo(bx+w/2,TOP_Y+5);X.lineTo(bx-w/2,TOP_Y+5);
  X.closePath();X.stroke();
}

function drawSwitch(s){
  const act=s.dir===1;
  const lx=beltX[s.lb], rx=beltX[s.rb];
  
  // Connection pipes
  X.strokeStyle=act?'#ffd70060':'#55558050';
  X.lineWidth=3;
  X.setLineDash([6,4]);
  X.beginPath();X.moveTo(lx,s.y);X.lineTo(s.x-s.w/2+5,s.y);X.stroke();
  X.beginPath();X.moveTo(rx,s.y);X.lineTo(s.x+s.w/2-5,s.y);X.stroke();
  X.setLineDash([]);
  
  // Cross-pipes when active
  if(act){
    X.strokeStyle='#ffd70080';
    X.lineWidth=2;
    X.beginPath();
    X.moveTo(lx,s.y-8);X.bezierCurveTo(s.x,s.y-8,s.x,s.y+8,rx,s.y+8);
    X.stroke();
    X.beginPath();
    X.moveTo(rx,s.y-8);X.bezierCurveTo(s.x,s.y-8,s.x,s.y+8,lx,s.y+8);
    X.stroke();
  }
  
  // Button body
  const glow=s.flash;
  if(glow>0){
    X.shadowColor=act?'#ffd700':'#8888ff';
    X.shadowBlur=20*glow;
  }
  X.fillStyle=act?'#d4941a':'#44447a';
  rr(s.x-s.w/2,s.y-s.h/2,s.w,s.h,10);X.fill();
  X.strokeStyle=act?'#ffd700':'#6666aa';
  X.lineWidth=2;
  rr(s.x-s.w/2,s.y-s.h/2,s.w,s.h,10);X.stroke();
  X.shadowBlur=0;
  
  // Icon
  X.fillStyle='#fff';
  X.font='bold 20px monospace';
  X.textAlign='center';X.textBaseline='middle';
  X.fillText(act?'‚áÑ':'‚Üì‚Üì',s.x,s.y);
  
  // Label
  X.fillStyle='#fff8';
  X.font='9px monospace';
  X.fillText(act?'SWAP':'THRU',s.x,s.y+s.h/2+10);
}

function drawBin(bin,idx){
  const bw=bin.w, bh=bin.h;
  const bx=bin.x-bw/2, by=bin.y-bh/2;
  
  // Shadow
  X.fillStyle='#0004';
  rr(bx+3,by+3,bw,bh,8);X.fill();
  
  // Body
  X.fillStyle='#1a1a35';
  rr(bx,by,bw,bh,8);X.fill();
  
  // Border glow based on fill level
  const fillRatio=bin.items.length/BIN_CAP;
  const borderCol=fillRatio>.8?'#ff4444':fillRatio>.5?'#ffaa00':'#4a4a7a';
  X.strokeStyle=borderCol;
  X.lineWidth=2;
  rr(bx,by,bw,bh,8);X.stroke();
  
  // Fill level BG
  if(bin.items.length>0){
    const fh=bh*(bin.items.length/BIN_CAP);
    X.fillStyle=fillRatio>.8?'#ff444415':'#ffffff08';
    rr(bx+2,by+bh-fh,bw-4,fh,6);X.fill();
  }
  
  // Items in bin (stacked circles)
  const sz=12;
  for(let i=0;i<bin.items.length;i++){
    const iy=bin.y+bh/2-14-i*(sz+5);
    const it=bin.items[i];
    // Glow on new
    if(it.flash>0){
      X.shadowColor=it.color;
      X.shadowBlur=15*it.flash;
    }
    X.fillStyle=it.color;
    X.beginPath();X.arc(bin.x,iy,sz/2+2,0,Math.PI*2);X.fill();
    X.strokeStyle='#fff3';X.lineWidth=1;
    X.beginPath();X.arc(bin.x,iy,sz/2+2,0,Math.PI*2);X.stroke();
    X.shadowBlur=0;
  }
  
  // Capacity
  X.fillStyle=fillRatio>.8?'#ff6666':'#888';
  X.font='bold 11px monospace';
  X.textAlign='center';X.textBaseline='top';
  X.fillText(`${bin.items.length}/${BIN_CAP}`,bin.x,bin.y+bh/2+6);
  
  // Bin label
  X.fillStyle='#aaa';
  X.font='9px monospace';
  X.fillText(`BIN ${idx+1}`,bin.x,bin.y+bh/2+20);
}

function drawItem(it){
  // Trail
  X.fillStyle=it.color+'30';
  X.beginPath();X.arc(it.x,it.y-8,it.r*.7,0,Math.PI*2);X.fill();
  // Shadow
  X.fillStyle='#00000050';
  X.beginPath();X.ellipse(it.x+2,it.y+3,it.r,it.r*.6,0,0,Math.PI*2);X.fill();
  // Body
  X.fillStyle=it.color;
  X.beginPath();X.arc(it.x,it.y,it.r,0,Math.PI*2);X.fill();
  // Highlight
  X.fillStyle='#ffffff55';
  X.beginPath();X.arc(it.x-4,it.y-4,it.r*.35,0,Math.PI*2);X.fill();
  // Outline
  X.strokeStyle='#ffffff30';X.lineWidth=1.5;
  X.beginPath();X.arc(it.x,it.y,it.r,0,Math.PI*2);X.stroke();
}

function drawFX(){
  for(const p of fx){
    X.globalAlpha=p.life;
    X.fillStyle=p.col;
    X.beginPath();X.arc(p.x,p.y,p.sz*p.life,0,Math.PI*2);X.fill();
  }
  X.globalAlpha=1;
}

function drawPops(){
  for(const p of pops){
    X.globalAlpha=Math.min(1,p.life*1.5);
    X.font='bold 18px monospace';
    X.textAlign='center';X.textBaseline='middle';
    X.strokeStyle='#000';X.lineWidth=4;
    X.strokeText(p.txt,p.x,p.y);
    X.fillStyle=p.col;
    X.fillText(p.txt,p.x,p.y);
  }
  X.globalAlpha=1;
}

function drawHUD(){
  // Top bar bg
  const g=X.createLinearGradient(0,0,0,70);
  g.addColorStop(0,'#000c');g.addColorStop(1,'#0000');
  X.fillStyle=g;X.fillRect(0,0,W,70);
  
  // Wave
  X.fillStyle='#aaa';X.font='bold 12px monospace';
  X.textAlign='left';X.textBaseline='middle';
  X.fillText(`WAVE ${wave}`,12,18);
  
  // High score
  X.textAlign='right';
  X.fillStyle='#FFD70088';
  X.fillText(`HI ${hi}`,W-12,18);
  
  // Score
  X.textAlign='center';
  X.fillStyle='#fff';X.font='bold 26px monospace';
  X.fillText(score,W/2,24);
  
  // Combo indicator
  if(combo>1){
    X.fillStyle='#FFD700';X.font='bold 13px monospace';
    X.fillText(`üî• COMBO x${combo}`,W/2,48);
  }
  
  // Wave progress
  const prog=cleared/WAVE_TARGET;
  X.fillStyle='#ffffff15';
  rr(12,58,W-24,6,3);X.fill();
  if(prog>0){
    X.fillStyle='#4488FF';
    rr(12,58,(W-24)*Math.min(1,prog),6,3);X.fill();
  }
  X.fillStyle='#fff5';X.font='9px monospace';
  X.textAlign='right';
  X.fillText(`${cleared}/${WAVE_TARGET}`,W-14,56);
}

// ‚ïê‚ïê‚ïê GEAR ‚ïê‚ïê‚ïê
function drawGear(cx,cy,r,teeth,ang){
  X.save();X.translate(cx,cy);X.rotate(ang);
  X.strokeStyle='#ffffff0a';X.lineWidth=2;
  X.beginPath();X.arc(0,0,r*.6,0,Math.PI*2);X.stroke();
  for(let i=0;i<teeth;i++){
    const a=(Math.PI*2/teeth)*i;
    const ir=r*.55,or=r;
    X.beginPath();
    X.moveTo(Math.cos(a-.1)*ir,Math.sin(a-.1)*ir);
    X.lineTo(Math.cos(a-.08)*or,Math.sin(a-.08)*or);
    X.lineTo(Math.cos(a+.08)*or,Math.sin(a+.08)*or);
    X.lineTo(Math.cos(a+.1)*ir,Math.sin(a+.1)*ir);
    X.closePath();
    X.fillStyle='#ffffff08';X.fill();
  }
  X.beginPath();X.arc(0,0,r*.3,0,Math.PI*2);
  X.fillStyle='#ffffff06';X.fill();
  X.restore();
}

// ‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê
function drawMenu(){
  mt+=.015;
  X.fillStyle=BG;X.fillRect(0,0,W,H);
  
  // Background gears
  drawGear(60,160,40,8,mt);
  drawGear(350,210,32,6,-mt*1.3);
  drawGear(200,640,45,10,mt*.7);
  drawGear(40,520,24,6,-mt);
  drawGear(360,470,30,7,mt*1.1);
  drawGear(200,160,20,5,mt*1.6);
  
  // Conveyor belt decoration
  X.fillStyle='#2a2a4e';
  rr(W/2-18,80,36,200,5);X.fill();
  const off2=(Date.now()/50)%18;
  X.strokeStyle='#4a4a7040';X.lineWidth=1;
  for(let y=80+off2;y<280;y+=18){
    X.beginPath();X.moveTo(W/2-14,y);X.lineTo(W/2+14,y);X.stroke();
  }
  
  // Title
  X.fillStyle='#FFD700';
  X.font='bold 36px monospace';
  X.textAlign='center';X.textBaseline='middle';
  X.strokeStyle='#000';X.lineWidth=4;
  X.strokeText('CONVEYOR',W/2,340);
  X.fillText('CONVEYOR',W/2,340);
  X.strokeText('SORT',W/2,385);
  X.fillText('SORT',W/2,385);
  
  X.fillStyle='#8888aa';X.font='16px monospace';
  X.fillText('‚öô  F A C T O R Y  ‚öô',W/2,420);
  
  // Animated color items
  for(let i=0;i<5;i++){
    const ax=65+i*70;
    const ay=470+Math.sin(mt*3+i*.8)*8;
    X.fillStyle=COLORS[i];
    X.beginPath();X.arc(ax,ay,13,0,Math.PI*2);X.fill();
    X.fillStyle='#fff4';
    X.beginPath();X.arc(ax-3,ay-3,5,0,Math.PI*2);X.fill();
  }
  
  // Instructions
  X.fillStyle='#7777aa';X.font='12px monospace';
  X.fillText('üîÄ Tap switches to redirect items',W/2,520);
  X.fillText('üéØ Match 3 same colors in a bin',W/2,542);
  X.fillText('‚ö†Ô∏è  Don\'t overflow the bins!',W/2,564);
  
  // Play button
  const btnY=620;
  const pulse=Math.sin(mt*4)*.1+1;
  X.save();
  X.translate(W/2,btnY);X.scale(pulse,pulse);
  X.fillStyle='#4488FF';
  rr(-90,-28,180,56,14);X.fill();
  X.strokeStyle='#66aaff';X.lineWidth=2;
  rr(-90,-28,180,56,14);X.stroke();
  X.fillStyle='#fff';X.font='bold 22px monospace';
  X.fillText('‚ñ∂  PLAY',0,0);
  X.restore();
  
  if(hi>0){
    X.fillStyle='#FFD70066';X.font='13px monospace';
    X.textAlign='center';
    X.fillText(`üèÜ Best: ${hi}`,W/2,670);
  }
}

// ‚ïê‚ïê‚ïê GAME OVER ‚ïê‚ïê‚ïê
function drawOver(){
  X.fillStyle='#000b';X.fillRect(0,0,W,H);
  
  // Red glow
  const rg=X.createRadialGradient(W/2,H/2-60,10,W/2,H/2-60,200);
  rg.addColorStop(0,'#ff444420');rg.addColorStop(1,'#0000');
  X.fillStyle=rg;X.fillRect(0,0,W,H);
  
  X.fillStyle='#FF4444';
  X.font='bold 40px monospace';
  X.textAlign='center';X.textBaseline='middle';
  X.strokeStyle='#000';X.lineWidth=4;
  X.strokeText('GAME OVER',W/2,H/2-100);
  X.fillText('GAME OVER',W/2,H/2-100);
  
  X.fillStyle='#fff';X.font='bold 28px monospace';
  X.fillText(score,W/2,H/2-40);
  X.fillStyle='#aaa';X.font='14px monospace';
  X.fillText('points',W/2,H/2-15);
  
  X.fillStyle='#FFD700';X.font='16px monospace';
  X.fillText(`Wave ${wave} reached`,W/2,H/2+20);
  
  if(score>=hi&&score>0){
    X.fillStyle='#FFD700';X.font='bold 16px monospace';
    X.fillText('‚òÖ NEW HIGH SCORE ‚òÖ',W/2,H/2+50);
  }
  
  X.fillStyle='#4488FF';
  rr(W/2-90,H/2+70,180,56,14);X.fill();
  X.strokeStyle='#66aaff';X.lineWidth=2;
  rr(W/2-90,H/2+70,180,56,14);X.stroke();
  X.fillStyle='#fff';X.font='bold 20px monospace';
  X.fillText('PLAY AGAIN',W/2,H/2+98);
}

// ‚ïê‚ïê‚ïê MAIN DRAW ‚ïê‚ïê‚ïê
function draw(){
  X.fillStyle=BG;X.fillRect(0,0,W,H);
  
  if(ST==='menu'){drawMenu();return}
  
  // Factory floor grid
  X.fillStyle='#1e1e38';
  for(let gx=0;gx<W;gx+=36){
    for(let gy=0;gy<H;gy+=36){
      if((Math.floor(gx/36)+Math.floor(gy/36))%2===0)
        X.fillRect(gx,gy,36,36);
    }
  }
  
  // Belt‚ÜíBin connections
  X.strokeStyle='#3a3a5a50';X.lineWidth=2;X.setLineDash([4,6]);
  for(let i=0;i<nBelts;i++){
    const bx=beltX[i], bin=binData[i];
    if(!bin)continue;
    X.beginPath();
    X.moveTo(bx,BOT_Y);
    X.quadraticCurveTo(bx,BOT_Y+20,bin.x,bin.y-bin.h/2);
    X.stroke();
  }
  X.setLineDash([]);
  
  // Belts
  beltX.forEach((bx,i)=>drawBelt(bx,i));
  
  // Switches
  for(const s of sws) drawSwitch(s);
  
  // Items
  for(const it of items) drawItem(it);
  
  // Bins
  binData.forEach((b,i)=>drawBin(b,i));
  
  // FX
  drawFX();
  drawPops();
  
  // HUD
  drawHUD();
  
  // Active colors legend
  X.fillStyle='#ffffff20';
  X.font='9px monospace';
  X.textAlign='center';X.textBaseline='middle';
  X.fillText('ACTIVE COLORS',W/2,H-18);
  for(let i=0;i<nColors;i++){
    const cx=W/2+(i-(nColors-1)/2)*28;
    X.fillStyle=COLORS[i];
    X.beginPath();X.arc(cx,H-36,7,0,Math.PI*2);X.fill();
  }
  
  if(ST==='over') drawOver();
}

// ‚ïê‚ïê‚ïê LOOP ‚ïê‚ïê‚ïê
function loop(ts){
  const dt=lt?Math.min(ts-lt,50):16;
  lt=ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
<script src="../cross-promo.js"></script>
</body>
</html>
