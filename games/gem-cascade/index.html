<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Gem Cascade ğŸ’</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
canvas{display:block;margin:0 auto}
</style>
</head>
<body>
<canvas id="gc"></canvas>
<script>
'use strict';
// ============================================================
//  GEM CASCADE ğŸ’ â€” Cluster Clearing + Cascade Chain Puzzle
// ============================================================

/* â”€â”€â”€ i18n â”€â”€â”€ */
const LANG=(()=>{const b=(navigator.language||'en').toLowerCase();
if(b.startsWith('ko'))return'ko';if(b.startsWith('ja'))return'ja';
if(b.startsWith('zh'))return'zh';return'en'})();
const T={
en:{title:'GEM CASCADE',start:'â–¶  INFINITE MODE',best:'BEST',score:'Score',chain:'Chain',wave:'Wave',
gameOver:'GAME OVER',finalScore:'Final Score',bestChain:'Best Chain',waveReached:'Wave Reached',
newBest:'ğŸ† NEW BEST!',restart:'â–¶  PLAY AGAIN',home:'ğŸ   HOME',
cascade:'CASCADE',huge:'HUGE!',mega:'MEGA!!',ultra:'ULTRA!!!',
tapHint:'Tap clusters of 2+ same gems',waveCleared:'WAVE CLEAR!',noMoves:'SHUFFLE!'},
ko:{title:'ì ¬ ìºìŠ¤ì¼€ì´ë“œ',start:'â–¶  ë¬´í•œ ëª¨ë“œ ì‹œì‘',best:'ìµœê³ ì ìˆ˜',score:'ì ìˆ˜',chain:'ì²´ì¸',wave:'ì›¨ì´ë¸Œ',
gameOver:'ê²Œì„ ì˜¤ë²„',finalScore:'ìµœì¢… ì ìˆ˜',bestChain:'ìµœëŒ€ ì²´ì¸',waveReached:'ë„ë‹¬ ì›¨ì´ë¸Œ',
newBest:'ğŸ† ì‹ ê¸°ë¡!',restart:'â–¶  ë‹¤ì‹œí•˜ê¸°',home:'ğŸ   í™ˆ',
cascade:'ìºìŠ¤ì¼€ì´ë“œ',huge:'ëŒ€ë°•!',mega:'ë©”ê°€!!',ultra:'ìš¸íŠ¸ë¼!!!',
tapHint:'ê°™ì€ ìƒ‰ ë³´ì„ 2ê°œ ì´ìƒ íƒ­!',waveCleared:'ì›¨ì´ë¸Œ í´ë¦¬ì–´!',noMoves:'ì…”í”Œ!'},
ja:{title:'ã‚¸ã‚§ãƒ ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰',start:'â–¶  ç„¡é™ãƒ¢ãƒ¼ãƒ‰',best:'ãƒ™ã‚¹ãƒˆ',score:'ã‚¹ã‚³ã‚¢',chain:'ãƒã‚§ãƒ¼ãƒ³',wave:'ã‚¦ã‚§ãƒ¼ãƒ–',
gameOver:'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼',finalScore:'æœ€çµ‚ã‚¹ã‚³ã‚¢',bestChain:'æœ€å¤§ãƒã‚§ãƒ¼ãƒ³',waveReached:'åˆ°é”ã‚¦ã‚§ãƒ¼ãƒ–',
newBest:'ğŸ† æ–°è¨˜éŒ²ï¼',restart:'â–¶  ã‚‚ã†ä¸€åº¦',home:'ğŸ   ãƒ›ãƒ¼ãƒ ',
cascade:'ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰',huge:'ã™ã”ã„ï¼',mega:'ãƒ¡ã‚¬!!',ultra:'ã‚¦ãƒ«ãƒˆãƒ©!!!',
tapHint:'åŒè‰²2å€‹ä»¥ä¸Šã‚¿ãƒƒãƒ—ï¼',waveCleared:'ã‚¦ã‚§ãƒ¼ãƒ–ã‚¯ãƒªã‚¢ï¼',noMoves:'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼'},
zh:{title:'å®çŸ³è¿é”',start:'â–¶  æ— é™æ¨¡å¼',best:'æœ€é«˜åˆ†',score:'åˆ†æ•°',chain:'è¿é”',wave:'æ³¢æ¬¡',
gameOver:'æ¸¸æˆç»“æŸ',finalScore:'æœ€ç»ˆåˆ†æ•°',bestChain:'æœ€å¤§è¿é”',waveReached:'åˆ°è¾¾æ³¢æ¬¡',
newBest:'ğŸ† æ–°çºªå½•ï¼',restart:'â–¶  å†æ¥ä¸€æ¬¡',home:'ğŸ   ä¸»é¡µ',
cascade:'è¿é”',huge:'å‰å®³ï¼',mega:'è¶…çº§!!',ultra:'ç©¶æ!!!',
tapHint:'ç‚¹å‡»2ä¸ªä»¥ä¸ŠåŒè‰²å®çŸ³ï¼',waveCleared:'æ³¢æ¬¡é€šè¿‡ï¼',noMoves:'æ´—ç‰Œï¼'}
};
const t=T[LANG];

/* â”€â”€â”€ Balance â”€â”€â”€ */
const B={COLS:8,ROWS:10,NUM_COLORS:5,MAX_COLORS:6,MIN_CLUSTER:2,
BOMB_TH:7,RAINBOW_TH:10,LINE_TH:13,
FALL_SPEED:0.16,POP_MS:280,CASCADE_MS:220,
WAVE_TARGET:5000,WAVE_ROWS:1,
SCORE_BASE:10,CASCADE_MULT:0.5};

/* â”€â”€â”€ Colors â”€â”€â”€ */
const COLORS=[
{name:'ruby',    f:'#e63946',g:'#ff6b6b',d:'#9b1d25'},
{name:'sapphire',f:'#457b9d',g:'#6bb5e0',d:'#1d3557'},
{name:'emerald', f:'#2a9d8f',g:'#52e0c4',d:'#155e54'},
{name:'topaz',   f:'#e9c46a',g:'#fff3b0',d:'#c89520'},
{name:'amethyst',f:'#9b5de5',g:'#c89bff',d:'#5c2d91'},
{name:'diamond', f:'#d0d0d0',g:'#ffffff',d:'#808080'}
];
const SP={NORM:0,BOMB:1,RAIN:2,LINE:3};

/* â”€â”€â”€ Canvas â”€â”€â”€ */
const cvs=document.getElementById('gc');
const ctx=cvs.getContext('2d');
let W,H,CELL,GX,GY,GW,GH,UI_H;
let dpr=Math.min(window.devicePixelRatio||1,3);

function resize(){
  W=window.innerWidth;H=window.innerHeight;
  dpr=Math.min(window.devicePixelRatio||1,3);
  cvs.width=W*dpr;cvs.height=H*dpr;
  cvs.style.width=W+'px';cvs.style.height=H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  UI_H=Math.min(68,H*0.09);
  const aH=H-UI_H-16,aW=W-16;
  CELL=Math.floor(Math.min(aW/B.COLS,aH/B.ROWS));
  CELL=Math.min(CELL,60);
  GW=CELL*B.COLS;GH=CELL*B.ROWS;
  GX=Math.floor((W-GW)/2);
  GY=UI_H+Math.floor((H-UI_H-GH)/2);
}
resize();window.addEventListener('resize',resize);

/* â”€â”€â”€ State â”€â”€â”€ */
let phase='menu';// menu|play|cascade|over
let grid=[],score=0,best=0,wave=1,chain=0,maxChain=0;
let waveTarget=B.WAVE_TARGET,waveScore=0,numColors=B.NUM_COLORS;
let particles=[],popups=[],banners=[];
let hoverCells=[];
let shakeAmt=0,bgPulse=0,menuT=0,overT=0,waveClearT=0;
let lastTime=0;

try{best=parseInt(localStorage.getItem('gemCascadeBest'))||0}catch(e){}
function saveBest(){try{localStorage.setItem('gemCascadeBest',best)}catch(e){}}

/* â”€â”€â”€ Gem â”€â”€â”€ */
function mkGem(c,r,ci,sp){
  return{c,r,x:GX+c*CELL+CELL/2,y:GY+r*CELL+CELL/2,
  ty:GY+r*CELL+CELL/2,ci:ci??Math.floor(Math.random()*numColors),
  sp:sp||SP.NORM,sc:1,al:1,fall:false,rm:false,rmT:0,
  bounce:0,spawn:1,ph:Math.random()*6.28};
}

/* â”€â”€â”€ Grid init â”€â”€â”€ */
function initGrid(){
  grid=[];
  for(let c=0;c<B.COLS;c++){grid[c]=[];
    for(let r=0;r<B.ROWS;r++){
      const g=mkGem(c,r);
      g.y=GY+r*CELL+CELL/2-GH-Math.random()*300;
      g.spawn=0;grid[c][r]=g;
    }
  }
}
function gem(c,r){
  if(c<0||c>=B.COLS||r<0||r>=B.ROWS)return null;
  return grid[c]?grid[c][r]:null;
}

/* â”€â”€â”€ BFS cluster â”€â”€â”€ */
function bfs(col,row){
  const g0=gem(col,row);if(!g0||g0.rm)return[];
  const ci=g0.ci,vis=new Set(),cl=[];
  const q=[[col,row]];vis.add(col*100+row);
  while(q.length){
    const[c,r]=q.shift();const g=gem(c,r);
    if(!g||g.rm||g.ci!==ci)continue;
    cl.push(g);
    for(const[dc,dr]of[[0,-1],[0,1],[-1,0],[1,0]]){
      const nc=c+dc,nr=r+dr,k=nc*100+nr;
      if(!vis.has(k)&&nc>=0&&nc<B.COLS&&nr>=0&&nr<B.ROWS){
        vis.add(k);
        const ng=gem(nc,nr);
        if(ng&&!ng.rm&&ng.ci===ci)q.push([nc,nr]);
      }
    }
  }
  return cl.length>=B.MIN_CLUSTER?cl:[];
}

/* â”€â”€â”€ Find all clusters â”€â”€â”€ */
function allClusters(){
  const vis=new Set(),out=[];
  for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
    const k=c*100+r;if(vis.has(k))continue;
    const g=gem(c,r);if(!g||g.rm){vis.add(k);continue;}
    const cl=bfs(c,r);
    if(cl.length>=B.MIN_CLUSTER){cl.forEach(x=>vis.add(x.c*100+x.r));out.push(cl);}
    else vis.add(k);
  }
  return out;
}

/* â”€â”€â”€ Spawn particles â”€â”€â”€ */
function spawnParts(x,y,color,n,spd){
  for(let i=0;i<n;i++){
    const a=Math.random()*6.28,s=1+Math.random()*(spd||4);
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2,
      color:Math.random()>0.4?color:'#fff',
      life:0.4+Math.random()*0.5,sz:2+Math.random()*4});
  }
}

/* â”€â”€â”€ Remove cluster â”€â”€â”€ */
function removeCluster(cl){
  if(!cl.length)return;
  const n=cl.length;
  const cb=1+chain*B.CASCADE_MULT;
  const pts=Math.floor(n*n*B.SCORE_BASE*cb);
  score+=pts;waveScore+=pts;

  let cx=0,cy=0;cl.forEach(g=>{cx+=g.x;cy+=g.y});
  cx/=n;cy/=n;

  popups.push({x:cx,y:cy,text:'+'+pts.toLocaleString(),
    life:1,color:COLORS[cl[0].ci].g,sz:n>6?24:18});

  cl.forEach(g=>{
    spawnParts(g.x,g.y,COLORS[g.ci].f,6,4);
    g.rm=true;g.rmT=1;
  });

  if(n>=5)shakeAmt=Math.min(8,n*0.8);
  if(n>=10)bgPulse=1;

  // Special gem
  let sp=null;
  if(n>=B.LINE_TH)sp=SP.LINE;
  else if(n>=B.RAINBOW_TH)sp=SP.RAIN;
  else if(n>=B.BOMB_TH)sp=SP.BOMB;

  if(sp!==null){
    const mid=cl[Math.floor(cl.length/2)];
    mid.rm=false;mid.rmT=0;mid.sp=sp;mid.sc=0.1;mid.spawn=0;
    spawnParts(mid.x,mid.y,'#fff',15,5);
  }
}

/* â”€â”€â”€ Activate special â”€â”€â”€ */
function activateSpecial(g){
  const affected=[];
  if(g.sp===SP.BOMB){
    for(let dc=-1;dc<=1;dc++)for(let dr=-1;dr<=1;dr++){
      const t=gem(g.c+dc,g.r+dr);if(t&&!t.rm)affected.push(t);
    }
    shakeAmt=10;
    popups.push({x:g.x,y:g.y,text:'ğŸ’£ BOOM!',life:1.2,color:'#fff',sz:24});
  }else if(g.sp===SP.RAIN){
    const ci=g.ci;
    for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
      const t=gem(c,r);if(t&&!t.rm&&t.ci===ci)affected.push(t);
    }
    bgPulse=1;shakeAmt=12;
    popups.push({x:g.x,y:g.y,text:'ğŸŒˆ RAINBOW!',life:1.2,color:'#fff',sz:24});
  }else if(g.sp===SP.LINE){
    for(let c=0;c<B.COLS;c++){const t=gem(c,g.r);if(t&&!t.rm)affected.push(t);}
    for(let r=0;r<B.ROWS;r++){const t=gem(g.c,r);if(t&&!t.rm&&t.r!==g.r)affected.push(t);}
    shakeAmt=15;bgPulse=1;
    popups.push({x:g.x,y:g.y,text:'âš¡ LINE!',life:1.2,color:'#fff',sz:24});
  }

  const cb=1+chain*B.CASCADE_MULT;
  const pts=Math.floor(affected.length*affected.length*B.SCORE_BASE*cb);
  score+=pts;waveScore+=pts;

  const chainSpecials=[];
  affected.forEach(t=>{
    spawnParts(t.x,t.y,COLORS[t.ci].f,8,5);
    if(t.sp!==SP.NORM&&t!==g){chainSpecials.push(t);}
    t.rm=true;t.rmT=1;
  });
  // Chain specials (delayed)
  chainSpecials.forEach((s,i)=>{
    setTimeout(()=>{if(s.rm){s.rm=false;activateSpecial(s);s.rm=true;s.rmT=1;}},100*(i+1));
  });
}

/* â”€â”€â”€ Gravity â”€â”€â”€ */
function applyGravity(){
  let moved=false;
  for(let c=0;c<B.COLS;c++){
    let wr=B.ROWS-1;
    for(let r=B.ROWS-1;r>=0;r--){
      const g=grid[c][r];
      if(g&&!g.rm){
        if(r!==wr){
          grid[c][wr]=g;grid[c][r]=null;
          g.r=wr;g.ty=GY+wr*CELL+CELL/2;
          g.fall=true;moved=true;
        }
        wr--;
      }
    }
    // Fill empty from top
    for(let r=wr;r>=0;r--){
      const ng=mkGem(c,r);
      ng.y=GY-(wr-r+1)*CELL-CELL/2;
      ng.ty=GY+r*CELL+CELL/2;
      ng.fall=true;ng.spawn=0;
      grid[c][r]=ng;moved=true;
    }
  }
  return moved;
}

/* â”€â”€â”€ Wave â”€â”€â”€ */
function checkWave(){
  if(waveScore>=waveTarget){
    wave++;waveScore=0;
    waveTarget=Math.floor(B.WAVE_TARGET*(1+(wave-1)*0.3));
    if(wave>=15)numColors=B.MAX_COLORS;
    waveClearT=1.5;
    banners.push({text:t.waveCleared+' '+(wave-1),life:1.5,color:'#ffd700',sz:30});
    addNewRows(B.WAVE_ROWS);
  }
}

function addNewRows(count){
  // Check if top rows occupied â†’ game over
  for(let c=0;c<B.COLS;c++){
    for(let r=0;r<count;r++){
      const g=gem(c,r);
      if(g&&!g.rm){endGame();return;}
    }
  }
  // Shift everything up by count
  for(let c=0;c<B.COLS;c++){
    for(let r=0;r<B.ROWS-count;r++){
      grid[c][r]=grid[c][r+count];
      if(grid[c][r]){
        grid[c][r].r=r;
        grid[c][r].ty=GY+r*CELL+CELL/2;
        grid[c][r].fall=true;
      }
    }
    for(let r=B.ROWS-count;r<B.ROWS;r++){
      const ng=mkGem(c,r);
      ng.y=GY+(B.ROWS+1)*CELL+CELL/2;
      ng.spawn=0;grid[c][r]=ng;
    }
  }
}

function endGame(){
  phase='over';overT=0;
  maxChain=Math.max(maxChain,chain);
  if(score>best){best=score;saveBest();}
}

/* â”€â”€â”€ Shuffle â”€â”€â”€ */
function shuffle(){
  const vals=[];
  for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
    const g=gem(c,r);if(g&&!g.rm)vals.push(g.ci);
  }
  for(let i=vals.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [vals[i],vals[j]]=[vals[j],vals[i]];
  }
  let idx=0;
  for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
    const g=gem(c,r);if(g&&!g.rm){g.ci=vals[idx++];g.spawn=0;}
  }
  banners.push({text:t.noMoves,life:1,color:'#88ddff',sz:26});
  // Ensure at least one cluster exists
  if(!allClusters().length){
    for(let c=0;c<B.COLS-1;c+=2){
      const g1=gem(c,B.ROWS-1),g2=gem(c+1,B.ROWS-1);
      if(g1&&g2)g2.ci=g1.ci;
    }
  }
}

/* â”€â”€â”€ Input â”€â”€â”€ */
function onTap(px,py){
  if(phase==='menu'){
    const bw=Math.min(280,W*0.7),bh=56;
    const bx=W/2-bw/2,by=H/2-10;
    if(px>=bx&&px<=bx+bw&&py>=by&&py<=by+bh)startGame();
    return;
  }
  if(phase==='over'){
    const bw=Math.min(280,W*0.7),bh=50,cx=W/2;
    const ry=H/2+80,hy=H/2+140;
    if(px>=cx-bw/2&&px<=cx+bw/2){
      if(py>=ry&&py<=ry+bh){startGame();return;}
      if(py>=hy&&py<=hy+bh){phase='menu';return;}
    }
    return;
  }
  if(phase!=='play')return;

  const gc=Math.floor((px-GX)/CELL),gr=Math.floor((py-GY)/CELL);
  if(gc<0||gc>=B.COLS||gr<0||gr>=B.ROWS)return;
  const g=gem(gc,gr);if(!g||g.rm||g.fall)return;

  if(g.sp!==SP.NORM){
    chain=0;activateSpecial(g);g.sp=SP.NORM;g.rm=true;g.rmT=1;
    phase='cascade';return;
  }
  const cl=bfs(gc,gr);
  if(cl.length<B.MIN_CLUSTER)return;
  chain=0;removeCluster(cl);phase='cascade';
}

function onHover(px,py){
  if(phase!=='play'){hoverCells=[];return;}
  const gc=Math.floor((px-GX)/CELL),gr=Math.floor((py-GY)/CELL);
  if(gc<0||gc>=B.COLS||gr<0||gr>=B.ROWS){hoverCells=[];return;}
  const g=gem(gc,gr);if(!g||g.rm){hoverCells=[];return;}
  if(g.sp!==SP.NORM){hoverCells=[g];return;}
  hoverCells=bfs(gc,gr);
}

cvs.addEventListener('pointerdown',e=>{e.preventDefault();
  const r=cvs.getBoundingClientRect();onTap(e.clientX-r.left,e.clientY-r.top);});
cvs.addEventListener('pointermove',e=>{
  const r=cvs.getBoundingClientRect();onHover(e.clientX-r.left,e.clientY-r.top);});

function startGame(){
  phase='play';score=0;wave=1;waveScore=0;chain=0;maxChain=0;
  waveTarget=B.WAVE_TARGET;numColors=B.NUM_COLORS;
  particles=[];popups=[];banners=[];hoverCells=[];
  overT=0;waveClearT=0;
  initGrid();
}

/* â”€â”€â”€ Easing â”€â”€â”€ */
function easeOutBack(x){const c1=1.70158,c3=c1+1;return 1+c3*Math.pow(x-1,3)+c1*Math.pow(x-1,2);}
function easeOutCubic(x){return 1-Math.pow(1-x,3);}

/* â”€â”€â”€ Update â”€â”€â”€ */
function update(dt){
  menuT+=dt;
  if(shakeAmt>0){shakeAmt*=Math.pow(0.88,dt*60);if(shakeAmt<0.1)shakeAmt=0;}
  if(bgPulse>0)bgPulse*=Math.pow(0.95,dt*60);
  if(waveClearT>0)waveClearT-=dt;

  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx*dt*60;p.y+=p.vy*dt*60;p.vy+=0.15*dt*60;
    p.life-=dt;p.sz*=Math.pow(0.97,dt*60);
    if(p.life<=0||p.sz<0.3)particles.splice(i,1);
  }
  // Popups
  for(let i=popups.length-1;i>=0;i--){
    popups[i].y-=1.2*dt*60;popups[i].life-=dt*0.8;
    if(popups[i].life<=0)popups.splice(i,1);
  }
  // Banners
  for(let i=banners.length-1;i>=0;i--){
    banners[i].life-=dt*0.7;
    if(banners[i].life<=0)banners.splice(i,1);
  }

  if(phase==='over'){
    overT=Math.min(1,overT+dt*2);
    updateGems(dt);return;
  }
  if(phase==='menu')return;

  updateGems(dt);

  if(phase==='cascade'){
    // 1) Finish remove animations
    let anyRm=false;
    for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
      const g=grid[c][r];if(!g||!g.rm)continue;
      g.rmT-=dt*3.5;g.sc=Math.max(0,g.rmT);g.al=Math.max(0,g.rmT);
      if(g.rmT<=0)grid[c][r]=null;else anyRm=true;
    }
    if(anyRm)return;

    // 2) Gravity
    applyGravity();

    // 3) Wait for fall
    let anyFall=false;
    for(let c=0;c<B.COLS&&!anyFall;c++)
      for(let r=0;r<B.ROWS&&!anyFall;r++){
        const g=gem(c,r);if(g&&g.fall)anyFall=true;
      }
    if(anyFall)return;

    // 4) Check new clusters (cascade)
    const cls=allClusters();
    if(cls.length){
      chain++;maxChain=Math.max(maxChain,chain);
      let txt=t.cascade+' x'+chain,col='#ffdd00',sz=24;
      if(chain>=8){txt=t.ultra+' x'+chain;col='#ff0044';sz=36;}
      else if(chain>=5){txt=t.mega+' x'+chain;col='#ff6600';sz=30;}
      else if(chain>=3){txt=t.huge+' x'+chain;col='#ffaa00';sz=27;}
      banners.push({text:txt,life:1.2,color:col,sz});
      bgPulse=Math.min(1,0.3+chain*0.1);
      cls.forEach(cl=>removeCluster(cl));
    }else{
      chain=0;phase='play';
      checkWave();
      if(!allClusters().length)shuffle();
    }
  }
}

function updateGems(dt){
  for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
    const g=grid[c][r];if(!g||g.rm)continue;
    g.x=GX+g.c*CELL+CELL/2;
    g.ty=GY+g.r*CELL+CELL/2;
    if(g.fall){
      const diff=g.ty-g.y;
      if(Math.abs(diff)<1){g.y=g.ty;g.fall=false;g.bounce=-2.5;}
      else g.y+=diff*B.FALL_SPEED*dt*60;
    }else{
      if(Math.abs(g.bounce)>0.1)g.bounce*=Math.pow(0.85,dt*60);else g.bounce=0;
    }
    if(g.spawn<1){g.spawn=Math.min(1,g.spawn+dt*3.5);g.sc=easeOutBack(g.spawn);}
    else g.sc=1;
    g.al=1;
  }
}

/* â”€â”€â”€ Draw â”€â”€â”€ */
const stars=Array.from({length:60},()=>({
  x:Math.random(),y:Math.random(),sz:0.5+Math.random()*1.5,
  sp:0.0001+Math.random()*0.0003,ph:Math.random()*6.28}));

function draw(now){
  const bgR=10+bgPulse*30|0,bgG=10+bgPulse*5|0,bgB=26+bgPulse*10|0;
  ctx.fillStyle=`rgb(${bgR},${bgG},${bgB})`;
  ctx.fillRect(0,0,W,H);

  // Stars
  const st=now*0.001;
  stars.forEach(s=>{
    const a=0.2+0.3*Math.sin(st*2+s.ph);
    ctx.fillStyle=`rgba(255,255,255,${a})`;
    ctx.fillRect(s.x*W,(s.y+st*s.sp)%1*H,s.sz,s.sz);
  });

  if(phase==='menu'){drawMenu(now);return;}

  ctx.save();
  if(shakeAmt>0)ctx.translate((Math.random()-.5)*shakeAmt*2,(Math.random()-.5)*shakeAmt*2);

  drawUI();drawGridBG();drawGems(now);drawHover(now);drawParts();drawPopups();
  ctx.restore();
  drawBanners();
  if(waveClearT>0){ctx.fillStyle=`rgba(255,215,0,${waveClearT*0.07})`;ctx.fillRect(0,0,W,H);}
  if(phase==='over')drawOver();
}

function drawMenu(now){
  const ts=Math.min(48,W*0.1);
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.shadowColor='#6bb5e0';ctx.shadowBlur=20;
  ctx.fillStyle='#fff';
  ctx.font=`bold ${ts}px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText('ğŸ’ '+t.title,W/2,H*0.25);
  ctx.shadowBlur=0;

  ctx.font=`14px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillStyle=`rgba(255,255,255,${0.5+0.2*Math.sin(menuT*3)})`;
  ctx.fillText(t.tapHint,W/2,H*0.34);

  // Orbiting gems
  const time=now*0.001;
  const sz=Math.min(32,W*0.07);
  for(let i=0;i<6;i++){
    const a=time*0.3+i*Math.PI/3;
    const rad=Math.min(90,W*0.18);
    drawGemIcon(W/2+Math.cos(a)*rad,H*0.25+Math.sin(a)*rad*0.5,
      sz*0.5,COLORS[i],SP.NORM,0.5+0.3*Math.sin(time+i));
  }

  // Start button
  const bw=Math.min(280,W*0.7),bh=56;
  const bx=W/2-bw/2,by=H/2-10;
  const gr=ctx.createLinearGradient(bx,by,bx+bw,by+bh);
  gr.addColorStop(0,'#e63946');gr.addColorStop(1,'#9b5de5');
  ctx.fillStyle=gr;rr(ctx,bx,by,bw,bh,12);ctx.fill();
  ctx.fillStyle='#fff';
  ctx.font=`bold 20px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(t.start,W/2,by+bh/2);

  if(best>0){
    ctx.fillStyle='#ffd700';
    ctx.font=`bold 22px 'Segoe UI',system-ui,sans-serif`;
    ctx.fillText('ğŸ† '+t.best+': '+best.toLocaleString(),W/2,H*0.72);
  }

  ctx.fillStyle='rgba(255,255,255,0.2)';
  ctx.font=`11px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText('v1.0 â€” East Sea Games',W/2,H-20);
}

function drawUI(){
  const gr=ctx.createLinearGradient(0,0,0,UI_H);
  gr.addColorStop(0,'rgba(15,15,35,0.95)');gr.addColorStop(1,'rgba(15,15,35,0.7)');
  ctx.fillStyle=gr;ctx.fillRect(0,0,W,UI_H);
  ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,UI_H);ctx.lineTo(W,UI_H);ctx.stroke();

  const y=UI_H/2,lx=12,rx=W-12;

  // Score
  ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.font=`11px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(t.score,lx,y-12);
  ctx.fillStyle='#fff';
  ctx.font=`bold 18px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(score.toLocaleString(),lx,y+10);

  // Wave center
  ctx.textAlign='center';
  ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.font=`11px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(t.wave,W/2,y-12);
  ctx.fillStyle='#ffd700';
  ctx.font=`bold 18px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(wave.toString(),W/2,y+6);

  // Wave progress
  const bw=70,bh=4,bx=W/2-bw/2,by2=y+20;
  ctx.fillStyle='rgba(255,255,255,0.15)';rr(ctx,bx,by2,bw,bh,2);ctx.fill();
  const pr=Math.min(1,waveScore/waveTarget);
  if(pr>0){
    const pg=ctx.createLinearGradient(bx,0,bx+bw*pr,0);
    pg.addColorStop(0,'#e63946');pg.addColorStop(1,'#ffd700');
    ctx.fillStyle=pg;rr(ctx,bx,by2,bw*pr,bh,2);ctx.fill();
  }

  // Chain right
  ctx.textAlign='right';
  ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.font=`11px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(t.chain,rx,y-12);
  ctx.fillStyle=chain>=5?'#ff4444':chain>=3?'#ffaa00':'#fff';
  ctx.font=`bold 18px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText('x'+chain,rx,y+10);
}

function drawGridBG(){
  ctx.strokeStyle='rgba(100,150,255,0.12)';ctx.lineWidth=2;
  rr(ctx,GX-3,GY-3,GW+6,GH+6,8);ctx.stroke();
  for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
    ctx.fillStyle=(c+r)%2===0?'rgba(255,255,255,0.025)':'rgba(0,0,0,0.04)';
    ctx.fillRect(GX+c*CELL,GY+r*CELL,CELL,CELL);
  }
  // Danger zone
  const da=0.08+0.04*Math.sin(Date.now()*0.003);
  ctx.fillStyle=`rgba(255,0,0,${da})`;
  ctx.fillRect(GX,GY,GW,CELL);
}

function drawGems(now){
  const time=(now||0)*0.002;
  for(let c=0;c<B.COLS;c++)for(let r=0;r<B.ROWS;r++){
    const g=grid[c][r];if(!g||(g.rm&&g.rmT<=0))continue;
    const col=COLORS[g.ci];
    const sc=g.sc*(1+g.bounce*0.03);
    const sz=(CELL-6)*0.5*sc;
    drawGemIcon(g.x,g.y+g.bounce,sz,col,g.sp,g.al,time);
  }
}

function drawGemIcon(x,y,size,col,sp,al,time){
  ctx.save();ctx.globalAlpha=al;ctx.translate(x,y);
  time=time||Date.now()*0.002;

  if(sp===SP.BOMB){
    const g=ctx.createRadialGradient(0,-size*0.2,0,0,0,size);
    g.addColorStop(0,'#ff6644');g.addColorStop(0.5,'#cc2200');g.addColorStop(1,'#660000');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,size,0,6.28);ctx.fill();
    ctx.fillStyle='#ffff00';ctx.beginPath();
    ctx.arc(size*0.5,-size*0.5,2.5+Math.sin(time*5)*2,0,6.28);ctx.fill();
    ctx.fillStyle='#fff';ctx.font=`bold ${size*0.9}px sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ğŸ’£',0,1);
  }else if(sp===SP.RAIN){
    const h=(time*50)%360;
    const g=ctx.createRadialGradient(0,-size*0.3,size*0.1,0,0,size);
    g.addColorStop(0,`hsl(${h},100%,80%)`);g.addColorStop(0.5,`hsl(${(h+120)%360},100%,60%)`);
    g.addColorStop(1,`hsl(${(h+240)%360},100%,40%)`);
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,size,0,6.28);ctx.fill();
    ctx.fillStyle='#fff';ctx.font=`bold ${size*0.8}px sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ğŸŒˆ',0,1);
  }else if(sp===SP.LINE){
    const g=ctx.createRadialGradient(0,-size*0.2,0,0,0,size);
    g.addColorStop(0,'#fff8a0');g.addColorStop(0.5,'#ffcc00');g.addColorStop(1,'#ff8800');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,size,0,6.28);ctx.fill();
    ctx.fillStyle='#fff';ctx.font=`bold ${size*0.9}px sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('âš¡',0,1);
  }else{
    // Normal gem â€” faceted diamond
    ctx.shadowColor=col.g;ctx.shadowBlur=6;
    const gr=ctx.createRadialGradient(-size*0.25,-size*0.25,0,0,0,size);
    gr.addColorStop(0,col.g);gr.addColorStop(0.6,col.f);gr.addColorStop(1,col.d);
    ctx.fillStyle=gr;
    ctx.beginPath();
    ctx.moveTo(0,-size);
    ctx.lineTo(size*0.85,-size*0.15);
    ctx.lineTo(size*0.55,size*0.8);
    ctx.lineTo(0,size);
    ctx.lineTo(-size*0.55,size*0.8);
    ctx.lineTo(-size*0.85,-size*0.15);
    ctx.closePath();ctx.fill();
    ctx.shadowBlur=0;

    // Inner facet
    ctx.fillStyle='rgba(255,255,255,0.15)';
    ctx.beginPath();
    ctx.moveTo(0,-size*0.7);ctx.lineTo(size*0.5,-size*0.1);
    ctx.lineTo(0,size*0.3);ctx.lineTo(-size*0.5,-size*0.1);
    ctx.closePath();ctx.fill();

    // Shine
    ctx.fillStyle=`rgba(255,255,255,${0.35+0.1*Math.sin(time+x+y)})`;
    ctx.beginPath();
    ctx.ellipse(-size*0.2,-size*0.35,size*0.2,size*0.12,-0.4,0,6.28);
    ctx.fill();

    // Border
    ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=0.8;
    ctx.beginPath();
    ctx.moveTo(0,-size);
    ctx.lineTo(size*0.85,-size*0.15);
    ctx.lineTo(size*0.55,size*0.8);
    ctx.lineTo(0,size);
    ctx.lineTo(-size*0.55,size*0.8);
    ctx.lineTo(-size*0.85,-size*0.15);
    ctx.closePath();ctx.stroke();
  }
  ctx.restore();
}

function drawHover(now){
  if(!hoverCells.length)return;
  const pulse=0.7+0.3*Math.sin((now||0)*0.004);
  hoverCells.forEach(g=>{
    if(g.rm)return;
    ctx.strokeStyle=`rgba(255,255,255,${pulse*0.6})`;ctx.lineWidth=2;
    const x=GX+g.c*CELL+2,y=GY+g.r*CELL+2;
    rr(ctx,x,y,CELL-4,CELL-4,6);ctx.stroke();
    ctx.fillStyle=`rgba(255,255,255,${pulse*0.08})`;
    rr(ctx,x,y,CELL-4,CELL-4,6);ctx.fill();
  });
  if(hoverCells.length>=B.MIN_CLUSTER){
    const cx=hoverCells.reduce((s,g)=>s+GX+g.c*CELL+CELL/2,0)/hoverCells.length;
    const cy=hoverCells.reduce((s,g)=>s+GY+g.r*CELL+CELL/2,0)/hoverCells.length;
    ctx.fillStyle=`rgba(255,255,255,${pulse})`;
    ctx.font=`bold 15px 'Segoe UI',system-ui,sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(hoverCells.length.toString(),cx,cy-CELL*0.6);
  }
}

function drawParts(){
  particles.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.life);ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,6.28);ctx.fill();
  });ctx.globalAlpha=1;
}
function drawPopups(){
  popups.forEach(f=>{
    ctx.globalAlpha=Math.max(0,f.life);ctx.fillStyle=f.color;
    ctx.font=`bold ${f.sz}px 'Segoe UI',system-ui,sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='rgba(0,0,0,0.5)';ctx.shadowBlur=4;
    ctx.fillText(f.text,f.x,f.y);ctx.shadowBlur=0;
  });ctx.globalAlpha=1;
}
function drawBanners(){
  banners.forEach(b=>{
    const a=Math.min(1,b.life*2);
    const sc=1+(1-Math.min(1,b.life*3))*0.3;
    ctx.save();ctx.globalAlpha=a;
    ctx.translate(W/2,GY+GH/2);ctx.scale(sc,sc);
    ctx.fillStyle=b.color;
    ctx.font=`bold ${b.sz}px 'Segoe UI',system-ui,sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='rgba(0,0,0,0.7)';ctx.shadowBlur=8;
    ctx.fillText(b.text,0,0);ctx.shadowBlur=0;
    ctx.restore();
  });
}

function drawOver(){
  const a=easeOutCubic(overT);
  ctx.fillStyle=`rgba(0,0,0,${a*0.75})`;ctx.fillRect(0,0,W,H);
  ctx.save();ctx.translate(0,(1-a)*50);
  const cy=H/2-60,isNew=score>=best&&score>0;

  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillStyle='#fff';
  ctx.font=`bold 30px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText('ğŸ’ '+t.gameOver+' ğŸ’',W/2,cy-60);

  if(isNew){ctx.fillStyle='#ffd700';
    ctx.font=`bold 20px 'Segoe UI',system-ui,sans-serif`;
    ctx.fillText(t.newBest,W/2,cy-28);}

  const stats=[[t.finalScore,score.toLocaleString()],
    [t.bestChain,'x'+maxChain],[t.waveReached,wave.toString()]];
  stats.forEach(([l,v],i)=>{
    const sy=cy+10+i*36;
    ctx.fillStyle='rgba(255,255,255,0.6)';
    ctx.font=`14px 'Segoe UI',system-ui,sans-serif`;
    ctx.textAlign='right';ctx.fillText(l,W/2-10,sy);
    ctx.fillStyle='#fff';
    ctx.font=`bold 18px 'Segoe UI',system-ui,sans-serif`;
    ctx.textAlign='left';ctx.fillText(v,W/2+10,sy);
  });

  const bw=Math.min(280,W*0.7),bh=50;

  // Restart
  const ry=cy+140;
  const rg=ctx.createLinearGradient(W/2-bw/2,ry,W/2+bw/2,ry+bh);
  rg.addColorStop(0,'#e63946');rg.addColorStop(1,'#9b5de5');
  ctx.fillStyle=rg;rr(ctx,W/2-bw/2,ry,bw,bh,10);ctx.fill();
  ctx.fillStyle='#fff';ctx.font=`bold 18px 'Segoe UI',system-ui,sans-serif`;
  ctx.textAlign='center';ctx.fillText(t.restart,W/2,ry+bh/2);

  // Home
  const hy=ry+60;
  ctx.fillStyle='rgba(255,255,255,0.15)';rr(ctx,W/2-bw/2,hy,bw,bh,10);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1;
  rr(ctx,W/2-bw/2,hy,bw,bh,10);ctx.stroke();
  ctx.fillStyle='#fff';ctx.font=`bold 18px 'Segoe UI',system-ui,sans-serif`;
  ctx.fillText(t.home,W/2,hy+bh/2);
  ctx.restore();
}

/* â”€â”€â”€ Utility â”€â”€â”€ */
function rr(c,x,y,w,h,r){
  c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.arcTo(x+w,y,x+w,y+r,r);
  c.lineTo(x+w,y+h-r);c.arcTo(x+w,y+h,x+w-r,y+h,r);c.lineTo(x+r,y+h);
  c.arcTo(x,y+h,x,y+h-r,r);c.lineTo(x,y+r);c.arcTo(x,y,x+r,y,r);c.closePath();
}

/* â”€â”€â”€ Main loop â”€â”€â”€ */
function loop(now){
  const dt=Math.min(0.05,lastTime?((now-lastTime)/1000):0.016);
  lastTime=now;
  update(dt);draw(now);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
