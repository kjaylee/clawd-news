<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>ğŸ’£ Minesweeper â€” East Sea Games</title>
<meta name="description" content="Classic Minesweeper with neon visuals! Three difficulty levels, touch-friendly. Play free in your browser or Telegram.">
<link rel="canonical" href="https://eastsea.monster/games/minesweeper/">
<meta property="og:title" content="ğŸ’£ Minesweeper â€” East Sea Games">
<meta property="og:description" content="Classic Minesweeper with modern neon visuals! Easy, Medium, Hard modes. Touch-friendly.">
<meta property="og:image" content="https://eastsea.monster/games/minesweeper/og.png">
<meta property="og:url" content="https://eastsea.monster/games/minesweeper/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="manifest" href="/games/manifest.json">
<meta name="theme-color" content="#0a0a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* â•â•â• tg-sdk-wrapper (inline) â•â•â• */
(function(){'use strict';const TG={app:window.Telegram?.WebApp,user:null,isReady:false,_backHandlers:[],init(){if(!this.app){this.isReady=true;this._injectStandaloneCSS();return false}this.app.ready();this.app.expand();this.user=this.app.initDataUnsafe?.user||null;this._applyTheme();this._setupSafeArea();this._setupBackButton();this.app.onEvent('viewportChanged',({isStateStable})=>{if(isStateStable)this._updateViewport()});this.app.onEvent('themeChanged',()=>this._applyTheme());this.isReady=true;return true},_applyTheme(){const tp=this.app?.themeParams;if(!tp)return;const r=document.documentElement.style;const m={'--tg-bg':tp.bg_color,'--tg-text':tp.text_color,'--tg-hint':tp.hint_color,'--tg-link':tp.link_color,'--tg-button':tp.button_color,'--tg-button-text':tp.button_text_color,'--tg-secondary-bg':tp.secondary_bg_color,'--tg-header-bg':tp.header_bg_color};for(const[p,v]of Object.entries(m)){if(v)r.setProperty(p,v)}},_setupSafeArea(){this._applySafeAreaValues();if(this.app?.onEvent){this.app.onEvent('safeAreaChanged',()=>this._applySafeAreaValues());this.app.onEvent('contentSafeAreaChanged',()=>this._applySafeAreaValues())}this._updateViewport()},_applySafeAreaValues(){const r=document.documentElement.style;const sa=this.app?.safeAreaInset||{top:0,bottom:0,left:0,right:0};const csa=this.app?.contentSafeAreaInset||{top:0,bottom:0,left:0,right:0};const totalTop=sa.top+csa.top;const totalBottom=sa.bottom+csa.bottom;r.setProperty('--safe-top',`${totalTop}px`);r.setProperty('--safe-bottom',`${totalBottom}px`);r.setProperty('--safe-left',`${sa.left}px`);r.setProperty('--safe-right',`${sa.right}px`);document.body.style.paddingTop=`${totalTop}px`;document.body.style.paddingBottom=`${totalBottom}px`;document.body.style.boxSizing='border-box'},_updateViewport(){const vh=this.app?.viewportStableHeight||window.innerHeight;document.documentElement.style.setProperty('--tg-viewport-height',`${vh}px`)},_setupBackButton(){if(!this.app?.BackButton)return;this.app.BackButton.show();this.app.BackButton.onClick(()=>{for(let i=this._backHandlers.length-1;i>=0;i--){if(this._backHandlers[i]())return}this.app.close()})},_injectStandaloneCSS(){const r=document.documentElement.style;r.setProperty('--tg-bg','#0a0a1a');r.setProperty('--tg-text','#ffffff');r.setProperty('--tg-hint','#999');r.setProperty('--tg-button','#3390ec');r.setProperty('--tg-button-text','#fff');r.setProperty('--tg-secondary-bg','#12122a');r.setProperty('--tg-viewport-height',`${window.innerHeight}px`);r.setProperty('--safe-top','0px');r.setProperty('--safe-bottom','0px')},getUserId(){return this.user?.id||'anonymous'},getUserName(){return this.user?.first_name||'Player'},getLang(){return this.user?.language_code||'en'},isPremium(){return!!this.user?.is_premium},isTelegram(){return!!this.app},save(k,v){try{localStorage.setItem(`tg_${this.getUserId()}_${k}`,JSON.stringify(v))}catch(e){}},load(k,fb=null){try{const r=localStorage.getItem(`tg_${this.getUserId()}_${k}`);return r?JSON.parse(r):fb}catch{return fb}},onBack(h){this._backHandlers.push(h)},haptic(t='impact',s='medium'){if(!this.app?.HapticFeedback)return;try{switch(t){case'impact':this.app.HapticFeedback.impactOccurred(s);break;case'notification':this.app.HapticFeedback.notificationOccurred(s);break;case'selection':this.app.HapticFeedback.selectionChanged();break}}catch{}},shareScore(score,gameName,gameId){const text=`ğŸ’£ ${gameName}: ${score}!\nCan you beat my time? ğŸ‘‡`;const url=`https://t.me/eastsea_games_bot?startapp=game_${gameId}`;if(this.app){this.app.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`)}},popup(title,message,buttons){return new Promise(r=>{if(this.app?.showPopup)this.app.showPopup({title,message,buttons},r);else{alert(`${title}\n${message}`);r('ok')}})},alert(m){return new Promise(r=>{if(this.app?.showAlert)this.app.showAlert(m,r);else{alert(m);r()}})}};const GameScore={save(gid,sc){const k=`score_${gid}`;const best=this.getBest(gid);const isNew=sc>best;if(isNew)TG.save(`${k}_best`,sc);const h=TG.load(`${k}_history`,[]);h.unshift({score:sc,date:Date.now()});if(h.length>20)h.pop();TG.save(`${k}_history`,h);TG.save(`${k}_plays`,(TG.load(`${k}_plays`,0)+1));return{isNewBest:isNew,bestScore:isNew?sc:best}},getBest(gid){return TG.load(`score_${gid}_best`,0)},getPlays(gid){return TG.load(`score_${gid}_plays`,0)}};window.TG=TG;window.GameScore=GameScore;function autoInit(){TG.init()}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',autoInit);else autoInit()})();
</script>
<style>
/* â•â•â• i18n inline â•â•â• */
:root {
  --tg-bg: #0a0a1a;
  --tg-text: #fff;
  --tg-hint: #999;
  --tg-button: #3390ec;
  --tg-button-text: #fff;
  --tg-secondary-bg: #12122a;
  --tg-viewport-height: 100vh;
  --safe-top: 0px;
  --safe-bottom: 0px;
  --neon-blue: #00d4ff;
  --neon-pink: #ff006e;
  --neon-green: #00ff88;
  --neon-yellow: #ffd700;
  --neon-purple: #b44aff;
  --neon-orange: #ff8c00;
  --neon-cyan: #00ffe5;
  --neon-red: #ff3355;
  --glass-bg: rgba(255,255,255,0.04);
  --glass-border: rgba(255,255,255,0.08);
  --glass-bg-hover: rgba(255,255,255,0.08);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  width:100%;height:100%;overflow:hidden;
  background:var(--tg-bg);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  color:var(--tg-text);
  touch-action:none;user-select:none;-webkit-user-select:none;
}
body{
  display:flex;flex-direction:column;align-items:center;
  min-height:var(--tg-viewport-height);
}

/* â•â•â• HUD â•â•â• */
#hud{
  display:flex;justify-content:space-between;align-items:center;
  width:100%;max-width:600px;
  padding:8px 12px;
  position:relative;z-index:10;
  flex-shrink:0;
}
.hud-box{
  display:flex;align-items:center;gap:6px;
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:12px;
  padding:6px 14px;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  min-width:72px;
  justify-content:center;
}
.hud-icon{font-size:18px}
.hud-val{
  font-size:18px;font-weight:800;font-variant-numeric:tabular-nums;
  min-width:30px;text-align:center;
}
#mineCount{color:var(--neon-red)}
#timer{color:var(--neon-cyan)}
#faceBtn{
  font-size:28px;cursor:pointer;
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:14px;
  padding:4px 14px;
  transition:transform .15s;
  line-height:1.2;
}
#faceBtn:active{transform:scale(.9)}

/* â•â•â• Difficulty bar â•â•â• */
#diffBar{
  display:flex;gap:6px;margin-bottom:6px;flex-shrink:0;
}
.diff-btn{
  padding:6px 16px;
  border-radius:10px;
  border:1px solid var(--glass-border);
  background:var(--glass-bg);
  color:var(--tg-hint);
  font-size:13px;font-weight:600;
  cursor:pointer;
  transition:all .2s;
}
.diff-btn.active{
  background:linear-gradient(135deg,var(--neon-blue),var(--neon-purple));
  color:#fff;
  border-color:transparent;
  box-shadow:0 0 12px rgba(0,212,255,.3);
}
.diff-btn:active{transform:scale(.95)}

/* â•â•â• Grid â•â•â• */
#gridWrap{
  flex:1;
  display:flex;align-items:center;justify-content:center;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  width:100%;
  padding:4px;
}
#grid{
  display:inline-grid;
  gap:2px;
  background:rgba(255,255,255,.02);
  border-radius:12px;
  padding:4px;
  border:1px solid var(--glass-border);
  box-shadow:0 0 30px rgba(0,212,255,.06), inset 0 0 30px rgba(0,0,0,.3);
}
.cell{
  width:var(--cell-size,30px);height:var(--cell-size,30px);
  border-radius:5px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;
  font-size:calc(var(--cell-size,30px) * 0.5);
  cursor:pointer;
  transition:background .12s, transform .1s, box-shadow .12s;
  position:relative;
  line-height:1;
}
.cell.closed{
  background:linear-gradient(145deg,rgba(255,255,255,.07),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.06);
  box-shadow:0 1px 4px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.05);
}
.cell.closed:hover{
  background:rgba(255,255,255,.1);
  box-shadow:0 0 8px rgba(0,212,255,.15);
}
.cell.closed:active{
  transform:scale(.92);
}
.cell.open{
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.03);
  cursor:default;
}
.cell.open.mine-hit{
  background:rgba(255,0,60,.25);
  box-shadow:0 0 20px rgba(255,0,60,.4);
}
.cell.flagged::after{
  content:'ğŸš©';
  font-size:calc(var(--cell-size,30px) * 0.5);
}
.cell.question::after{
  content:'â“';
  font-size:calc(var(--cell-size,30px) * 0.45);
}
/* number colors â€” neon */
.cell.n1{color:#4ea8ff}
.cell.n2{color:var(--neon-green)}
.cell.n3{color:var(--neon-red)}
.cell.n4{color:var(--neon-purple)}
.cell.n5{color:var(--neon-orange)}
.cell.n6{color:var(--neon-cyan)}
.cell.n7{color:#fff}
.cell.n8{color:var(--tg-hint)}

/* mine reveal animation */
.cell.revealed-mine{
  animation:mineReveal .3s ease-out;
}
@keyframes mineReveal{
  0%{transform:scale(0);opacity:0}
  60%{transform:scale(1.2)}
  100%{transform:scale(1);opacity:1}
}

/* â•â•â• Overlay â•â•â• */
#overlay{
  position:fixed;inset:0;z-index:100;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(5,5,20,.88);
  backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  transition:opacity .3s;
  padding:20px;
}
#overlay.hidden{opacity:0;pointer-events:none}
.ov-title{
  font-size:clamp(1.8rem,5vw,3rem);font-weight:900;
  background:linear-gradient(135deg,var(--neon-blue),var(--neon-purple),var(--neon-pink));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  margin-bottom:4px;text-align:center;
}
.ov-sub{color:var(--tg-hint);font-size:.95rem;margin-bottom:24px;text-align:center}
.ov-result{
  text-align:center;
  margin-bottom:20px;
}
.ov-big{font-size:2.4rem;font-weight:800;margin-bottom:2px}
.ov-label{color:var(--tg-hint);font-size:.85rem;text-transform:uppercase;letter-spacing:1.5px}
.ov-stats{
  display:flex;gap:20px;margin-bottom:18px;flex-wrap:wrap;justify-content:center;
}
.ov-stat{text-align:center}
.ov-stat-val{font-size:1.4rem;font-weight:700;color:var(--neon-cyan)}
.ov-stat-lbl{font-size:.7rem;color:var(--tg-hint);text-transform:uppercase;letter-spacing:1px}
.ov-newbest{
  color:var(--neon-yellow);font-weight:700;font-size:1.1rem;
  animation:pulse 1s infinite;margin-bottom:12px;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.btn{
  padding:14px 36px;font-size:1.05rem;font-weight:700;
  border:none;border-radius:14px;cursor:pointer;
  background:linear-gradient(135deg,var(--neon-blue),var(--neon-purple));
  color:#fff;
  transition:transform .15s, box-shadow .15s;
  margin:5px;min-width:140px;
}
.btn:hover{box-shadow:0 0 20px rgba(0,212,255,.3)}
.btn:active{transform:scale(.95)}
.btn-secondary{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  color:var(--tg-hint);
}
.ov-hint{
  color:#555;font-size:.75rem;margin-top:14px;text-align:center;line-height:1.6;
}

/* â•â•â• Mode toggle (flag/dig) for mobile â•â•â• */
#modeToggle{
  display:none; /* shown on touch */
  position:fixed;
  bottom:calc(16px + var(--safe-bottom, 0px));
  right:16px;
  z-index:50;
  width:56px;height:56px;
  border-radius:50%;
  border:2px solid var(--glass-border);
  background:var(--glass-bg);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  font-size:24px;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 20px rgba(0,0,0,.4);
  transition:all .2s;
}
#modeToggle.flag-mode{
  background:rgba(255,0,60,.2);
  border-color:var(--neon-red);
  box-shadow:0 0 16px rgba(255,0,60,.3);
}

/* â•â•â• Win sparkle â•â•â• */
@keyframes sparkle{
  0%{transform:translateY(0) scale(1);opacity:1}
  100%{transform:translateY(-60px) scale(0);opacity:0}
}
.sparkle{
  position:fixed;pointer-events:none;z-index:200;
  font-size:24px;
  animation:sparkle 1s ease-out forwards;
}

/* responsive */
@media(max-width:420px){
  #hud{padding:4px 8px}
  .hud-box{padding:4px 10px;min-width:62px;border-radius:10px}
  .hud-icon{font-size:15px}
  .hud-val{font-size:16px;min-width:26px}
  #faceBtn{font-size:24px;padding:3px 10px;border-radius:10px}
  .diff-btn{padding:5px 12px;font-size:12px}
}
</style>
</head>
<body>

<!-- Difficulty selector -->
<div id="diffBar">
  <button class="diff-btn active" data-diff="easy" id="btnEasy">Easy</button>
  <button class="diff-btn" data-diff="medium" id="btnMedium">Medium</button>
  <button class="diff-btn" data-diff="hard" id="btnHard">Hard</button>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-box">
    <span class="hud-icon">ğŸ’£</span>
    <span class="hud-val" id="mineCount">10</span>
  </div>
  <div id="faceBtn">ğŸ˜€</div>
  <div class="hud-box">
    <span class="hud-icon">â±</span>
    <span class="hud-val" id="timer">000</span>
  </div>
</div>

<!-- Grid -->
<div id="gridWrap">
  <div id="grid"></div>
</div>

<!-- Mobile flag/dig toggle -->
<button id="modeToggle" title="Toggle Flag Mode">â›ï¸</button>

<!-- Menu / Game Over overlay -->
<div id="overlay">
  <div class="ov-title">ğŸ’£ Minesweeper</div>
  <p class="ov-sub" id="ovSub">Find all the mines!</p>
  <button class="btn" id="btnStart">â–¶ Start</button>
  <p class="ov-hint" id="ovHint">
    ğŸ–±ï¸ Left click: Reveal Â· Right click: Flag<br>
    ğŸ“± Tap: Reveal Â· Long press or toggle ğŸš©: Flag
  </p>
</div>

<script src="/games/cross-promo.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ’£ MINESWEEPER â€” East Sea Games
   Single-file, glassmorphism/neon, mobile-first
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
'use strict';

/* â”€â”€â”€ i18n â”€â”€â”€ */
const LANG = (function(){
  try{
    const tl = window.Telegram?.WebApp?.initDataUnsafe?.user?.language_code;
    if(tl && tl.startsWith('ko')) return 'ko';
    if(tl) return 'en';
  }catch(e){}
  const nl = (navigator.language||'en').toLowerCase();
  return nl.startsWith('ko') ? 'ko' : 'en';
})();
document.documentElement.lang = LANG;

const STR = {
  easy:      {en:'Easy',ko:'ì‰¬ì›€'},
  medium:    {en:'Medium',ko:'ë³´í†µ'},
  hard:      {en:'Hard',ko:'ì–´ë ¤ì›€'},
  start:     {en:'â–¶ Start',ko:'â–¶ ì‹œì‘'},
  replay:    {en:'ğŸ”„ Replay',ko:'ğŸ”„ ë‹¤ì‹œí•˜ê¸°'},
  share:     {en:'ğŸ“¢ Share',ko:'ğŸ“¢ ê³µìœ '},
  title:     {en:'ğŸ’£ Minesweeper',ko:'ğŸ’£ ì§€ë¢°ì°¾ê¸°'},
  subtitle:  {en:'Find all the mines!',ko:'ì§€ë¢°ë¥¼ ëª¨ë‘ ì°¾ìœ¼ì„¸ìš”!'},
  hint:      {en:'ğŸ–±ï¸ Left click: Reveal Â· Right click: Flag\nğŸ“± Tap: Reveal Â· Long press or toggle ğŸš©: Flag',
              ko:'ğŸ–±ï¸ ì¢Œí´ë¦­: ì—´ê¸° Â· ìš°í´ë¦­: ê¹ƒë°œ\nğŸ“± íƒ­: ì—´ê¸° Â· ê¸¸ê²Œ ëˆ„ë¥´ê¸° ë˜ëŠ” ğŸš© í† ê¸€: ê¹ƒë°œ'},
  win:       {en:'ğŸ‰ You Win!',ko:'ğŸ‰ ìŠ¹ë¦¬!'},
  lose:      {en:'ğŸ’¥ Game Over',ko:'ğŸ’¥ ê²Œì„ ì˜¤ë²„'},
  time:      {en:'Time',ko:'ì‹œê°„'},
  best:      {en:'Best',ko:'ìµœê³ '},
  newbest:   {en:'ğŸ† New Best!',ko:'ğŸ† ìƒˆ ê¸°ë¡!'},
  mines:     {en:'Mines',ko:'ì§€ë¢°'},
  flagMode:  {en:'Flag Mode',ko:'ê¹ƒë°œ ëª¨ë“œ'},
  digMode:   {en:'Dig Mode',ko:'ë°œêµ´ ëª¨ë“œ'},
};
function T(k){ return (STR[k]&&STR[k][LANG]) || (STR[k]&&STR[k].en) || k; }

/* â”€â”€â”€ Apply i18n to static elements â”€â”€â”€ */
document.getElementById('btnEasy').textContent = T('easy');
document.getElementById('btnMedium').textContent = T('medium');
document.getElementById('btnHard').textContent = T('hard');
document.getElementById('btnStart').textContent = T('start');
document.getElementById('ovSub').textContent = T('subtitle');
document.getElementById('ovHint').innerHTML = T('hint').replace(/\n/g,'<br>');
document.querySelector('.ov-title').textContent = T('title');

/* â”€â”€â”€ Difficulty configs â”€â”€â”€ */
const DIFFS = {
  easy:   { cols:9,  rows:9,  mines:10 },
  medium: { cols:16, rows:16, mines:40 },
  hard:   { cols:30, rows:16, mines:99 },
};

/* â”€â”€â”€ Game State â”€â”€â”€ */
let diff = 'easy';
let cols, rows, mineCount;
let board = [];       // 2D: {mine,adjacent,revealed,flagged,question}
let firstClick = true;
let gameState = 'menu'; // menu, playing, won, lost
let timerVal = 0;
let timerInterval = null;
let flagsPlaced = 0;
let flagMode = false; // mobile toggle
let longPressTimer = null;
let longPressed = false;
let revealedCount = 0;

/* â”€â”€â”€ DOM refs â”€â”€â”€ */
const gridEl = document.getElementById('grid');
const mineCountEl = document.getElementById('mineCount');
const timerEl = document.getElementById('timer');
const faceBtn = document.getElementById('faceBtn');
const overlay = document.getElementById('overlay');
const modeToggle = document.getElementById('modeToggle');
const diffBtns = document.querySelectorAll('.diff-btn');

/* â”€â”€â”€ Detect touch â”€â”€â”€ */
const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
if(isTouch) {
  modeToggle.style.display = 'flex';
}

/* â•â•â• BOARD GENERATION â•â•â• */
function createBoard(){
  const cfg = DIFFS[diff];
  cols = cfg.cols; rows = cfg.rows; mineCount = cfg.mines;
  board = [];
  for(let r=0;r<rows;r++){
    board[r]=[];
    for(let c=0;c<cols;c++){
      board[r][c]={mine:false,adjacent:0,revealed:false,flagged:false,question:false};
    }
  }
  firstClick=true;
  flagsPlaced=0;
  revealedCount=0;
  gameState='playing';
  timerVal=0;
  if(timerInterval)clearInterval(timerInterval);
  timerInterval=null;
  updateHUD();
}

function placeMines(safeR, safeC){
  /* first click safe zone: 3x3 around click */
  const forbidden = new Set();
  for(let dr=-1;dr<=1;dr++){
    for(let dc=-1;dc<=1;dc++){
      const rr=safeR+dr, cc=safeC+dc;
      if(rr>=0&&rr<rows&&cc>=0&&cc<cols) forbidden.add(rr*cols+cc);
    }
  }
  let placed=0;
  while(placed<mineCount){
    const r=Math.floor(Math.random()*rows);
    const c=Math.floor(Math.random()*cols);
    if(board[r][c].mine||forbidden.has(r*cols+c)) continue;
    board[r][c].mine=true;
    placed++;
  }
  /* calc adjacents */
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(board[r][c].mine) continue;
      let cnt=0;
      forNeighbors(r,c,(nr,nc)=>{if(board[nr][nc].mine)cnt++});
      board[r][c].adjacent=cnt;
    }
  }
}

function forNeighbors(r,c,fn){
  for(let dr=-1;dr<=1;dr++){
    for(let dc=-1;dc<=1;dc++){
      if(dr===0&&dc===0) continue;
      const nr=r+dr, nc=c+dc;
      if(nr>=0&&nr<rows&&nc>=0&&nc<cols) fn(nr,nc);
    }
  }
}

/* â•â•â• RENDER GRID â•â•â• */
function renderGrid(){
  gridEl.innerHTML='';
  /* Calculate cell size */
  const maxW = window.innerWidth - 16;
  const maxH = window.innerHeight - 120;
  const cellW = Math.floor((maxW - cols*2 - 8) / cols);
  const cellH = Math.floor((maxH - rows*2 - 8) / rows);
  let cellSize = Math.min(cellW, cellH, 40);
  cellSize = Math.max(cellSize, 18);
  document.documentElement.style.setProperty('--cell-size', cellSize+'px');
  gridEl.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;
  gridEl.style.gridTemplateRows = `repeat(${rows}, var(--cell-size))`;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell = document.createElement('div');
      cell.className = 'cell closed';
      cell.dataset.r = r;
      cell.dataset.c = c;

      /* Mouse events */
      cell.addEventListener('mousedown', (e)=>{
        if(gameState!=='playing') return;
        if(e.button===2) toggleFlag(r,c); // right click
      });
      cell.addEventListener('click', (e)=>{
        if(gameState!=='playing') return;
        if(longPressed){ longPressed=false; return; }
        if(flagMode) toggleFlag(r,c);
        else handleReveal(r,c);
      });
      cell.addEventListener('dblclick', (e)=>{
        if(gameState!=='playing') return;
        chordReveal(r,c);
      });
      cell.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        if(gameState!=='playing') return;
        toggleFlag(r,c);
      });

      /* Touch events â€” long press for flag */
      cell.addEventListener('touchstart', (e)=>{
        if(gameState!=='playing') return;
        longPressed=false;
        longPressTimer=setTimeout(()=>{
          longPressed=true;
          toggleFlag(r,c);
          TG.haptic('impact','medium');
        }, 400);
      }, {passive:true});
      cell.addEventListener('touchend', ()=>{
        if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null}
      }, {passive:true});
      cell.addEventListener('touchmove', ()=>{
        if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null}
      }, {passive:true});

      gridEl.appendChild(cell);
    }
  }
}

function updateCells(){
  const cells = gridEl.children;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell = cells[r*cols+c];
      const b = board[r][c];
      cell.className='cell';
      cell.textContent='';
      if(b.revealed){
        cell.classList.add('open');
        if(b.mine){
          cell.textContent='ğŸ’£';
          if(b.hit) cell.classList.add('mine-hit');
          cell.classList.add('revealed-mine');
        } else if(b.adjacent>0){
          cell.textContent=b.adjacent;
          cell.classList.add('n'+b.adjacent);
        }
      } else {
        cell.classList.add('closed');
        if(b.flagged) cell.classList.add('flagged');
        else if(b.question) cell.classList.add('question');
        /* wrong flag on game over */
        if(gameState==='lost' && b.flagged && !b.mine){
          cell.classList.remove('flagged');
          cell.classList.add('open');
          cell.textContent='âŒ';
        }
      }
    }
  }
}

/* â•â•â• GAME LOGIC â•â•â• */
function handleReveal(r,c){
  const b = board[r][c];
  if(b.revealed||b.flagged||b.question) return;

  /* First click: place mines, ensure safe */
  if(firstClick){
    placeMines(r,c);
    firstClick=false;
    startTimer();
  }

  if(b.mine){
    /* BOOM */
    b.revealed=true;
    b.hit=true;
    gameState='lost';
    revealAllMines();
    endGame(false);
    TG.haptic('notification','error');
    return;
  }

  /* Flood fill for 0-cells */
  revealCell(r,c);
  TG.haptic('impact','light');

  checkWin();
  updateCells();
  updateHUD();
}

function revealCell(r,c){
  const b=board[r][c];
  if(b.revealed||b.flagged||b.mine) return;
  b.revealed=true;
  revealedCount++;
  if(b.adjacent===0){
    forNeighbors(r,c,(nr,nc)=>revealCell(nr,nc));
  }
}

function chordReveal(r,c){
  const b=board[r][c];
  if(!b.revealed||b.adjacent===0) return;
  /* Count flags around */
  let flagCount=0;
  forNeighbors(r,c,(nr,nc)=>{if(board[nr][nc].flagged)flagCount++});
  if(flagCount!==b.adjacent) return;
  /* Reveal unflagged neighbors */
  let hitMine=false;
  forNeighbors(r,c,(nr,nc)=>{
    const nb=board[nr][nc];
    if(!nb.revealed&&!nb.flagged){
      if(nb.mine){
        nb.revealed=true; nb.hit=true; hitMine=true;
      } else {
        revealCell(nr,nc);
      }
    }
  });
  if(hitMine){
    gameState='lost';
    revealAllMines();
    endGame(false);
    TG.haptic('notification','error');
  } else {
    TG.haptic('impact','light');
    checkWin();
  }
  updateCells();
  updateHUD();
}

function toggleFlag(r,c){
  const b=board[r][c];
  if(b.revealed) return;
  if(firstClick) return; /* can't flag before first reveal */

  if(!b.flagged && !b.question){
    b.flagged=true;
    flagsPlaced++;
    TG.haptic('impact','medium');
  } else if(b.flagged){
    b.flagged=false;
    b.question=true;
    flagsPlaced--;
    TG.haptic('selection');
  } else {
    b.question=false;
    TG.haptic('selection');
  }
  updateCells();
  updateHUD();
}

function checkWin(){
  const totalCells = rows*cols;
  if(revealedCount === totalCells - mineCount){
    gameState='won';
    /* Auto-flag remaining mines */
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        if(board[r][c].mine&&!board[r][c].flagged){
          board[r][c].flagged=true;
          flagsPlaced++;
        }
      }
    }
    endGame(true);
    TG.haptic('notification','success');
  }
}

function revealAllMines(){
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(board[r][c].mine && !board[r][c].revealed){
        board[r][c].revealed=true;
      }
    }
  }
}

/* â•â•â• TIMER â•â•â• */
function startTimer(){
  if(timerInterval) return;
  timerVal=0;
  timerInterval=setInterval(()=>{
    timerVal++;
    if(timerVal>999) timerVal=999;
    timerEl.textContent=String(timerVal).padStart(3,'0');
  },1000);
}
function stopTimer(){
  if(timerInterval){clearInterval(timerInterval);timerInterval=null}
}

/* â•â•â• HUD â•â•â• */
function updateHUD(){
  mineCountEl.textContent = Math.max(0, mineCount-flagsPlaced);
  timerEl.textContent = String(timerVal).padStart(3,'0');
  if(gameState==='won') faceBtn.textContent='ğŸ˜';
  else if(gameState==='lost') faceBtn.textContent='ğŸ˜µ';
  else faceBtn.textContent='ğŸ˜€';
}

/* â•â•â• GAME END â•â•â• */
function endGame(won){
  stopTimer();
  updateCells();
  updateHUD();

  /* Save score (time-based for wins) */
  const scoreKey = `minesweeper-${diff}`;
  let bestTime = TG.load(`best_${scoreKey}`, null);
  let isNewBest = false;

  if(won){
    if(bestTime === null || timerVal < bestTime){
      bestTime = timerVal;
      isNewBest = true;
      TG.save(`best_${scoreKey}`, timerVal);
    }
    /* Sparkle effect */
    for(let i=0;i<12;i++){
      setTimeout(()=>spawnSparkle(), i*80);
    }
  }

  GameScore.save('minesweeper', won ? Math.max(1, 999 - timerVal) : 0);

  /* Show overlay after a delay */
  setTimeout(()=>{
    showResultOverlay(won, isNewBest, bestTime);
  }, won ? 600 : 1200);
}

function spawnSparkle(){
  const emojis=['âœ¨','ğŸ‰','â­','ğŸŒŸ','ğŸ’','ğŸŠ'];
  const el=document.createElement('div');
  el.className='sparkle';
  el.textContent=emojis[Math.floor(Math.random()*emojis.length)];
  el.style.left=Math.random()*window.innerWidth+'px';
  el.style.top=(Math.random()*window.innerHeight*0.6+window.innerHeight*0.2)+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

function showResultOverlay(won, isNewBest, bestTime){
  let html = '';
  if(won){
    html += `<div class="ov-title">${T('win')}</div>`;
    if(isNewBest) html += `<div class="ov-newbest">${T('newbest')}</div>`;
    html += `<div class="ov-result">
      <div class="ov-big" style="color:var(--neon-cyan)">${String(timerVal).padStart(3,'0')}s</div>
      <div class="ov-label">${T('time')}</div>
    </div>`;
    html += `<div class="ov-stats">
      <div class="ov-stat"><div class="ov-stat-val">${T(diff)}</div><div class="ov-stat-lbl">${LANG==='ko'?'ë‚œì´ë„':'Mode'}</div></div>
      <div class="ov-stat"><div class="ov-stat-val">${mineCount}</div><div class="ov-stat-lbl">${T('mines')}</div></div>
      ${bestTime!==null?`<div class="ov-stat"><div class="ov-stat-val">${bestTime}s</div><div class="ov-stat-lbl">${T('best')}</div></div>`:''}
    </div>`;
  } else {
    html += `<div class="ov-title">${T('lose')}</div>`;
    html += `<div class="ov-result">
      <div class="ov-big" style="color:var(--neon-red)">${String(timerVal).padStart(3,'0')}s</div>
      <div class="ov-label">${T('time')}</div>
    </div>`;
    html += `<div class="ov-stats">
      <div class="ov-stat"><div class="ov-stat-val">${T(diff)}</div><div class="ov-stat-lbl">${LANG==='ko'?'ë‚œì´ë„':'Mode'}</div></div>
      <div class="ov-stat"><div class="ov-stat-val">${revealedCount}</div><div class="ov-stat-lbl">${LANG==='ko'?'ì—´ë¦° ì¹¸':'Revealed'}</div></div>
    </div>`;
  }
  html += `<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
    <button class="btn" id="btnReplay">${T('replay')}</button>
    <button class="btn btn-secondary" id="btnShare">${T('share')}</button>
  </div>`;

  overlay.innerHTML = html;
  overlay.classList.remove('hidden');

  document.getElementById('btnReplay').addEventListener('click', ()=>{
    overlay.classList.add('hidden');
    newGame();
  });
  document.getElementById('btnShare').addEventListener('click', ()=>{
    const msg = won
      ? `ğŸ’£ ${T('title')} [${T(diff)}] â€” ${timerVal}s! ğŸ†`
      : `ğŸ’£ ${T('title')} [${T(diff)}] â€” ${LANG==='ko'?'ë‹¤ìŒì—” ê¼­!':'Next time!'}`;
    TG.shareScore(timerVal, 'Minesweeper', 'minesweeper');
  });
}

/* â•â•â• NEW GAME â•â•â• */
function newGame(){
  stopTimer();
  createBoard();
  renderGrid();
  updateCells();
  updateHUD();
  faceBtn.textContent='ğŸ˜€';
}

/* â•â•â• DIFFICULTY â•â•â• */
diffBtns.forEach(btn=>{
  btn.addEventListener('click',()=>{
    diffBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    diff=btn.dataset.diff;
    if(gameState!=='menu') newGame();
    TG.haptic('selection');
  });
});

/* â•â•â• FACE BUTTON â€” restart â•â•â• */
faceBtn.addEventListener('click',()=>{
  newGame();
  TG.haptic('impact','medium');
});

/* â•â•â• MODE TOGGLE (mobile) â•â•â• */
modeToggle.addEventListener('click',()=>{
  flagMode=!flagMode;
  modeToggle.textContent=flagMode?'ğŸš©':'â›ï¸';
  modeToggle.classList.toggle('flag-mode',flagMode);
  modeToggle.title=flagMode?T('flagMode'):T('digMode');
  TG.haptic('selection');
});

/* â•â•â• START â•â•â• */
document.getElementById('btnStart').addEventListener('click',()=>{
  overlay.classList.add('hidden');
  newGame();
  TG.haptic('impact','medium');
});

/* â•â•â• KEYBOARD (for desktop chord) â•â•â• */
document.addEventListener('keydown',(e)=>{
  if(e.key==='r'||e.key==='R'){
    newGame();
  }
});

/* â•â•â• Back button (Telegram) â•â•â• */
if(window.TG){
  TG.onBack(()=>{
    if(!overlay.classList.contains('hidden')){
      return false; // let TG close
    }
    overlay.classList.remove('hidden');
    showMenuOverlay();
    return true;
  });
}

function showMenuOverlay(){
  overlay.innerHTML=`
    <div class="ov-title">${T('title')}</div>
    <p class="ov-sub">${T('subtitle')}</p>
    <button class="btn" id="btnStart2">${T('start')}</button>
    <p class="ov-hint">${T('hint').replace(/\n/g,'<br>')}</p>
  `;
  document.getElementById('btnStart2').addEventListener('click',()=>{
    overlay.classList.add('hidden');
    newGame();
    TG.haptic('impact','medium');
  });
}

/* â•â•â• WINDOW RESIZE â•â•â• */
window.addEventListener('resize',()=>{
  if(gameState==='playing'||gameState==='won'||gameState==='lost'){
    renderGrid();
    updateCells();
  }
});

/* â•â•â• PREVENT ZOOM â•â•â• */
document.addEventListener('gesturestart',(e)=>e.preventDefault());
document.addEventListener('dblclick',(e)=>{
  if(e.target.classList.contains('cell')) e.preventDefault();
});

/* â•â•â• INIT â•â•â• */
createBoard();
renderGrid();
updateHUD();

})();
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": "Minesweeper",
  "url": "https://eastsea.monster/games/minesweeper/",
  "description": "Classic Minesweeper with modern neon visuals! Three difficulty levels (Easy, Medium, Hard), touch-friendly, first-click safety.",
  "image": "https://eastsea.monster/games/minesweeper/og.png",
  "gamePlatform": ["Web Browser","Mobile Browser"],
  "applicationCategory": "Game",
  "genre": "Puzzle",
  "operatingSystem": "Any",
  "inLanguage": ["ko","en"],
  "playMode": "SinglePlayer",
  "offers": {"@type":"Offer","price":"0","priceCurrency":"USD","availability":"https://schema.org/InStock"},
  "author": {"@type":"Person","name":"Jay Lee","url":"https://eastsea.monster"}
}
</script>
</body>
</html>
