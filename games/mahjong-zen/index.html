<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Mahjong Zen ğŸ‹</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1a2e;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;touch-action:none;user-select:none}
canvas{display:block}
#ui{position:absolute;top:0;left:0;width:100%;pointer-events:none}
#topBar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;color:#e8d5b7;font-size:15px;pointer-events:none}
#topBar .lv{font-weight:700;font-size:17px}
#topBar .stars{color:#c9a959;font-size:18px}
#bottomBar{position:absolute;bottom:0;left:0;width:100%;display:flex;justify-content:center;gap:16px;padding:14px;pointer-events:auto}
.btn{background:rgba(232,213,183,0.12);border:1px solid rgba(232,213,183,0.25);color:#e8d5b7;padding:10px 18px;border-radius:12px;font-size:14px;cursor:pointer;backdrop-filter:blur(4px);transition:all .2s}
.btn:active{transform:scale(0.95);background:rgba(232,213,183,0.25)}
.btn.disabled{opacity:0.3;pointer-events:none}
#score{position:absolute;bottom:70px;width:100%;text-align:center;color:#c9a959;font-size:14px;pointer-events:none}
#msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#e8d5b7;font-size:28px;font-weight:700;text-align:center;pointer-events:none;opacity:0;transition:opacity .5s;text-shadow:0 2px 20px rgba(233,69,96,0.5)}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10}
#overlay .title{color:#e8d5b7;font-size:32px;font-weight:700;margin-bottom:8px}
#overlay .sub{color:#c9a959;font-size:18px;margin-bottom:6px}
#overlay .quote{color:rgba(232,213,183,0.6);font-size:13px;font-style:italic;margin:16px 30px;text-align:center;line-height:1.5}
#overlay .play-btn{margin-top:20px;background:linear-gradient(135deg,#e94560,#c93050);color:#fff;border:none;padding:14px 40px;border-radius:16px;font-size:18px;font-weight:700;cursor:pointer;pointer-events:auto;transition:transform .2s}
#overlay .play-btn:active{transform:scale(0.95)}
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": "Mahjong Zen",
  "url": "https://eastsea.monster/games/mahjong-zen/",
  "description": "ì   í…Œë§ˆ ë§ˆì‘ ì†”ë¦¬í…Œì–´! 20+ ë ˆë²¨, 5ê°€ì§€ ë ˆì´ì•„ì›ƒ, ì½¤ë³´ ì‹œìŠ¤í…œ, íŒíŠ¸/ì…”í”Œ/ì‹¤í–‰ì·¨ì†Œ. ê³ ìš”í•œ íƒ€ì¼ ë§¤ì¹­ í¼ì¦.",
  "image": "https://eastsea.monster/games/mahjong-zen/og.png",
  "gamePlatform": [
    "Web Browser",
    "Mobile Browser"
  ],
  "applicationCategory": "Game",
  "genre": "Puzzle",
  "operatingSystem": "Any",
  "inLanguage": [
    "ko",
    "en"
  ],
  "playMode": "SinglePlayer",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock"
  },
  "author": {
    "@type": "Person",
    "name": "Jay Lee",
    "url": "https://eastsea.monster"
  }
}
</script>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <div id="topBar">
    <span class="lv" id="lvText">LV.1</span>
    <span id="timer">â± 0:00</span>
    <span class="stars" id="starsText">â˜†â˜†â˜†</span>
  </div>
  <div id="score">Score: <span id="scoreVal">0</span> &nbsp; Combo: <span id="comboVal">x1</span></div>
  <div id="bottomBar">
    <button class="btn" id="btnHint">ğŸ’¡ <span id="hintCount">3</span></button>
    <button class="btn" id="btnShuffle">ğŸ”„ <span id="shuffleCount">1</span></button>
    <button class="btn" id="btnUndo">â†©ï¸</button>
  </div>
</div>
<div id="msg"></div>
<div id="overlay">
  <div class="title" id="olTitle">Mahjong Zen</div>
  <div class="sub" id="olSub">ğŸ‹ Find peace in the tiles</div>
  <div class="quote" id="olQuote">"The journey of a thousand miles begins with a single step." â€” Lao Tzu</div>
  <button class="play-btn" id="olBtn">Play</button>
</div>
<script>
(()=>{
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H,DPR;
const SYMBOLS=['bamboo','coin','gem','flower','fire','wave'];
const SYM_COLORS=['#4a7c59','#c9a959','#5b8fb9','#c97b84','#d45d47','#4a90b5'];
const SYM_ICONS=['ğŸ‹','ğŸª™','ğŸ’','ğŸŒ¸','ğŸ”¥','ğŸŒŠ'];

const QUOTES=[
  '"ê³ ìš”í•œ ë¬¼ì´ ê¹Šì´ íë¥¸ë‹¤." â€” í•œêµ­ ì†ë‹´',
  '"ì²œë¦¬ê¸¸ë„ í•œ ê±¸ìŒë¶€í„°." â€” ë…¸ì',
  '"ë§ˆìŒì´ ê³ ìš”í•˜ë©´ ì„¸ìƒì´ ë³´ì¸ë‹¤."',
  '"ì¡°ê¸‰í•˜ì§€ ë§ˆë¼, ëª¨ë“  ê²ƒì—ëŠ” ë•Œê°€ ìˆë‹¤."',
  '"ë¹ˆ ë§ˆìŒì´ ê°€ì¥ ë„“ì€ ë§ˆìŒì´ë‹¤."',
  '"ë°”ëŒì´ ë©ˆì¶”ë©´ ë¬¼ì€ ìŠ¤ìŠ¤ë¡œ ë§‘ì•„ì§„ë‹¤."',
  '"ëŠë¦¬ê²Œ ê°€ëŠ” ê²ƒì„ ë‘ë ¤ì›Œ ë§ë¼."',
  '"í•˜ë‚˜ë¥¼ ë¹„ìš°ë©´ í•˜ë‚˜ë¥¼ ì±„ìš¸ ìˆ˜ ìˆë‹¤."',
];

// --- Layouts ---
function turtleLayout(rows,cols,layers){
  const pos=[];
  for(let z=0;z<layers;z++){
    const sr=z,sc=z;
    const er=rows-z,ec=cols-z;
    for(let r=sr;r<er;r++)for(let c=sc;c<ec;c++){
      if(z>0&&(r===sr||r===er-1||c===sc||c===ec-1))continue;
      pos.push({r,c,z});
    }
  }
  return pos;
}
function crossLayout(rows,cols){
  const pos=[],cx=Math.floor(cols/2),cy=Math.floor(rows/2);
  const arm=Math.min(3,Math.floor(rows/3));
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const dx=Math.abs(c-cx),dy=Math.abs(r-cy);
    if(dx<=1||dy<=1||(dx<=arm&&dy<=arm))
      pos.push({r,c,z:0});
  }
  // add layer on center
  for(let r=cy-1;r<=cy+1;r++)for(let c=cx-1;c<=cx+1;c++)pos.push({r,c,z:1});
  return pos;
}
function pyramidLayout(rows,cols,layers){
  const pos=[];
  for(let z=0;z<layers;z++){
    const w=cols-z*2,h=rows-z*2;
    if(w<1||h<1)break;
    for(let r=z;r<z+h;r++)for(let c=z;c<z+w;c++)pos.push({r,c,z});
  }
  return pos;
}

function genLayout(level){
  const diff=Math.min(level,20);
  if(diff<=5){
    const s=4+Math.floor(diff/2);
    return turtleLayout(s,s+2,Math.min(3,1+Math.floor(diff/2)));
  }else if(diff<=10){
    const s=5+Math.floor((diff-5)/3);
    return crossLayout(s,s+2);
  }else if(diff<=15){
    const s=5+Math.floor((diff-10)/3);
    return pyramidLayout(s,s+2,3);
  }else{
    const s=6+Math.floor((diff-15)/3);
    return turtleLayout(s,s+3,4);
  }
}

// --- Game State ---
let tiles=[],selected=null,score=0,combo=0,comboTimer=0;
let hints=3,shuffles=1,undoStack=[];
let level=1,timer=0,timerInterval=null,gameActive=false;
let particles=[],msgTimeout=null;
let hintPair=null,hintTimer=0;
let bgPhase=0;
const TW=48,TH=56,TZ=6,TGAP=2;

function resize(){
  DPR=window.devicePixelRatio||1;
  W=window.innerWidth;H=window.innerHeight;
  C.width=W*DPR;C.height=H*DPR;
  C.style.width=W+'px';C.style.height=H+'px';
  X.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize',resize);
resize();

// --- Tile Utils ---
function tileBounds(t){
  const boardW=tiles.reduce((m,t2)=>Math.max(m,t2.c),0)+1;
  const boardH=tiles.reduce((m,t2)=>Math.max(m,t2.r),0)+1;
  const totalW=boardW*(TW+TGAP);
  const totalH=boardH*(TH+TGAP);
  const ox=(W-totalW)/2;
  const oy=(H-totalH)/2+10;
  const x=ox+t.c*(TW+TGAP)-t.z*TZ;
  const y=oy+t.r*(TH+TGAP)-t.z*TZ;
  return {x,y,w:TW,h:TH};
}

function isFree(t){
  if(t.removed)return false;
  // Check if blocked on top
  const hasAbove=tiles.some(o=>!o.removed&&o.z===t.z+1&&
    Math.abs(o.r-t.r)<1&&Math.abs(o.c-t.c)<1&&o!==t);
  if(hasAbove)return false;
  // Check left or right is free
  const hasLeft=tiles.some(o=>!o.removed&&o.z===t.z&&o.r===t.r&&o.c===t.c-1);
  const hasRight=tiles.some(o=>!o.removed&&o.z===t.z&&o.r===t.r&&o.c===t.c+1);
  return !hasLeft||!hasRight;
}

function findMatches(){
  const free=tiles.filter(t=>!t.removed&&isFree(t));
  const pairs=[];
  for(let i=0;i<free.length;i++)
    for(let j=i+1;j<free.length;j++)
      if(free[i].sym===free[j].sym)pairs.push([free[i],free[j]]);
  return pairs;
}

// --- Solvable generation ---
function generateTiles(level){
  const layout=genLayout(level);
  // Make even number
  let positions=[...layout];
  if(positions.length%2!==0)positions.pop();
  
  const numSyms=Math.min(SYMBOLS.length,3+Math.floor(level/3));
  const numPairs=positions.length/2;
  
  // Create symbol pairs
  const syms=[];
  for(let i=0;i<numPairs;i++)syms.push(i%numSyms,i%numSyms);
  
  // Shuffle symbols
  for(let i=syms.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [syms[i],syms[j]]=[syms[j],syms[i]];
  }
  
  // Assign to positions (shuffle positions too for variety)
  for(let i=positions.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [positions[i],positions[j]]=[positions[j],positions[i]];
  }
  
  return positions.map((p,i)=>({
    ...p,sym:syms[i],removed:false,id:i,
    scale:1,alpha:1,glow:0
  }));
}

// --- Drawing ---
function drawTile(t){
  if(t.removed&&t.alpha<=0)return;
  const b=tileBounds(t);
  const x=b.x,y=b.y;
  const s=t.scale||1;
  const a=t.alpha!=null?t.alpha:1;
  
  X.save();
  X.globalAlpha=a;
  X.translate(x+TW/2,y+TH/2);
  X.scale(s,s);
  X.translate(-TW/2,-TH/2);
  
  const free=!t.removed&&isFree(t);
  const isSel=selected===t;
  const isHint=hintPair&&(hintPair[0]===t||hintPair[1]===t);
  
  // Shadow
  X.fillStyle='rgba(0,0,0,0.3)';
  roundRect(X,3,4,TW,TH,6);X.fill();
  
  // Side (3D effect)
  X.fillStyle=free?'#c9a959':'#8a7a5a';
  roundRect(X,0,3,TW,TH,6);X.fill();
  
  // Face
  const faceColor=isSel?'#fff5e0':free?'#f0e6d2':'#c8bda8';
  X.fillStyle=faceColor;
  roundRect(X,0,0,TW,TH,6);X.fill();
  
  // Glow
  if(isSel||isHint){
    X.shadowColor=isSel?'#e94560':'#c9a959';
    X.shadowBlur=15;
    X.strokeStyle=isSel?'#e94560':'#c9a959';
    X.lineWidth=2;
    roundRect(X,0,0,TW,TH,6);X.stroke();
    X.shadowBlur=0;
  }
  
  // Not free overlay
  if(!free&&!t.removed){
    X.fillStyle='rgba(50,40,30,0.2)';
    roundRect(X,0,0,TW,TH,6);X.fill();
  }
  
  // Symbol
  const col=SYM_COLORS[t.sym%SYM_COLORS.length];
  X.fillStyle=col;
  X.font='24px serif';
  X.textAlign='center';X.textBaseline='middle';
  X.fillText(SYM_ICONS[t.sym%SYM_ICONS.length],TW/2,TH/2+1);
  
  X.restore();
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function drawBg(){
  bgPhase+=0.003;
  const g=X.createLinearGradient(0,0,W,H);
  const shift=Math.sin(bgPhase)*0.1;
  g.addColorStop(0,`hsl(${230+shift*20},40%,${12+shift*3}%)`);
  g.addColorStop(1,`hsl(${220+shift*15},50%,${16+shift*2}%)`);
  X.fillStyle=g;X.fillRect(0,0,W,H);
}

function drawParticles(){
  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life-=0.02;
    if(p.life<=0)return false;
    X.globalAlpha=p.life;
    X.fillStyle=p.color;
    X.beginPath();X.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);X.fill();
    X.globalAlpha=1;
    return true;
  });
}

function spawnParticles(x,y,color,n=12){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2;
    const sp=1+Math.random()*3;
    particles.push({
      x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,
      size:2+Math.random()*3,life:1,color
    });
  }
}

// --- Game Loop ---
function render(){
  drawBg();
  // Sort tiles: draw bottom layers first, then top
  const sorted=[...tiles].sort((a,b)=>a.z-b.z||(a.r-b.r)||(a.c-b.c));
  sorted.forEach(drawTile);
  drawParticles();
  
  // Animate removing tiles
  tiles.forEach(t=>{
    if(t.removed&&t.alpha>0){
      t.alpha-=0.08;
      t.scale+=0.03;
    }
  });
  
  // Hint flash
  if(hintPair){
    hintTimer++;
    if(hintTimer>90)hintPair=null;
  }
  
  // Combo decay
  if(combo>0){
    comboTimer++;
    if(comboTimer>120){combo=0;updateUI();}
  }
  
  requestAnimationFrame(render);
}

// --- Input ---
function handleClick(px,py){
  if(!gameActive)return;
  // Find clicked tile (top layer first)
  let clicked=null;
  const sorted=[...tiles].filter(t=>!t.removed).sort((a,b)=>b.z-a.z);
  for(const t of sorted){
    const b=tileBounds(t);
    if(px>=b.x&&px<=b.x+b.w&&py>=b.y&&py<=b.y+b.h){
      clicked=t;break;
    }
  }
  if(!clicked)return;
  if(!isFree(clicked))return;
  
  if(!selected){
    selected=clicked;
    hintPair=null;
  }else if(selected===clicked){
    selected=null;
  }else if(selected.sym===clicked.sym){
    // Match!
    matchTiles(selected,clicked);
    selected=null;
  }else{
    selected=clicked;
  }
}

function matchTiles(a,b){
  a.removed=true;b.removed=true;
  const ba=tileBounds(a),bb=tileBounds(b);
  const col=SYM_COLORS[a.sym%SYM_COLORS.length];
  spawnParticles(ba.x+TW/2,ba.y+TH/2,col);
  spawnParticles(bb.x+TW/2,bb.y+TH/2,col);
  
  combo++;comboTimer=0;
  const mult=Math.min(combo,5);
  const pts=20*mult;
  score+=pts;
  undoStack.push({a:{...a,removed:false,alpha:1,scale:1},b:{...b,removed:false,alpha:1,scale:1}});
  
  updateUI();
  
  // Check win
  const remaining=tiles.filter(t=>!t.removed);
  if(remaining.length===0){
    setTimeout(()=>winLevel(),500);
    return;
  }
  
  // Check if any matches remain
  const matches=findMatches();
  if(matches.length===0){
    showMsg('ë§¤ì¹­ ë¶ˆê°€! ì…”í”Œí•˜ì„¸ìš” ğŸ”„');
  }
}

C.addEventListener('click',e=>{
  const rect=C.getBoundingClientRect();
  handleClick(e.clientX-rect.left,e.clientY-rect.top);
});
C.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t=e.touches[0];
  const rect=C.getBoundingClientRect();
  handleClick(t.clientX-rect.left,t.clientY-rect.top);
},{passive:false});

// --- Buttons ---
document.getElementById('btnHint').onclick=()=>{
  if(hints<=0||!gameActive)return;
  const matches=findMatches();
  if(matches.length>0){
    hintPair=matches[Math.floor(Math.random()*matches.length)];
    hintTimer=0;
    hints--;
    updateUI();
  }else{
    showMsg('ë§¤ì¹­ ë¶ˆê°€!');
  }
};

document.getElementById('btnShuffle').onclick=()=>{
  if(shuffles<=0||!gameActive)return;
  const remaining=tiles.filter(t=>!t.removed);
  const syms=remaining.map(t=>t.sym);
  for(let i=syms.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [syms[i],syms[j]]=[syms[j],syms[i]];
  }
  remaining.forEach((t,i)=>t.sym=syms[i]);
  shuffles--;
  selected=null;hintPair=null;
  updateUI();
  showMsg('ì…”í”Œ ì™„ë£Œ! ğŸ”„');
};

document.getElementById('btnUndo').onclick=()=>{
  if(undoStack.length===0||!gameActive)return;
  const last=undoStack.pop();
  const a=tiles.find(t=>t.id===last.a.id);
  const b=tiles.find(t=>t.id===last.b.id);
  if(a){a.removed=false;a.alpha=1;a.scale=1;}
  if(b){b.removed=false;b.alpha=1;b.scale=1;}
  score=Math.max(0,score-20);
  combo=0;
  selected=null;
  updateUI();
};

// --- UI ---
function updateUI(){
  document.getElementById('scoreVal').textContent=score;
  document.getElementById('comboVal').textContent=combo>1?`x${combo}`:'x1';
  document.getElementById('hintCount').textContent=hints;
  document.getElementById('shuffleCount').textContent=shuffles;
  document.getElementById('lvText').textContent=`LV.${level}`;
  
  document.getElementById('btnHint').className=hints>0?'btn':'btn disabled';
  document.getElementById('btnShuffle').className=shuffles>0?'btn':'btn disabled';
  document.getElementById('btnUndo').className=undoStack.length>0?'btn':'btn disabled';
  
  const m=Math.floor(timer/60),s=timer%60;
  document.getElementById('timer').textContent=`â± ${m}:${s<10?'0':''}${s}`;
  
  // Stars preview
  const star3=60+level*10,star2=120+level*15;
  const stars=timer<=star3?'â˜…â˜…â˜…':timer<=star2?'â˜…â˜…â˜†':'â˜…â˜†â˜†';
  document.getElementById('starsText').textContent=stars;
}

function showMsg(text){
  const el=document.getElementById('msg');
  el.textContent=text;el.style.opacity=1;
  clearTimeout(msgTimeout);
  msgTimeout=setTimeout(()=>el.style.opacity=0,2000);
}

// --- Level Flow ---
function startLevel(lv){
  level=lv;
  tiles=generateTiles(level);
  selected=null;score=0;combo=0;comboTimer=0;
  hints=3;shuffles=1;undoStack=[];
  timer=0;hintPair=null;
  gameActive=true;
  
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(gameActive){timer++;updateUI();}
  },1000);
  
  updateUI();
  saveProgress();
}

function winLevel(){
  gameActive=false;
  clearInterval(timerInterval);
  
  const star3=60+level*10,star2=120+level*15;
  const stars=timer<=star3?3:timer<=star2?2:1;
  const starStr='â˜…'.repeat(stars)+'â˜†'.repeat(3-stars);
  
  // Celebration particles
  for(let i=0;i<5;i++){
    setTimeout(()=>{
      spawnParticles(W*Math.random(),H*0.3+Math.random()*H*0.4,
        ['#e94560','#c9a959','#5b8fb9','#4a7c59'][Math.floor(Math.random()*4)],20);
    },i*200);
  }
  
  const q=QUOTES[Math.floor(Math.random()*QUOTES.length)];
  
  setTimeout(()=>{
    showOverlay(`ë ˆë²¨ ${level} í´ë¦¬ì–´!`,`${starStr}  Score: ${score}`,q,'ë‹¤ìŒ ë ˆë²¨ â†’',()=>{
      startLevel(level+1);
    });
  },1500);
  
  // Save progress
  const saved=loadSave();
  saved.maxLevel=Math.max(saved.maxLevel||1,level+1);
  saved.totalScore=(saved.totalScore||0)+score;
  localStorage.setItem('mahjong-zen',JSON.stringify(saved));
}

function showOverlay(title,sub,quote,btnText,cb){
  const o=document.getElementById('overlay');
  document.getElementById('olTitle').textContent=title;
  document.getElementById('olSub').textContent=sub;
  document.getElementById('olQuote').textContent=quote;
  const btn=document.getElementById('olBtn');
  btn.textContent=btnText;
  btn.onclick=()=>{o.style.display='none';cb();};
  o.style.display='flex';
}

function loadSave(){
  try{return JSON.parse(localStorage.getItem('mahjong-zen'))||{};}
  catch{return{};}
}
function saveProgress(){
  const saved=loadSave();
  saved.currentLevel=level;
  localStorage.setItem('mahjong-zen',JSON.stringify(saved));
}

// --- Init ---
function init(){
  const saved=loadSave();
  const startLv=saved.maxLevel||1;
  
  showOverlay(
    'Mahjong Zen',
    `ğŸ‹ íƒ€ì¼ì˜ í‰í™”ë¥¼ ì°¾ìœ¼ì„¸ìš”`,
    QUOTES[Math.floor(Math.random()*QUOTES.length)],
    startLv>1?`ë ˆë²¨ ${startLv} ì‹œì‘`:'ì‹œì‘í•˜ê¸°',
    ()=>startLevel(startLv)
  );
  
  render();
}

init();
})();
</script>
<script src="../cross-promo.js"></script>
</body>
</html>
