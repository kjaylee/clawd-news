<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>Infinite Stack Climb</title>
<meta property="og:title" content="Infinite Stack Climb">
<meta property="og:type" content="website">
<meta property="og:url" content="https://eastsea.monster/games/infinite-stack-climb/">
<meta property="og:description" content="Play Infinite Stack Climb - Free HTML5 game. No download required!">
<meta property="og:image" content="https://eastsea.monster/games/infinite-stack-climb/og.png">
<meta property="og:site_name" content="East Sea Games">
<meta name="description" content="Play Infinite Stack Climb - Free HTML5 browser game. No download, no install.">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eastsea.monster/games/infinite-stack-climb/og.png">
<meta name="twitter:title" content="Infinite Stack Climb">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    #gameContainer {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 100vh;
      max-height: 700px;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 10px;
    }
    #ui {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      color: #fff;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      pointer-events: none;
      z-index: 10;
    }
    .stat-box {
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
      padding: 10px 15px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-size: 24px; margin-top: 2px; }
    #comboBox { 
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    #comboBox.show { opacity: 1; }
    #comboBox .stat-value { color: #ffd700; }
    #altitude {
      position: absolute;
      right: 15px;
      top: 70px;
      color: #fff;
      font-size: 12px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      opacity: 0.8;
    }
    #powerups {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      pointer-events: auto;
    }
    .powerup-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, opacity 0.2s, border-color 0.2s;
      position: relative;
    }
    .powerup-btn:hover { transform: scale(1.1); border-color: #fff; }
    .powerup-btn.disabled { opacity: 0.3; pointer-events: none; }
    .powerup-btn.active { border-color: #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.5); }
    .powerup-count {
      position: absolute;
      bottom: -5px;
      right: -5px;
      background: #ff6b6b;
      color: #fff;
      font-size: 10px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    #menu, #gameover {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.85);
      color: #fff;
      border-radius: 10px;
      z-index: 100;
    }
    #menu h1, #gameover h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }
    #menu h1 span { 
      background: linear-gradient(135deg, #ff6b6b, #ffd93d, #4ecdc4, #667eea);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    #menu p, #gameover p {
      font-size: 14px;
      margin-bottom: 20px;
      color: #888;
      text-align: center;
      padding: 0 20px;
    }
    .btn {
      padding: 15px 50px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      margin: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-play {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      box-shadow: 0 5px 20px rgba(102,126,234,0.5);
    }
    .btn-retry {
      background: linear-gradient(135deg, #ff6b6b, #ff4757);
      color: #fff;
      box-shadow: 0 5px 20px rgba(255,100,100,0.5);
    }
    #finalScore {
      font-size: 56px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    #finalHeight { font-size: 18px; color: #4ecdc4; margin-top: 5px; }
    #bestScore { font-size: 16px; color: #ffd700; margin-top: 8px; }
    #newBest { color: #ff6b6b; font-size: 14px; animation: pulse 0.5s infinite alternate; margin-top: 5px; }
    @keyframes pulse { from { opacity: 0.5; } to { opacity: 1; } }
    .hidden { display: none !important; }
    #perfectText {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 40px rgba(255,215,0,0.4);
      opacity: 0;
      pointer-events: none;
      z-index: 20;
    }
    #perfectText.show {
      animation: perfectPop 0.5s ease-out forwards;
    }
    @keyframes perfectPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-30px); }
    }
    .stats-row {
      display: flex;
      gap: 30px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .stats-row .stat { text-align: center; }
    .stats-row .stat-label { font-size: 11px; color: #888; }
    .stats-row .stat-value { font-size: 20px; margin-top: 3px; }
    #menuBest { color: #ffd700; font-size: 18px; }
    .how-to-play {
      margin-top: 25px;
      padding: 15px 25px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      font-size: 12px;
      color: #aaa;
      text-align: left;
      max-width: 280px;
    }
    .how-to-play h3 { color: #fff; margin-bottom: 8px; font-size: 13px; }
    .how-to-play ul { margin-left: 15px; line-height: 1.8; }
    .phase-indicator {
      position: absolute;
      top: 75px;
      left: 15px;
      font-size: 11px;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>
<script src="../i18n.js"></script>
    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/games/tg-sdk-wrapper.js?v=1769736738"></script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": "Infinite Stack Climb",
  "url": "https://eastsea.monster/games/infinite-stack-climb/",
  "description": "ÌïòÎäò ÎÅùÍπåÏßÄ ÏåìÏïÑ Ïò¨ÎùºÍ∞ÄÏÑ∏Ïöî! ÏôÑÎ≤Ω Ïä§ÌÉù ÏΩ§Î≥¥, Î∞∞Í≤Ω Ï†ÑÌôò(ÎÇÆ‚ÜíÏö∞Ï£º), ÌååÏõåÏóÖ ÏãúÏä§ÌÖú!",
  "image": "https://eastsea.monster/games/infinite-stack-climb/og.png",
  "gamePlatform": [
    "Web Browser",
    "Mobile Browser"
  ],
  "applicationCategory": "Game",
  "genre": "Arcade",
  "operatingSystem": "Any",
  "inLanguage": [
    "ko",
    "en"
  ],
  "playMode": "SinglePlayer",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock"
  },
  "author": {
    "@type": "Person",
    "name": "Jay Lee",
    "url": "https://eastsea.monster"
  }
}
</script>
</head>
<body>
  <div id="gameContainer">
    <canvas id="game"></canvas>
    
    <div id="ui">
      <div class="stat-box">
        <div class="stat-label">Score</div>
        <div class="stat-value" id="score">0</div>
      </div>
      <div class="stat-box" id="comboBox">
        <div class="stat-label">Combo</div>
        <div class="stat-value" id="combo">x1</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Best</div>
        <div class="stat-value" id="best">0</div>
      </div>
    </div>
    
    <div id="altitude">üèîÔ∏è 0m</div>
    <div class="phase-indicator" id="phase" id="i18nPhase">‚òÄÔ∏è Day</div>
    
    <div id="powerups" class="hidden">
      <button class="powerup-btn" id="pwMagnet" title="Magnet - Auto align">üß≤<span class="powerup-count">3</span></button>
      <button class="powerup-btn" id="pwSlow" title="Slow - Speed down">‚è±Ô∏è<span class="powerup-count">3</span></button>
      <button class="powerup-btn" id="pwDouble" title="Double score">‚ú®<span class="powerup-count">3</span></button>
    </div>
    
    <div id="perfectText">PERFECT!</div>
    
    <div id="menu">
      <h1>üèóÔ∏è <span>Infinite Stack</span></h1>
      <p id="i18nDesc">Stack to the sky!<br>Tap with perfect timing for combo bonus!</p>
      <button class="btn btn-play" onclick="startGame()">‚ñ∂ PLAY</button>
      <p style="margin-top:15px" id="i18nBest">üèÜ Best: <span id="menuBest">0</span></p>
      <div class="how-to-play">
        <h3 id="i18nHow">üéÆ Controls</h3>
        <ul>
          <li>Tap/Click - Place block</li>
          <li>Perfect - Combo, block expand</li>
          <li>Speed increases with height!</li>
          <li>Background changes: Day‚ÜíSunset‚ÜíNight‚ÜíSpace</li>
        </ul>
      </div>
    </div>
    
    <div id="gameover" class="hidden">
      <h1>GAME OVER</h1>
      <div id="finalScore">0</div>
      <div id="finalHeight" id="i18nFH">Best Height: 0m</div>
      <div id="bestScore">Best: 0</div>
      <div id="newBest" class="hidden">üéâ NEW RECORD!</div>
      <div class="stats-row">
        <div class="stat">
          <div class="stat-label" id="i18nMC">Max Combo</div>
          <div class="stat-value" id="maxCombo">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Perfect</div>
          <div class="stat-value" id="perfectCount">0</div>
        </div>
      </div>
      <button class="btn btn-retry" onclick="startGame()">üîÑ RETRY</button>
    </div>
  </div>

  <script>
    const T = GameI18n({
      desc:{en:'Stack to the sky!<br>Tap with perfect timing for combo bonus!',ko:'ÌïòÎäò ÎÅùÍπåÏßÄ ÏåìÏïÑ Ïò¨ÎùºÍ∞ÄÏÑ∏Ïöî!<br>ÏôÑÎ≤ΩÌïú ÌÉÄÏù¥Î∞çÏóê ÌÉ≠ÌïòÎ©¥ ÏΩ§Î≥¥ Î≥¥ÎÑàÏä§!'},
      mc:{en:'Max Combo',ko:'ÏµúÎåÄ ÏΩ§Î≥¥'}
    });
    (function(){var s=function(){
      document.getElementById('i18nDesc').innerHTML=T('desc');
      document.getElementById('i18nMC').textContent=T('mc');
    };if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',s);else s();})();


    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
      const container = document.getElementById('gameContainer');
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Í≤åÏûÑ Î∞∏Îü∞Ïä§ ÏÉÅÏàò
    const BALANCE = {
      block: {
        initialWidth: 180,
        minWidth: 12,
        height: 22,
        perfectThreshold: 6,
      },
      speed: {
        initial: 3,
        increment: 0.15,
        max: 12,
      },
      scoring: {
        base: 10,
        perfectBonus: 50,
        comboMultiplier: 0.1,
      },
      perfectBonus: {
        growWidth: 6,
        comboRequired: 3,
      },
      phases: [
        { name: _i18nLang==='ko'?'‚òÄÔ∏è ÎÇÆ':'‚òÄÔ∏è Day', minHeight: 0, colors: ['#87CEEB', '#E0F6FF'], buildingColor: '#2d3436' },
        { name: _i18nLang==='ko'?'üåÖ Ï†ÄÎÖÅ':'üåÖ Sunset', minHeight: 30, colors: ['#ff7e5f', '#feb47b'], buildingColor: '#1a1a2e' },
        { name: _i18nLang==='ko'?'üåô Î∞§':'üåô Night', minHeight: 60, colors: ['#0f0c29', '#302b63', '#24243e'], buildingColor: '#0a0a15' },
        { name: _i18nLang==='ko'?'üöÄ Ïö∞Ï£º':'üöÄ Space', minHeight: 100, colors: ['#000000', '#0a0a20', '#1a0a30'], buildingColor: '#05050a' },
      ]
    };

    // Í≤åÏûÑ ÏÉÅÌÉú
    let gameState = 'menu';
    let score = 0;
    let combo = 0;
    let maxCombo = 0;
    let perfectCount = 0;
    let bestScore = parseInt(localStorage.getItem('infiniteStackBest') || '0');
    let tower = [];
    let currentBlock = null;
    let fallingPieces = [];
    let particles = [];
    let cameraY = 0;
    let targetCameraY = 0;
    let speed = BALANCE.speed.initial;
    let currentPhase = 0;
    let stars = [];
    
    // ÌååÏõåÏóÖ ÏÉÅÌÉú
    let powerups = { magnet: 3, slow: 3, double: 3 };
    let activePowerup = null;
    let powerupTimer = 0;

    // ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (Ï∏µÎ≥Ñ Í∑∏ÎùºÎç∞Ïù¥ÏÖò)
    const blockColors = [
      '#ff6b6b', '#ff8787', '#ffa07a',
      '#ffd93d', '#ffe066', '#fff3bf',
      '#6bcb77', '#7ed687', '#95e1a3',
      '#4d96ff', '#74b3ff', '#a0c8ff',
      '#9b59b6', '#b377d9', '#c99be0',
      '#ff9f43', '#ffb76b', '#ffd093',
    ];

    function getBlockColor(index) {
      return blockColors[index % blockColors.length];
    }

    function getCurrentPhase() {
      const height = tower.length;
      for (let i = BALANCE.phases.length - 1; i >= 0; i--) {
        if (height >= BALANCE.phases[i].minHeight) return i;
      }
      return 0;
    }

    function generateStars() {
      stars = [];
      for (let i = 0; i < 100; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 2 + 0.5,
          twinkle: Math.random() * Math.PI * 2
        });
      }
    }

    function init() {
      document.getElementById('menuBest').textContent = bestScore;
      document.getElementById('best').textContent = bestScore;
      tower = [];
      fallingPieces = [];
      particles = [];
      score = 0;
      combo = 0;
      maxCombo = 0;
      perfectCount = 0;
      cameraY = 0;
      targetCameraY = 0;
      speed = BALANCE.speed.initial;
      currentPhase = 0;
      powerups = { magnet: 3, slow: 3, double: 3 };
      activePowerup = null;
      powerupTimer = 0;
      
      generateStars();
      updatePowerupUI();
      
      // Î≤†Ïù¥Ïä§ Î∏îÎ°ù
      const baseWidth = BALANCE.block.initialWidth;
      tower.push({
        x: canvas.width / 2,
        y: canvas.height - 80,
        width: baseWidth,
        color: getBlockColor(0)
      });
      
      spawnBlock();
    }

    function spawnBlock() {
      const lastBlock = tower[tower.length - 1];
      currentBlock = {
        x: -BALANCE.block.initialWidth / 2,
        y: lastBlock.y - BALANCE.block.height - 40,
        width: lastBlock.width,
        direction: 1,
        color: getBlockColor(tower.length)
      };
    }

    function createParticles(x, y, color, count = 10) {
      for (let i = 0; i < count; i++) {
        particles.push({
          x, y,
          vx: (Math.random() - 0.5) * 8,
          vy: (Math.random() - 0.5) * 8 - 3,
          color,
          size: Math.random() * 4 + 2,
          life: 1
        });
      }
    }

    function dropBlock() {
      if (!currentBlock || gameState !== 'playing') return;
      
      const lastBlock = tower[tower.length - 1];
      let diff = currentBlock.x - lastBlock.x;
      
      // ÏûêÏÑù ÌååÏõåÏóÖ: ÏûêÎèô Ï†ïÎ†¨
      if (activePowerup === 'magnet') {
        if (Math.abs(diff) < currentBlock.width * 0.7) {
          diff = 0; // ÏôÑÎ≤Ω Ï†ïÎ†¨
        }
      }
      
      const overlap = currentBlock.width / 2 + lastBlock.width / 2 - Math.abs(diff);
      
      if (overlap <= 0) {
        // ÏôÑÏ†ÑÌûà ÎπóÎÇòÍ∞ê
        fallingPieces.push({
          x: currentBlock.x,
          y: currentBlock.y,
          width: currentBlock.width,
          color: currentBlock.color,
          vx: currentBlock.direction * 5,
          vy: 0,
          rotation: 0,
          rotationSpeed: currentBlock.direction * 0.1
        });
        gameOver();
        return;
      }
      
      let newWidth, newX;
      const isPerfect = Math.abs(diff) <= BALANCE.block.perfectThreshold;
      
      if (isPerfect) {
        // Perfect Î∞∞Ïπò
        combo++;
        perfectCount++;
        if (combo > maxCombo) maxCombo = combo;
        
        newX = lastBlock.x;
        
        // ÏΩ§Î≥¥ 3Ìöå Ïù¥ÏÉÅÏù¥Î©¥ Î∏îÎ°ù ÌôïÏû•
        if (combo >= BALANCE.perfectBonus.comboRequired) {
          newWidth = Math.min(currentBlock.width + BALANCE.perfectBonus.growWidth, BALANCE.block.initialWidth);
        } else {
          newWidth = currentBlock.width;
        }
        
        // Ï†êÏàò Í≥ÑÏÇ∞ (2Î∞∞ Ï†êÏàò ÌååÏõåÏóÖ Ï†ÅÏö©)
        let points = BALANCE.scoring.base + BALANCE.scoring.perfectBonus;
        points += Math.floor(points * combo * BALANCE.scoring.comboMultiplier);
        if (activePowerup === 'double') points *= 2;
        score += points;
        
        showPerfect();
        createParticles(newX, lastBlock.y - BALANCE.block.height, '#ffd700', 15);
        
      } else {
        combo = 0;
        newWidth = overlap;
        newX = diff > 0 
          ? lastBlock.x + (lastBlock.width / 2 - overlap / 2) + overlap / 2
          : lastBlock.x - (lastBlock.width / 2 - overlap / 2) - overlap / 2;
        
        // Îñ®Ïñ¥ÏßÄÎäî Ï°∞Í∞Å ÏÉùÏÑ±
        const sliceWidth = currentBlock.width - overlap;
        const sliceX = diff > 0
          ? currentBlock.x + overlap / 2 + sliceWidth / 2
          : currentBlock.x - overlap / 2 - sliceWidth / 2;
        
        fallingPieces.push({
          x: sliceX,
          y: currentBlock.y,
          width: sliceWidth,
          color: currentBlock.color,
          vx: diff > 0 ? 4 : -4,
          vy: 0,
          rotation: 0,
          rotationSpeed: diff > 0 ? 0.08 : -0.08
        });
        
        let points = BALANCE.scoring.base;
        if (activePowerup === 'double') points *= 2;
        score += points;
      }
      
      // Í≤åÏûÑ Ïò§Î≤Ñ Ï≤¥ÌÅ¨
      if (newWidth < BALANCE.block.minWidth) {
        gameOver();
        return;
      }
      
      // ÌÉÄÏõåÏóê Ï∂îÍ∞Ä
      tower.push({
        x: newX,
        y: lastBlock.y - BALANCE.block.height,
        width: newWidth,
        color: currentBlock.color
      });
      
      // Ïπ¥Î©îÎùº ÏóÖÎç∞Ïù¥Ìä∏
      if (tower.length > 5) {
        targetCameraY = (tower.length - 5) * BALANCE.block.height;
      }
      
      // ÏÜçÎèÑ Ï¶ùÍ∞Ä (Ïä¨Î°úÏö∞ ÌååÏõåÏóÖ Ïãú Ï†àÎ∞ò)
      const speedInc = activePowerup === 'slow' ? BALANCE.speed.increment / 2 : BALANCE.speed.increment;
      speed = Math.min(speed + speedInc, BALANCE.speed.max);
      
      // ÌéòÏù¥Ï¶à ÏóÖÎç∞Ïù¥Ìä∏
      const newPhase = getCurrentPhase();
      if (newPhase !== currentPhase) {
        currentPhase = newPhase;
        createParticles(canvas.width / 2, canvas.height / 2, '#fff', 30);
      }
      
      updateUI();
      spawnBlock();
    }

    function showPerfect() {
      const text = document.getElementById('perfectText');
      if (combo >= 5) {
        text.textContent = `üî• PERFECT x${combo}!`;
      } else if (combo >= 3) {
        text.textContent = `‚ú® PERFECT x${combo}!`;
      } else {
        text.textContent = 'PERFECT!';
      }
      text.classList.remove('show');
      void text.offsetWidth; // reflow
      text.classList.add('show');
    }

    function updateUI() {
      document.getElementById('score').textContent = score;
      document.getElementById('altitude').textContent = `üèîÔ∏è ${(tower.length - 1) * 3}m`;
      document.getElementById('phase').textContent = BALANCE.phases[currentPhase].name;
      
      const comboBox = document.getElementById('comboBox');
      if (combo >= 2) {
        document.getElementById('combo').textContent = `x${combo}`;
        comboBox.classList.add('show');
      } else {
        comboBox.classList.remove('show');
      }
    }

    function updatePowerupUI() {
      document.getElementById('pwMagnet').querySelector('.powerup-count').textContent = powerups.magnet;
      document.getElementById('pwSlow').querySelector('.powerup-count').textContent = powerups.slow;
      document.getElementById('pwDouble').querySelector('.powerup-count').textContent = powerups.double;
      
      document.getElementById('pwMagnet').classList.toggle('disabled', powerups.magnet <= 0);
      document.getElementById('pwSlow').classList.toggle('disabled', powerups.slow <= 0);
      document.getElementById('pwDouble').classList.toggle('disabled', powerups.double <= 0);
      
      // ÌôúÏÑ±Ìôî ÌëúÏãú
      document.getElementById('pwMagnet').classList.toggle('active', activePowerup === 'magnet');
      document.getElementById('pwSlow').classList.toggle('active', activePowerup === 'slow');
      document.getElementById('pwDouble').classList.toggle('active', activePowerup === 'double');
    }

    function activatePowerup(type) {
      if (gameState !== 'playing') return;
      if (powerups[type] <= 0) return;
      if (activePowerup === type) return;
      
      powerups[type]--;
      activePowerup = type;
      powerupTimer = 300; // 5Ï¥à (60fps Í∏∞Ï§Ä)
      updatePowerupUI();
    }

    function gameOver() {
      gameState = 'gameover';
      
      const isNewBest = score > bestScore;
      if (isNewBest) {
        bestScore = score;
        localStorage.setItem('infiniteStackBest', bestScore);
      }
      
      document.getElementById('finalScore').textContent = score;
      document.getElementById('finalHeight').textContent = `${_i18nLang==='ko'?'ÏµúÍ≥† ÎÜíÏù¥':'Best Height'}: ${(tower.length - 1) * 3}m`;
      document.getElementById('bestScore').textContent = `Best: ${bestScore}`;
      document.getElementById('newBest').classList.toggle('hidden', !isNewBest);
      document.getElementById('maxCombo').textContent = maxCombo;
      document.getElementById('perfectCount').textContent = perfectCount;
      document.getElementById('gameover').classList.remove('hidden');
      document.getElementById('powerups').classList.add('hidden');
    }

    function startGame() {
      document.getElementById('menu').classList.add('hidden');
      document.getElementById('gameover').classList.add('hidden');
      document.getElementById('powerups').classList.remove('hidden');
      gameState = 'playing';
      init();
      updateUI();
    }

    function update() {
      if (gameState !== 'playing') return;
      
      // ÌååÏõåÏóÖ ÌÉÄÏù¥Î®∏
      if (activePowerup && powerupTimer > 0) {
        powerupTimer--;
        if (powerupTimer <= 0) {
          activePowerup = null;
          updatePowerupUI();
        }
      }
      
      // ÌòÑÏû¨ Î∏îÎ°ù Ïù¥Îèô
      if (currentBlock) {
        const currentSpeed = activePowerup === 'slow' ? speed * 0.5 : speed;
        currentBlock.x += currentSpeed * currentBlock.direction;
        
        // Î≤ΩÏóê ÎãøÏúºÎ©¥ Î∞©Ìñ• Ï†ÑÌôò
        const halfWidth = currentBlock.width / 2;
        if (currentBlock.x + halfWidth > canvas.width) {
          currentBlock.x = canvas.width - halfWidth;
          currentBlock.direction = -1;
        } else if (currentBlock.x - halfWidth < 0) {
          currentBlock.x = halfWidth;
          currentBlock.direction = 1;
        }
      }
      
      // Î∂ÄÎìúÎü¨Ïö¥ Ïπ¥Î©îÎùº Ïù¥Îèô
      cameraY += (targetCameraY - cameraY) * 0.08;
      
      // Îñ®Ïñ¥ÏßÄÎäî Ï°∞Í∞Å ÏóÖÎç∞Ïù¥Ìä∏
      fallingPieces.forEach(p => {
        p.vy += 0.6;
        p.x += p.vx;
        p.y += p.vy;
        p.rotation += p.rotationSpeed;
      });
      fallingPieces = fallingPieces.filter(p => p.y < canvas.height + 200);
      
      // ÌååÌã∞ÌÅ¥ ÏóÖÎç∞Ïù¥Ìä∏
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2;
        p.life -= 0.02;
        p.size *= 0.98;
      });
      particles = particles.filter(p => p.life > 0);
      
      // Î≥Ñ Î∞òÏßùÏûÑ ÏóÖÎç∞Ïù¥Ìä∏
      stars.forEach(s => {
        s.twinkle += 0.05;
      });
    }

    function drawBackground() {
      const phase = BALANCE.phases[currentPhase];
      const colors = phase.colors;
      
      // Í∑∏ÎùºÎç∞Ïù¥ÏÖò Î∞∞Í≤Ω
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      colors.forEach((color, i) => {
        gradient.addColorStop(i / (colors.length - 1), color);
      });
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Î∞§/Ïö∞Ï£º ÌéòÏù¥Ï¶àÏóêÏÑú Î≥Ñ Í∑∏Î¶¨Í∏∞
      if (currentPhase >= 2) {
        stars.forEach(star => {
          const alpha = 0.3 + Math.sin(star.twinkle) * 0.3;
          ctx.fillStyle = `rgba(255,255,255,${alpha})`;
          ctx.beginPath();
          ctx.arc(star.x, star.y - cameraY * 0.1, star.size, 0, Math.PI * 2);
          ctx.fill();
        });
      }
      
      // Î∞∞Í≤Ω Í±¥Î¨º (ÎÇÆ/Ï†ÄÎÖÅ ÌéòÏù¥Ï¶à)
      if (currentPhase < 2) {
        ctx.fillStyle = phase.buildingColor;
        for (let i = 0; i < 8; i++) {
          const bw = 40 + Math.random() * 30;
          const bh = 100 + Math.random() * 150;
          const bx = i * 55 + 10;
          ctx.fillRect(bx, canvas.height - bh + cameraY * 0.3, bw, bh);
          
          // Í±¥Î¨º Ï∞ΩÎ¨∏
          ctx.fillStyle = 'rgba(255,200,100,0.3)';
          for (let wy = canvas.height - bh + 20 + cameraY * 0.3; wy < canvas.height; wy += 25) {
            for (let wx = bx + 8; wx < bx + bw - 8; wx += 15) {
              if (Math.random() > 0.3) {
                ctx.fillRect(wx, wy, 8, 12);
              }
            }
          }
          ctx.fillStyle = phase.buildingColor;
        }
      }
    }

    function drawBlock(x, y, width, height, color, rotation = 0) {
      ctx.save();
      ctx.translate(x, y + height / 2);
      ctx.rotate(rotation);
      
      const left = -width / 2;
      const top = -height / 2;
      
      // Í∑∏Î¶ºÏûê
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fillRect(left + 4, top + 4, width, height);
      
      // Î©îÏù∏ Î∏îÎ°ù
      ctx.fillStyle = color;
      ctx.fillRect(left, top, width, height);
      
      // ÌïòÏù¥ÎùºÏù¥Ìä∏ (ÏÉÅÎã®)
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.fillRect(left, top, width, height * 0.35);
      
      // ÌÖåÎëêÎ¶¨
      ctx.strokeStyle = 'rgba(0,0,0,0.15)';
      ctx.lineWidth = 1;
      ctx.strokeRect(left, top, width, height);
      
      ctx.restore();
    }

    function draw() {
      drawBackground();
      
      ctx.save();
      ctx.translate(0, cameraY);
      
      // ÌÉÄÏõå Í∑∏Î¶¨Í∏∞
      tower.forEach((block, i) => {
        drawBlock(block.x, block.y, block.width, BALANCE.block.height, block.color);
      });
      
      // ÌòÑÏû¨ Î∏îÎ°ù Í∑∏Î¶¨Í∏∞
      if (currentBlock && gameState === 'playing') {
        drawBlock(currentBlock.x, currentBlock.y, currentBlock.width, BALANCE.block.height, currentBlock.color);
        
        // Í∞ÄÏù¥Îìú ÎùºÏù∏
        const lastBlock = tower[tower.length - 1];
        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.setLineDash([8, 8]);
        ctx.beginPath();
        ctx.moveTo(currentBlock.x, currentBlock.y + BALANCE.block.height);
        ctx.lineTo(currentBlock.x, lastBlock.y);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // ÌÉÄÍ≤ü ÏòÅÏó≠ ÌëúÏãú
        ctx.strokeStyle = 'rgba(255,215,0,0.3)';
        ctx.lineWidth = 2;
        ctx.strokeRect(
          lastBlock.x - lastBlock.width / 2,
          lastBlock.y - BALANCE.block.height,
          lastBlock.width,
          BALANCE.block.height
        );
      }
      
      // Îñ®Ïñ¥ÏßÄÎäî Ï°∞Í∞Å Í∑∏Î¶¨Í∏∞
      fallingPieces.forEach(p => {
        ctx.globalAlpha = 0.7;
        drawBlock(p.x, p.y, p.width, BALANCE.block.height, p.color, p.rotation);
        ctx.globalAlpha = 1;
      });
      
      ctx.restore();
      
      // ÌååÌã∞ÌÅ¥ Í∑∏Î¶¨Í∏∞ (Ïπ¥Î©îÎùº ÏòÅÌñ• Ïïà Î∞õÏùå)
      particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
      });
      
      // ÌååÏõåÏóÖ ÌôúÏÑ±Ìôî Ìö®Í≥º
      if (activePowerup) {
        ctx.fillStyle = activePowerup === 'magnet' ? 'rgba(100,200,255,0.1)' :
                       activePowerup === 'slow' ? 'rgba(100,255,100,0.1)' :
                       'rgba(255,215,0,0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ÌÉÄÏù¥Î®∏ Î∞î
        const barWidth = (powerupTimer / 300) * (canvas.width - 40);
        ctx.fillStyle = activePowerup === 'magnet' ? '#64c8ff' :
                       activePowerup === 'slow' ? '#64ff64' : '#ffd700';
        ctx.fillRect(20, canvas.height - 25, barWidth, 5);
      }
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // ÏûÖÎ†• Ï≤òÎ¶¨
    canvas.addEventListener('click', (e) => {
      if (gameState === 'playing') {
        dropBlock();
      }
    });
    
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (gameState === 'playing') {
        dropBlock();
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        if (gameState === 'menu') startGame();
        else if (gameState === 'playing') dropBlock();
        else if (gameState === 'gameover') startGame();
      }
      // Ïà´Ïûê ÌÇ§Î°ú ÌååÏõåÏóÖ
      if (gameState === 'playing') {
        if (e.code === 'Digit1') activatePowerup('magnet');
        if (e.code === 'Digit2') activatePowerup('slow');
        if (e.code === 'Digit3') activatePowerup('double');
      }
    });
    
    // ÌååÏõåÏóÖ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    document.getElementById('pwMagnet').addEventListener('click', (e) => {
      e.stopPropagation();
      activatePowerup('magnet');
    });
    document.getElementById('pwSlow').addEventListener('click', (e) => {
      e.stopPropagation();
      activatePowerup('slow');
    });
    document.getElementById('pwDouble').addEventListener('click', (e) => {
      e.stopPropagation();
      activatePowerup('double');
    });

    // Ï¥àÍ∏∞Ìôî
    init();
    gameLoop();
  </script>
<script src="../cross-promo.js"></script>
</body>
</html>
