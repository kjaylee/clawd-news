<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Sushi Sprint ğŸ£</title>
<meta name="description" content="Run your sushi bar! Read orders, combine ingredients, and serve perfect sushi before customers lose patience. Tap-based time management game.">
<meta property="og:title" content="Sushi Sprint ğŸ£">
<meta property="og:description" content="Run your sushi bar! Combine ingredients and serve sushi before time runs out!">
<meta property="og:image" content="https://eastsea.monster/games/icons/sushi-sprint.png">
<meta property="og:url" content="https://eastsea.monster/games/sushi-sprint/">
<meta property="og:type" content="website">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/games/tg-sdk-wrapper.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;touch-action:manipulation;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#1a0a00}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none}

:root{
--wood:#8B5E3C;--wood-dark:#5C3A1E;--wood-light:#A67C52;
--red:#E63946;--gold:#FFD700;--cream:#FFF8E7;
--green:#2D6A4F;--nori-green:#2F4F2F;
--counter-h:60px;--seat-size:clamp(56px,14vw,80px);
}

#game-wrapper{
width:100%;max-width:480px;height:100vh;height:calc(var(--tg-viewport-height,100vh));
position:relative;overflow:hidden;
background:linear-gradient(180deg,#1a0a00 0%,#2d1810 50%,#1a0a00 100%);
}

/* â•â•â• SCREENS â•â•â• */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s,transform .4s;z-index:10}
.screen.hidden{opacity:0;pointer-events:none;transform:scale(.95)}
.screen.active{opacity:1;pointer-events:auto;transform:scale(1)}

/* â•â•â• TITLE SCREEN â•â•â• */
#title-screen{background:linear-gradient(180deg,#1a0a00 0%,#3d1f0e 40%,#2d1810 100%)}
.title-logo{font-size:clamp(44px,12vw,64px);margin-bottom:4px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.5));animation:titleBounce 2s ease-in-out infinite}
.title-text{font-size:clamp(28px,8vw,42px);font-weight:900;color:var(--gold);text-shadow:0 2px 0 #b8860b,0 4px 12px rgba(0,0,0,.5);letter-spacing:2px;margin-bottom:2px}
.title-sub{font-size:14px;color:#c4a882;margin-bottom:28px;letter-spacing:4px}
@keyframes titleBounce{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-8px) rotate(2deg)}}

.lantern{position:absolute;font-size:40px;animation:lanternSway 3s ease-in-out infinite}
.lantern.l{left:10%;top:15%;animation-delay:0s}
.lantern.r{right:10%;top:15%;animation-delay:1.5s}
@keyframes lanternSway{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}

.title-stats{display:flex;gap:20px;margin-bottom:24px;font-size:14px;color:#c4a882}
.title-stats span{display:flex;align-items:center;gap:4px}

.btn{
padding:14px 36px;border:none;border-radius:16px;font-size:18px;font-weight:700;
cursor:pointer;transition:transform .12s,box-shadow .12s;min-width:200px;
display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn:active{transform:scale(.94)}
.btn-play{background:linear-gradient(135deg,var(--red),#c62828);color:#fff;box-shadow:0 6px 20px rgba(230,57,70,.4);margin-bottom:12px;font-size:20px}
.btn-shop{background:linear-gradient(135deg,var(--wood),var(--wood-dark));color:var(--cream);box-shadow:0 4px 12px rgba(0,0,0,.3);margin-bottom:8px}
.btn-sm{padding:10px 24px;font-size:15px;min-width:160px}

/* â•â•â• HUD â•â•â• */
#hud{
position:absolute;top:0;left:0;right:0;
padding:calc(var(--safe-top,0px) + 6px) 10px 6px;
display:flex;justify-content:space-between;align-items:center;
background:linear-gradient(180deg,rgba(0,0,0,.7) 0%,transparent 100%);
z-index:50;font-size:13px;color:#fff;
}
.hud-item{display:flex;align-items:center;gap:3px;font-weight:600}
.hud-combo{color:var(--gold);font-weight:800;animation:comboPulse .6s ease-in-out infinite}
@keyframes comboPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

/* â•â•â• CUSTOMER AREA â•â•â• */
#customer-area{
position:absolute;top:calc(var(--safe-top,0px) + 40px);left:0;right:0;
height:calc(55% - var(--safe-top,0px) - 40px);
display:flex;flex-direction:column;justify-content:flex-start;
padding:8px 6px;overflow:hidden;
}
.counter-bg{
position:absolute;bottom:0;left:0;right:0;height:100%;
background:linear-gradient(180deg,transparent 0%,rgba(139,94,60,.15) 60%,rgba(139,94,60,.3) 100%);
pointer-events:none;
}

.seats-row{
display:flex;justify-content:center;gap:clamp(4px,2vw,10px);
flex-wrap:nowrap;padding:4px 0;position:relative;z-index:5;
}
.seat{
width:var(--seat-size);min-height:calc(var(--seat-size) + 50px);
display:flex;flex-direction:column;align-items:center;
position:relative;transition:all .3s;
}
.seat.empty{opacity:.3}
.seat-stool{
width:calc(var(--seat-size) - 12px);height:20px;
background:linear-gradient(180deg,var(--wood-light),var(--wood));
border-radius:50%;position:absolute;bottom:0;
box-shadow:0 2px 6px rgba(0,0,0,.3);
}

.customer{
display:flex;flex-direction:column;align-items:center;
animation:customerEnter .4s cubic-bezier(.34,1.56,.64,1);
position:relative;
}
@keyframes customerEnter{from{transform:translateY(-30px) scale(.5);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.customer-face{font-size:clamp(28px,7vw,40px);transition:transform .2s}
.customer.angry .customer-face{animation:angryShake .3s ease-in-out 3}
@keyframes angryShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-10deg)}75%{transform:rotate(10deg)}}

.order-bubble{
background:#fff;border-radius:14px;padding:4px 8px;margin-top:2px;
box-shadow:0 2px 8px rgba(0,0,0,.2);position:relative;
min-width:40px;text-align:center;font-size:clamp(14px,3.5vw,20px);
display:flex;gap:2px;align-items:center;justify-content:center;flex-wrap:wrap;
}
.order-bubble::after{
content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);
width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid #fff;
}

.patience-bar{
width:calc(var(--seat-size) - 8px);height:5px;
background:rgba(0,0,0,.3);border-radius:3px;margin-top:4px;overflow:hidden;
}
.patience-fill{
height:100%;border-radius:3px;transition:width .3s linear,background-color .5s;
}

/* â•â•â• COUNTER / DIVIDER â•â•â• */
#counter-divider{
position:absolute;top:55%;left:0;right:0;height:8px;
background:linear-gradient(180deg,var(--wood-dark),var(--wood),var(--wood-dark));
box-shadow:0 2px 8px rgba(0,0,0,.4);z-index:20;
}

/* â•â•â• PREP AREA â•â•â• */
#prep-area{
position:absolute;top:calc(55% + 8px);left:0;right:0;
bottom:calc(var(--safe-bottom,0px));
display:flex;flex-direction:column;
padding:6px 8px;z-index:15;
background:linear-gradient(180deg,#2d1810,#1a0a00);
}

/* Plate */
#plate-area{
flex:0 0 auto;display:flex;align-items:center;justify-content:center;
gap:8px;padding:6px 4px;margin-bottom:4px;
}
#plate{
flex:1;min-height:48px;max-width:320px;
background:rgba(255,255,255,.08);border:2px dashed rgba(255,255,255,.15);
border-radius:16px;padding:6px 10px;
display:flex;align-items:center;justify-content:center;gap:4px;flex-wrap:wrap;
font-size:clamp(20px,5vw,28px);transition:all .2s;position:relative;
}
#plate.has-items{border-color:rgba(255,255,255,.3);background:rgba(255,255,255,.12)}
#plate.correct{border-color:#4caf50;background:rgba(76,175,80,.2);animation:plateGlow .4s}
#plate.wrong{border-color:var(--red);animation:plateShake .4s}
@keyframes plateGlow{0%,100%{box-shadow:none}50%{box-shadow:0 0 20px rgba(76,175,80,.5)}}
@keyframes plateShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
#plate-label{position:absolute;color:rgba(255,255,255,.25);font-size:13px;pointer-events:none}

.plate-btn{
width:40px;height:40px;border-radius:50%;border:none;font-size:18px;
cursor:pointer;display:flex;align-items:center;justify-content:center;
transition:transform .1s;
}
.plate-btn:active{transform:scale(.9)}
#btn-reset{background:rgba(255,100,100,.2);color:#ff6b6b}
#btn-serve{background:rgba(100,255,100,.2);color:#69f0ae}
#btn-serve.ready{background:linear-gradient(135deg,#4caf50,#2e7d32);color:#fff;box-shadow:0 4px 12px rgba(76,175,80,.4);animation:serveReady .6s ease-in-out infinite}
@keyframes serveReady{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

/* Target customer indicator */
#target-indicator{
font-size:11px;color:var(--gold);text-align:center;
padding:2px 0;min-height:18px;
}

/* Ingredient buttons */
#ingredient-grid{
flex:1;display:grid;
grid-template-columns:repeat(4,1fr);
gap:clamp(4px,1.5vw,8px);
padding:4px 0;
align-content:start;
}
.ing-btn{
background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05));
border:1px solid rgba(255,255,255,.1);border-radius:14px;
display:flex;flex-direction:column;align-items:center;justify-content:center;
gap:1px;padding:6px 2px;cursor:pointer;transition:transform .1s,background .15s;
min-height:clamp(50px,12vw,68px);
}
.ing-btn:active{transform:scale(.92);background:rgba(255,255,255,.2)}
.ing-btn .icon{font-size:clamp(22px,5.5vw,30px)}
.ing-btn .label{font-size:clamp(9px,2.2vw,11px);color:rgba(255,255,255,.6);font-weight:600}
.ing-btn.locked{opacity:.3;pointer-events:none}

/* â•â•â• SHOP SCREEN â•â•â• */
#shop-screen{background:linear-gradient(180deg,#1a0a00,#2d1810)}
.shop-title{font-size:24px;font-weight:800;color:var(--gold);margin:20px 0 4px}
.shop-coins{font-size:16px;color:var(--cream);margin-bottom:16px}
.shop-scroll{width:100%;max-width:400px;padding:0 16px;overflow-y:auto;max-height:60vh}
.shop-category{margin-bottom:20px}
.shop-cat-title{font-size:14px;color:#c4a882;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid rgba(255,255,255,.1)}
.shop-item{
display:flex;align-items:center;gap:12px;
background:rgba(255,255,255,.06);border-radius:14px;padding:12px;margin-bottom:8px;
transition:transform .1s;
}
.shop-item-icon{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.08);border-radius:12px}
.shop-item-info{flex:1}
.shop-item-name{font-size:15px;font-weight:700;color:#fff}
.shop-item-desc{font-size:12px;color:rgba(255,255,255,.5);margin-top:2px}
.shop-item-btn{
padding:8px 16px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;
transition:transform .1s;white-space:nowrap;
}
.shop-item-btn:active{transform:scale(.93)}
.shop-item-btn.buy{background:var(--gold);color:#1a0a00}
.shop-item-btn.owned{background:rgba(255,255,255,.1);color:rgba(255,255,255,.4);pointer-events:none}
.shop-item-btn.cant{background:rgba(255,255,255,.05);color:rgba(255,255,255,.25);pointer-events:none}

/* â•â•â• WAVE BANNER â•â•â• */
#wave-banner{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);
z-index:100;text-align:center;pointer-events:none;
transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;opacity:0;
}
#wave-banner.show{transform:translate(-50%,-50%) scale(1);opacity:1}
#wave-banner .wave-num{font-size:48px;font-weight:900;color:var(--gold);text-shadow:0 4px 16px rgba(0,0,0,.5)}
#wave-banner .wave-sub{font-size:16px;color:var(--cream);margin-top:4px}

/* â•â•â• FLOATING EFFECTS â•â•â• */
.float-text{
position:absolute;z-index:200;pointer-events:none;
font-weight:800;font-size:20px;
animation:floatUp 1.2s ease-out forwards;
}
@keyframes floatUp{
0%{opacity:1;transform:translateY(0) scale(1)}
60%{opacity:1;transform:translateY(-40px) scale(1.1)}
100%{opacity:0;transform:translateY(-70px) scale(.8)}
}
.float-text.coin{color:var(--gold)}
.float-text.combo{color:#ff6b6b;font-size:28px}
.float-text.perfect{color:#69f0ae;font-size:24px}

/* â•â•â• JUICE PARTICLES â•â•â• */
.bg-particle{
position:absolute;pointer-events:none;z-index:1;opacity:.5;
animation:bgDrift linear forwards;
}
@keyframes bgDrift{
0%{transform:translateY(0) rotate(0deg);opacity:.5}
80%{opacity:.3}
100%{transform:translateY(calc(100vh + 30px)) rotate(360deg);opacity:0}
}
.serve-particle{
position:absolute;z-index:210;pointer-events:none;font-size:16px;
animation:serveBurst .8s ease-out forwards;
}
@keyframes serveBurst{
0%{opacity:1;transform:translate(0,0) scale(1) rotate(0deg)}
100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0) rotate(var(--rot))}
}
.screen-shake{animation:screenShake .4s ease-out}
@keyframes screenShake{
0%,100%{transform:translate(0,0)}
10%{transform:translate(-4px,-2px)}
20%{transform:translate(6px,2px)}
30%{transform:translate(-6px,-4px)}
40%{transform:translate(4px,4px)}
50%{transform:translate(-2px,-2px)}
60%{transform:translate(2px,0)}
}
.emoji-pop{
position:absolute;z-index:210;pointer-events:none;font-size:28px;
animation:emojiPop 1s ease-out forwards;
}
@keyframes emojiPop{
0%{opacity:0;transform:scale(0) translateY(0)}
20%{opacity:1;transform:scale(1.3) translateY(-10px)}
50%{opacity:1;transform:scale(1) translateY(-30px)}
100%{opacity:0;transform:scale(.5) translateY(-60px)}
}
.wave-flash{
position:absolute;inset:0;z-index:95;pointer-events:none;
background:radial-gradient(circle,rgba(255,215,0,.25),transparent 70%);
animation:waveFlash .8s ease-out forwards;
}
@keyframes waveFlash{
0%{opacity:1;transform:scale(.5)}
100%{opacity:0;transform:scale(2)}
}
.combo-big{
position:absolute;z-index:220;pointer-events:none;
font-size:36px;font-weight:900;
text-shadow:0 2px 8px rgba(0,0,0,.5);
animation:comboBig 1.2s ease-out forwards;
}
@keyframes comboBig{
0%{opacity:0;transform:translate(-50%,-50%) scale(0) rotate(-10deg)}
30%{opacity:1;transform:translate(-50%,-50%) scale(1.3) rotate(5deg)}
60%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(0deg)}
100%{opacity:0;transform:translate(-50%,-50%) scale(.7) translateY(-30px)}
}

/* â•â•â• GAME OVER â•â•â• */
#gameover-screen{background:rgba(0,0,0,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.go-card{
background:linear-gradient(180deg,#2d1810,#1a0a00);
border:2px solid rgba(255,215,0,.2);border-radius:24px;
padding:28px 24px;text-align:center;width:85%;max-width:340px;
box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.go-title{font-size:26px;font-weight:900;color:var(--red);margin-bottom:4px}
.go-wave{font-size:14px;color:#c4a882;margin-bottom:16px}
.go-score{font-size:52px;font-weight:900;color:var(--gold);text-shadow:0 2px 12px rgba(255,215,0,.3)}
.go-label{font-size:12px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:3px;margin-bottom:8px}
.go-best{font-size:15px;color:#c4a882;margin-bottom:4px}
.go-newbest{color:var(--gold);font-weight:700;animation:comboPulse .8s ease-in-out infinite}
.go-stats{display:flex;gap:16px;justify-content:center;margin:12px 0 20px;font-size:13px;color:rgba(255,255,255,.5)}
.go-buttons{display:flex;gap:10px}
.go-buttons .btn{flex:1;padding:14px 12px;font-size:15px;min-width:0}

/* â•â•â• PAUSE OVERLAY â•â•â• */
#pause-overlay{
position:absolute;inset:0;z-index:500;
background:rgba(0,0,0,.8);backdrop-filter:blur(6px);
display:flex;flex-direction:column;align-items:center;justify-content:center;
opacity:0;pointer-events:none;transition:opacity .3s;
}
#pause-overlay.show{opacity:1;pointer-events:auto}
.pause-text{font-size:28px;color:var(--gold);font-weight:800;margin-bottom:20px}

/* â•â•â• WELCOME TEXT â•â•â• */
.welcome-text{
position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);
font-size:clamp(32px,10vw,48px);font-weight:900;color:var(--gold);
text-shadow:0 4px 16px rgba(0,0,0,.5);
z-index:100;pointer-events:none;
animation:welcomeFade 2s ease-out forwards;white-space:nowrap;
}
@keyframes welcomeFade{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}35%{transform:translate(-50%,-50%) scale(1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) scale(.8) translateY(-20px)}}

/* â•â•â• TUTORIAL â•â•â• */
.tutorial-overlay{
position:absolute;inset:0;z-index:300;
background:rgba(0,0,0,.7);
display:flex;flex-direction:column;align-items:center;justify-content:center;
padding:20px;text-align:center;
}
.tutorial-step{color:#fff;font-size:16px;line-height:1.6;max-width:300px}
.tutorial-step .big{font-size:40px;display:block;margin-bottom:12px}
.tutorial-tap{margin-top:16px;font-size:13px;color:rgba(255,255,255,.4);animation:blink 1.5s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}

/* â•â•â• MUTE FAB â•â•â• */
.mute-fab{
position:absolute;bottom:calc(var(--safe-bottom,0px) + 14px);right:14px;
z-index:200;width:44px;height:44px;border-radius:50%;border:none;
background:rgba(0,0,0,.45);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
font-size:20px;cursor:pointer;transition:transform .15s,background .2s;
display:flex;align-items:center;justify-content:center;
box-shadow:0 2px 8px rgba(0,0,0,.3);
}
.mute-fab:active{transform:scale(.88)}
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": "Sushi Sprint",
  "url": "https://eastsea.monster/games/sushi-sprint/",
  "description": "ìŠ¤ì‹œ ë°”ì—ì„œ ì†ë‹˜ ì£¼ë¬¸ì„ ì½ê³  ì¬ë£Œë¥¼ ì¡°í•©í•´ ì„œë¹™í•˜ëŠ” íƒ€ì„ë§¤ë‹ˆì§€ë¨¼íŠ¸! 11ì¢… ë ˆì‹œí”¼, ì›¨ì´ë¸Œ ì‹œìŠ¤í…œ, ê°€ê²Œ ì—…ê·¸ë ˆì´ë“œ, ì½¤ë³´ ë³´ë„ˆìŠ¤!",
  "image": "https://eastsea.monster/games/sushi-sprint/og.png",
  "gamePlatform": [
    "Web Browser",
    "Mobile Browser"
  ],
  "applicationCategory": "Game",
  "genre": "Simulation",
  "operatingSystem": "Any",
  "inLanguage": [
    "ko",
    "en"
  ],
  "playMode": "SinglePlayer",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock"
  },
  "author": {
    "@type": "Person",
    "name": "Jay Lee",
    "url": "https://eastsea.monster"
  }
}
</script>
</head>
<body>
<div id="game-wrapper">

<!-- TITLE SCREEN -->
<div id="title-screen" class="screen active">
  <div class="lantern l">ğŸ®</div>
  <div class="lantern r">ğŸ®</div>
  <div class="title-logo">ğŸ£</div>
  <div class="title-text">SUSHI SPRINT</div>
  <div class="title-sub">å¯¿å¸ã‚¹ãƒ—ãƒªãƒ³ãƒˆ</div>
  <div class="title-stats">
    <span>ğŸ’° <b id="title-coins">0</b></span>
    <span>ğŸŒŠ <b id="title-wave">0</b></span>
    <span>ğŸ† <b id="title-best">0</b></span>
  </div>
  <button class="btn btn-play" id="btn-play">â–¶ PLAY</button>
  <button class="btn btn-shop btn-sm" id="btn-shop">ğŸª SHOP</button>
</div>

<!-- SHOP SCREEN -->
<div id="shop-screen" class="screen hidden">
  <div class="shop-title">ğŸª SHOP</div>
  <div class="shop-coins">ğŸ’° <span id="shop-coins">0</span></div>
  <div class="shop-scroll" id="shop-scroll"></div>
  <button class="btn btn-sm" id="btn-shop-back" style="background:rgba(255,255,255,.1);color:#fff;margin-top:16px">â† Back</button>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen hidden">
  <div id="hud">
    <div class="hud-item">ğŸ’° <span id="hud-coins">0</span></div>
    <div class="hud-item">â¤ï¸ <span id="hud-lives">3</span></div>
    <div class="hud-item">ğŸŒŠ <span id="hud-wave">1</span></div>
    <div class="hud-item hud-combo" id="hud-combo" style="display:none">ğŸ”¥ x<span id="hud-combo-val">0</span></div>
  </div>

  <div id="customer-area">
    <div class="counter-bg"></div>
    <div class="seats-row" id="seats-row"></div>
  </div>

  <div id="counter-divider"></div>

  <div id="prep-area">
    <div id="plate-area">
      <button class="plate-btn" id="btn-reset" title="Clear plate">âœ•</button>
      <div id="plate"><span id="plate-label">Select ingredients</span></div>
      <button class="plate-btn" id="btn-serve" title="Serve">âœ“</button>
    </div>
    <div id="target-indicator"></div>
    <div id="ingredient-grid"></div>
  </div>

  <div id="wave-banner">
    <div class="wave-num" id="wave-num"></div>
    <div class="wave-sub" id="wave-sub"></div>
  </div>

  <div id="pause-overlay">
    <div class="pause-text">â¸ PAUSED</div>
    <button class="btn btn-play btn-sm" id="btn-resume">â–¶ Resume</button>
    <button class="btn btn-sm" id="btn-quit" style="background:rgba(255,255,255,.1);color:#fff;margin-top:8px">ğŸ  Quit</button>
  </div>
</div>

<!-- GAME OVER SCREEN -->
<div id="gameover-screen" class="screen hidden">
  <div class="go-card">
    <div class="go-title">é–‰åº— â€” Closed</div>
    <div class="go-wave" id="go-wave"></div>
    <div class="go-score" id="go-score">0</div>
    <div class="go-label">Total Coins</div>
    <div id="go-best-wrap">
      <div class="go-best" id="go-best"></div>
    </div>
    <div class="go-stats">
      <span>ğŸ£ <span id="go-served">0</span> served</span>
      <span>ğŸ”¥ <span id="go-maxcombo">0</span> max combo</span>
      <span>ğŸ’¸ <span id="go-tips">0</span> tips</span>
    </div>
    <div class="go-buttons">
      <button class="btn btn-play" id="btn-retry">ğŸ”„ Retry</button>
      <button class="btn btn-shop btn-sm" id="btn-go-home">ğŸ </button>
    </div>
  </div>
</div>

<button id="mute-btn" class="mute-fab" aria-label="Toggle sound">ğŸ”Š</button>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUSHI SPRINT â€” Complete Game
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const GAME_ID = 'sushi-sprint';

// â•â•â• AUDIO ENGINE (BGM + SFX with gain separation) â•â•â•
const Audio = (() => {
  let ctx=null,masterGain,bgmGain,sfxGain;
  let muted=false,bgmPlaying=false,bgmTimeout=null,bgmStep=0;
  // Japanese Yo pentatonic: C4 D4 E4 G4 A4 C5 D5 E5
  const YO=[261.63,293.66,329.63,392.00,440.00,523.25,587.33,659.25];
  const BEAT=220;
  // Melody: [noteIdx(-1=rest), beats, velocity]
  const MEL=[
    [2,1,.3],[3,1,.28],[4,1.5,.3],[-1,.5,0],[3,1,.28],[2,1,.25],[0,2,.3],[-1,1,0],
    [2,1,.3],[3,1,.28],[4,1,.3],[5,1,.32],[4,1.5,.28],[3,2,.22],[-1,1,0],
    [4,1,.3],[5,1,.3],[4,1,.28],[3,1,.28],[2,1.5,.25],[0,1,.2],[1,1,.22],[-1,.5,0],
    [2,1,.3],[3,1,.3],[2,1,.25],[0,1,.28],[2,2.5,.2],[-1,2,0],
  ];

  const init=()=>{
    if(ctx){if(ctx.state==='suspended')ctx.resume();return;}
    try{
      ctx=new(window.AudioContext||window.webkitAudioContext)();
      masterGain=ctx.createGain();bgmGain=ctx.createGain();sfxGain=ctx.createGain();
      masterGain.connect(ctx.destination);bgmGain.connect(masterGain);sfxGain.connect(masterGain);
      bgmGain.gain.value=.15;sfxGain.gain.value=.5;
      if(muted)masterGain.gain.value=0;
    }catch(e){}
  };

  const sfx=(freq,type,dur,vol=.3,det=0)=>{
    if(!ctx||muted)return;
    try{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g);g.connect(sfxGain);o.type=type;o.frequency.value=freq;
      if(det)o.detune.value=det;
      g.gain.setValueAtTime(vol,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+dur);
      o.start();o.stop(ctx.currentTime+dur);
    }catch(e){}
  };

  const noise=(dur,vol=.1)=>{
    if(!ctx||muted)return;
    try{
      const buf=ctx.createBuffer(1,ctx.sampleRate*dur,ctx.sampleRate),d=buf.getChannelData(0);
      for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*vol;
      const s=ctx.createBufferSource(),g=ctx.createGain();
      s.buffer=buf;s.connect(g);g.connect(sfxGain);
      g.gain.setValueAtTime(vol,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+dur);
      s.start();
    }catch(e){}
  };

  // BGM: koto-style note with pluck overtone
  const bgmNote=()=>{
    if(!ctx||!bgmPlaying)return;
    const[ni,beats,vol]=MEL[bgmStep%MEL.length];
    const dur=beats*BEAT/1000;
    if(ni>=0&&!muted){
      const freq=YO[ni];
      try{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.connect(g);g.connect(bgmGain);o.type='sine';
        o.frequency.setValueAtTime(freq,ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(freq*.998,ctx.currentTime+dur);
        g.gain.setValueAtTime(vol,ctx.currentTime);
        g.gain.setValueAtTime(vol*.7,ctx.currentTime+dur*.1);
        g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+dur);
        o.start();o.stop(ctx.currentTime+dur+.05);
        const o2=ctx.createOscillator(),g2=ctx.createGain();
        o2.connect(g2);g2.connect(bgmGain);o2.type='triangle';
        o2.frequency.value=freq*2;
        g2.gain.setValueAtTime(vol*.2,ctx.currentTime);
        g2.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+dur*.3);
        o2.start();o2.stop(ctx.currentTime+dur*.3+.02);
      }catch(e){}
    }
    bgmStep++;
    bgmTimeout=setTimeout(bgmNote,dur*1000);
  };

  const startBGM=()=>{if(bgmPlaying)return;bgmPlaying=true;bgmStep=0;bgmNote();};
  const stopBGM=()=>{bgmPlaying=false;clearTimeout(bgmTimeout);};
  const toggleMute=()=>{muted=!muted;if(masterGain)masterGain.gain.value=muted?0:1;return muted;};

  return{
    init,
    get muted(){return muted;},
    toggleMute,startBGM,stopBGM,
    tap(){sfx(800,'sine',.08,.15);},
    place(){sfx(600,'triangle',.12,.2);sfx(900,'sine',.08,.1);},
    serve(){sfx(523,'sine',.12,.25);setTimeout(()=>sfx(659,'sine',.12,.25),80);setTimeout(()=>sfx(784,'sine',.2,.3),160);},
    wrong(){sfx(200,'sawtooth',.2,.15);sfx(150,'sawtooth',.25,.1);},
    combo(n){const b=600+n*50;sfx(b,'sine',.15,.3);setTimeout(()=>sfx(b*1.25,'sine',.15,.3),80);setTimeout(()=>sfx(b*1.5,'sine',.25,.35),160);},
    angry(){sfx(150,'square',.3,.15);sfx(120,'square',.3,.1);},
    wave(){[0,100,200,300].forEach((d,i)=>setTimeout(()=>sfx(440*Math.pow(2,i/6),'sine',.2,.25),d));},
    coin(){sfx(1200,'sine',.06,.12);setTimeout(()=>sfx(1600,'sine',.08,.15),60);},
    upgrade(){[0,80,160,240].forEach((d,i)=>setTimeout(()=>sfx(500+i*100,'sine',.15,.2),d));},
    gameOver(){stopBGM();[0,200,400].forEach((d,i)=>setTimeout(()=>sfx(400-i*80,'sawtooth',.3,.15),d));},
    welcome(){noise(.08,.05);sfx(880,'sine',.15,.2);setTimeout(()=>sfx(1100,'sine',.15,.2),120);},
    customerArrive(){sfx(660,'sine',.08,.12);setTimeout(()=>sfx(880,'sine',.1,.15),70);},
    levelUp(){[0,80,160,240,320].forEach((d,i)=>setTimeout(()=>sfx(440*Math.pow(2,i/5),'sine',.2,.25),d));},
  };
})();

// â•â•â• INGREDIENTS â•â•â•
const INGREDIENTS = [
  { type: 'rice',     icon: 'ğŸš', label: 'Rice',     color: '#FFFFFF' },
  { type: 'salmon',   icon: 'ğŸ£', label: 'Salmon',   color: '#FA8072' },
  { type: 'tuna',     icon: 'ğŸŸ', label: 'Tuna',     color: '#DC143C' },
  { type: 'shrimp',   icon: 'ğŸ¦', label: 'Shrimp',   color: '#FFA07A' },
  { type: 'egg',      icon: 'ğŸ¥š', label: 'Egg',      color: '#FFD700' },
  { type: 'cucumber', icon: 'ğŸ¥’', label: 'Cucumber', color: '#32CD32' },
  { type: 'avocado',  icon: 'ğŸ¥‘', label: 'Avocado',  color: '#9ACD32' },
  { type: 'nori',     icon: 'ğŸ™', label: 'Nori',     color: '#2F4F2F' },
];

// â•â•â• RECIPES â•â•â•
const RECIPES = [
  { name: 'Salmon Nigiri',   ingredients: ['rice','salmon'],                           points: 10, difficulty: 1, emoji: 'ğŸ£' },
  { name: 'Tuna Nigiri',     ingredients: ['rice','tuna'],                             points: 10, difficulty: 1, emoji: 'ğŸŸ' },
  { name: 'Shrimp Nigiri',   ingredients: ['rice','shrimp'],                           points: 10, difficulty: 1, emoji: 'ğŸ¦' },
  { name: 'Salmon Roll',     ingredients: ['rice','salmon','nori'],                    points: 20, difficulty: 2, emoji: 'ğŸ£' },
  { name: 'Cucumber Roll',   ingredients: ['rice','cucumber','nori'],                  points: 20, difficulty: 2, emoji: 'ğŸ¥’' },
  { name: 'Egg Sushi',       ingredients: ['rice','egg','nori'],                       points: 20, difficulty: 2, emoji: 'ğŸ¥š' },
  { name: 'Dragon Roll',     ingredients: ['rice','shrimp','avocado','nori'],          points: 35, difficulty: 3, emoji: 'ğŸ‰' },
  { name: 'Rainbow Roll',    ingredients: ['rice','salmon','tuna','nori'],             points: 35, difficulty: 3, emoji: 'ğŸŒˆ' },
  { name: 'Spicy Tuna Roll', ingredients: ['rice','tuna','cucumber','nori'],           points: 35, difficulty: 3, emoji: 'ğŸŒ¶ï¸' },
  { name: 'Deluxe Platter',  ingredients: ['rice','salmon','tuna','shrimp','nori'],    points: 50, difficulty: 4, emoji: 'ğŸ‘‘' },
  { name: 'Chef Special',    ingredients: ['rice','salmon','avocado','cucumber','nori'],points: 50, difficulty: 4, emoji: 'â­' },
];

// â•â•â• CUSTOMER FACES â•â•â•
const FACES_HAPPY = ['ğŸ˜Š','ğŸ˜„','ğŸ˜','ğŸ¥°','ğŸ˜‹','ğŸ¤©'];
const FACES_WAITING = ['ğŸ™‚','ğŸ˜','ğŸ˜¶','ğŸ¤¨'];
const FACES_ANGRY = ['ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ’¢'];
const FACES_SERVED = ['ğŸ˜','ğŸ¥³','ğŸ¤¤','ğŸ˜†','ğŸ’–'];

// â•â•â• BALANCE â•â•â•
const BAL = {
  PATIENCE_BASE: 100,
  PATIENCE_DECAY: [0, .12, .12, .12, .18, .18, .18, .28, .28, .28, .35, .35, .35, .45],
  SPAWN_INTERVAL: [0, 4500, 4200, 3800, 3400, 3000, 2800, 2600, 2400, 2200, 2000, 1900, 1800, 1600],
  WAVE_SEATS: [0, 3,3,3, 4,4,4, 4,4,4, 5,5,5, 5],
  WAVE_MAX_DIFF: [0, 1,1,2, 2,2,3, 3,3,3, 3,4,4, 4],
  WAVE_CUSTOMERS: 8,
  SPEED_BONUS_THRESH: 65,
  SPEED_BONUS_MULT: 1.5,
  COMBO_BONUS: .5,
  COMBO_TIMEOUT: 5000,
  LIVES_MAX: 3,
  BASE_TIP: 10,
};

// â•â•â• SHOP ITEMS â•â•â•
const SHOP_ITEMS = [
  // Seats
  { id: 'seat4', cat: 'seats', name: '4th Seat', desc: 'Add a 4th customer seat', icon: 'ğŸ’º', cost: 500, requires: null },
  { id: 'seat5', cat: 'seats', name: '5th Seat', desc: 'Add a 5th customer seat', icon: 'ğŸ’º', cost: 1200, requires: 'seat4' },
  // Menu
  { id: 'menu2', cat: 'menu', name: 'Roll Recipes', desc: 'Unlock 3-ingredient rolls', icon: 'ğŸ“œ', cost: 200, requires: null },
  { id: 'menu3', cat: 'menu', name: 'Special Rolls', desc: 'Unlock 4-ingredient specials', icon: 'ğŸ“œ', cost: 600, requires: 'menu2' },
  { id: 'menu4', cat: 'menu', name: 'Chef Collection', desc: 'Unlock 5-ingredient masterpieces', icon: 'ğŸ“œ', cost: 1500, requires: 'menu3' },
  // Decor
  { id: 'lantern', cat: 'decor', name: 'Paper Lantern', desc: '+5% patience for all customers', icon: 'ğŸ®', cost: 300, requires: null },
  { id: 'bamboo', cat: 'decor', name: 'Bamboo Plant', desc: '+5% patience for all customers', icon: 'ğŸ‹', cost: 500, requires: null },
  { id: 'aquarium', cat: 'decor', name: 'Koi Aquarium', desc: '+10% tip bonus', icon: 'ğŸ ', cost: 1000, requires: null },
  { id: 'gold_counter', cat: 'decor', name: 'Gold Counter', desc: '+15% all earnings', icon: 'âœ¨', cost: 2500, requires: null },
];

// â•â•â• GAME STATE â•â•â•
let state = {
  screen: 'title',
  // Persistent
  coins: 0,
  bestWave: 0,
  bestScore: 0,
  upgrades: [], // owned upgrade ids
  totalServed: 0,
  // Session
  wave: 1,
  lives: 3,
  sessionCoins: 0,
  combo: 0,
  maxCombo: 0,
  comboTimer: null,
  served: 0,
  tipsEarned: 0,
  waveCustomersLeft: 0,
  // Runtime
  customers: [], // { id, seat, order, patience, maxPatience, patienceDecay, face, state, el }
  plate: [],     // ingredient types on plate
  selectedSeat: -1,
  paused: false,
  gameRunning: false,
  spawnTimer: null,
  nextCustId: 0,
  animFrame: null,
  lastTick: 0,
  tutorialDone: false,
};

// â•â•â• DOM REFS â•â•â•
const $ = id => document.getElementById(id);
const wrapper = $('game-wrapper');
const seatsRow = $('seats-row');
const plateEl = $('plate');
const plateLabelEl = $('plate-label');
const ingGrid = $('ingredient-grid');
const targetInd = $('target-indicator');

// â•â•â• SAVE / LOAD â•â•â•
function saveGame() {
  const d = { coins: state.coins, bestWave: state.bestWave, bestScore: state.bestScore, upgrades: state.upgrades, totalServed: state.totalServed, tutorialDone: state.tutorialDone };
  if (window.TG && TG.isReady) { TG.save(GAME_ID, d); }
  else { try { localStorage.setItem(GAME_ID, JSON.stringify(d)); } catch(e) {} }
}
function loadGame() {
  let d = null;
  if (window.TG && TG.isReady) { d = TG.load(GAME_ID); }
  else { try { d = JSON.parse(localStorage.getItem(GAME_ID)); } catch(e) {} }
  if (d) {
    state.coins = d.coins || 0;
    state.bestWave = d.bestWave || 0;
    state.bestScore = d.bestScore || 0;
    state.upgrades = d.upgrades || [];
    state.totalServed = d.totalServed || 0;
    state.tutorialDone = d.tutorialDone || false;
  }
}

// â•â•â• UPGRADE HELPERS â•â•â•
function hasUpgrade(id) { return state.upgrades.includes(id); }
function getMaxSeats() {
  let s = 3;
  if (hasUpgrade('seat4')) s = 4;
  if (hasUpgrade('seat5')) s = 5;
  return s;
}
function getMaxMenuDiff() {
  let d = 1;
  if (hasUpgrade('menu2')) d = 2;
  if (hasUpgrade('menu3')) d = 3;
  if (hasUpgrade('menu4')) d = 4;
  return d;
}
function getPatienceBonus() {
  let b = 0;
  if (hasUpgrade('lantern')) b += 5;
  if (hasUpgrade('bamboo')) b += 5;
  return b;
}
function getTipBonus() {
  let b = 1;
  if (hasUpgrade('aquarium')) b += .1;
  if (hasUpgrade('gold_counter')) b += .15;
  return b;
}

// â•â•â• WAVE CONFIG â•â•â•
function waveConfig(w) {
  const cw = Math.min(w, 13);
  return {
    seats: Math.min(BAL.WAVE_SEATS[cw] || 5, getMaxSeats()),
    maxDiff: Math.min(BAL.WAVE_MAX_DIFF[cw] || 4, getMaxMenuDiff()),
    decay: BAL.PATIENCE_DECAY[cw] || .45,
    interval: BAL.SPAWN_INTERVAL[cw] || 1600,
    total: BAL.WAVE_CUSTOMERS + Math.floor(w / 3),
  };
}

// â•â•â• SCREEN MANAGEMENT â•â•â•
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.classList.add('hidden'); });
  const el = $(name + '-screen');
  if (el) { el.classList.remove('hidden'); el.classList.add('active'); }
  state.screen = name;
}

// â•â•â• TITLE SCREEN â•â•â•
function updateTitle() {
  $('title-coins').textContent = state.coins.toLocaleString();
  $('title-wave').textContent = state.bestWave;
  $('title-best').textContent = state.bestScore.toLocaleString();
}

// â•â•â• SHOP â•â•â•
function renderShop() {
  $('shop-coins').textContent = state.coins.toLocaleString();
  const cats = { seats: 'ğŸ’º Seats', menu: 'ğŸ“œ Menu', decor: 'ğŸ¨ Decor' };
  let html = '';
  for (const [catId, catName] of Object.entries(cats)) {
    const items = SHOP_ITEMS.filter(i => i.cat === catId);
    html += `<div class="shop-category"><div class="shop-cat-title">${catName}</div>`;
    for (const item of items) {
      const owned = hasUpgrade(item.id);
      const locked = item.requires && !hasUpgrade(item.requires);
      const canBuy = !owned && !locked && state.coins >= item.cost;
      let btnClass = owned ? 'owned' : (canBuy ? 'buy' : 'cant');
      let btnText = owned ? 'âœ“ Owned' : (locked ? 'ğŸ”’ Locked' : `ğŸ’° ${item.cost}`);
      html += `<div class="shop-item">
        <div class="shop-item-icon">${item.icon}</div>
        <div class="shop-item-info"><div class="shop-item-name">${item.name}</div><div class="shop-item-desc">${item.desc}</div></div>
        <button class="shop-item-btn ${btnClass}" data-id="${item.id}" ${!canBuy ? 'disabled' : ''}>${btnText}</button>
      </div>`;
    }
    html += '</div>';
  }
  $('shop-scroll').innerHTML = html;

  // Bind buy buttons
  $('shop-scroll').querySelectorAll('.shop-item-btn.buy').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const item = SHOP_ITEMS.find(i => i.id === id);
      if (item && state.coins >= item.cost && !hasUpgrade(id)) {
        state.coins -= item.cost;
        state.upgrades.push(id);
        saveGame();
        Audio.upgrade();
        if (window.TG) TG.haptic('notification', 'success');
        renderShop();
        updateTitle();
      }
    });
  });
}

// â•â•â• INGREDIENT GRID â•â•â•
function renderIngredients() {
  const maxDiff = getMaxMenuDiff();
  // Figure out which ingredients are needed for unlocked recipes
  const available = new Set();
  RECIPES.filter(r => r.difficulty <= maxDiff).forEach(r => r.ingredients.forEach(i => available.add(i)));

  ingGrid.innerHTML = '';
  INGREDIENTS.forEach(ing => {
    const locked = !available.has(ing.type);
    const btn = document.createElement('div');
    btn.className = 'ing-btn' + (locked ? ' locked' : '');
    btn.innerHTML = `<span class="icon">${ing.icon}</span><span class="label">${ing.label}</span>`;
    if (!locked) {
      btn.addEventListener('click', () => addToPlate(ing.type));
      btn.addEventListener('touchend', e => { e.preventDefault(); addToPlate(ing.type); });
    }
    ingGrid.appendChild(btn);
  });
}

// â•â•â• PLATE MANAGEMENT â•â•â•
function addToPlate(type) {
  if (state.plate.length >= 5) return;
  Audio.init();
  Audio.place();
  if (window.TG) TG.haptic('impact', 'light');
  state.plate.push(type);
  renderPlate();
  checkAutoServe();
}

function renderPlate() {
  const icons = state.plate.map(t => INGREDIENTS.find(i => i.type === t)?.icon || '?').join(' ');
  plateEl.innerHTML = icons || `<span id="plate-label">Select ingredients</span>`;
  plateEl.classList.toggle('has-items', state.plate.length > 0);

  // Update serve button
  const serveBtn = $('btn-serve');
  const match = findMatchingCustomer();
  serveBtn.classList.toggle('ready', !!match);
}

function clearPlate() {
  state.plate = [];
  renderPlate();
  Audio.tap();
  if (window.TG) TG.haptic('impact', 'light');
}

// â•â•â• CUSTOMER MANAGEMENT â•â•â•
function buildSeats(count) {
  seatsRow.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const seat = document.createElement('div');
    seat.className = 'seat empty';
    seat.dataset.idx = i;
    seat.innerHTML = `<div class="seat-stool"></div>`;
    seat.addEventListener('click', () => selectSeat(i));
    seatsRow.appendChild(seat);
  }
}

function selectSeat(idx) {
  const cust = state.customers.find(c => c.seat === idx && c.state === 'waiting');
  if (!cust) return;
  state.selectedSeat = idx;
  Audio.tap();
  if (window.TG) TG.haptic('selection');
  updateTargetIndicator();
  // Visual highlight
  document.querySelectorAll('.seat').forEach(s => s.style.outline = 'none');
  const seatEl = seatsRow.children[idx];
  if (seatEl) seatEl.style.outline = '2px solid var(--gold)';
}

function updateTargetIndicator() {
  if (state.selectedSeat >= 0) {
    const cust = state.customers.find(c => c.seat === state.selectedSeat && c.state === 'waiting');
    if (cust) {
      const recipe = RECIPES.find(r => arraysMatch(r.ingredients, cust.order));
      targetInd.textContent = `â–¶ Seat ${state.selectedSeat + 1}: ${recipe?.name || 'Order'} ${recipe?.emoji || ''}`;
      targetInd.style.color = 'var(--gold)';
      return;
    }
  }
  targetInd.textContent = state.customers.length > 0 ? 'Tap a customer to select target' : '';
  targetInd.style.color = 'rgba(255,255,255,.35)';
}

function spawnCustomer() {
  if (!state.gameRunning || state.paused) return;
  if (state.waveCustomersLeft <= 0) return;

  const cfg = waveConfig(state.wave);
  const seats = [];
  for (let i = 0; i < cfg.seats; i++) {
    if (!state.customers.find(c => c.seat === i)) seats.push(i);
  }
  if (seats.length === 0) return;

  const seat = seats[Math.floor(Math.random() * seats.length)];
  const availRecipes = RECIPES.filter(r => r.difficulty <= cfg.maxDiff);
  const recipe = availRecipes[Math.floor(Math.random() * availRecipes.length)];

  const patienceBase = BAL.PATIENCE_BASE + getPatienceBonus();
  const cust = {
    id: state.nextCustId++,
    seat,
    order: [...recipe.ingredients],
    recipe,
    patience: patienceBase,
    maxPatience: patienceBase,
    patienceDecay: cfg.decay,
    face: FACES_HAPPY[Math.floor(Math.random() * FACES_HAPPY.length)],
    state: 'waiting',
    el: null,
  };

  state.customers.push(cust);
  state.waveCustomersLeft--;
  renderCustomer(cust);
  Audio.customerArrive();
  updateTargetIndicator();
  
  // Auto-select if only customer
  if (state.customers.filter(c => c.state === 'waiting').length === 1) {
    selectSeat(seat);
  }
}

function renderCustomer(cust) {
  const seatEl = seatsRow.children[cust.seat];
  if (!seatEl) return;
  seatEl.classList.remove('empty');

  const orderIcons = cust.order.map(t => INGREDIENTS.find(i => i.type === t)?.icon || '?').join('');
  const div = document.createElement('div');
  div.className = 'customer';
  div.dataset.id = cust.id;
  div.innerHTML = `
    <div class="order-bubble">${orderIcons}</div>
    <div class="customer-face">${cust.face}</div>
    <div class="patience-bar"><div class="patience-fill" style="width:100%;background:#4caf50"></div></div>
  `;
  
  // Remove stool-only content, insert customer before stool
  const stool = seatEl.querySelector('.seat-stool');
  seatEl.insertBefore(div, stool);
  cust.el = div;
}

function removeCustomer(cust, reason) {
  const seatEl = seatsRow.children[cust.seat];
  if (cust.el && seatEl) {
    cust.el.style.transition = 'transform .3s, opacity .3s';
    cust.el.style.transform = reason === 'served' ? 'translateY(-20px) scale(.8)' : 'translateX(30px) scale(.8)';
    cust.el.style.opacity = '0';
    setTimeout(() => {
      if (cust.el && cust.el.parentNode) cust.el.parentNode.removeChild(cust.el);
      seatEl.classList.add('empty');
    }, 300);
  }
  state.customers = state.customers.filter(c => c.id !== cust.id);
  
  // Clear selection if this seat was selected
  if (state.selectedSeat === cust.seat) {
    state.selectedSeat = -1;
    document.querySelectorAll('.seat').forEach(s => s.style.outline = 'none');
  }
  updateTargetIndicator();
}

// â•â•â• SERVING â•â•â•
function findMatchingCustomer() {
  if (state.plate.length === 0) return null;
  
  // If a seat is selected, check that customer first
  if (state.selectedSeat >= 0) {
    const cust = state.customers.find(c => c.seat === state.selectedSeat && c.state === 'waiting');
    if (cust && arraysMatch(state.plate, cust.order)) return cust;
  }
  
  // Then check all waiting customers
  for (const cust of state.customers) {
    if (cust.state === 'waiting' && arraysMatch(state.plate, cust.order)) return cust;
  }
  return null;
}

function checkAutoServe() {
  // Auto-highlight serve button
  const match = findMatchingCustomer();
  $('btn-serve').classList.toggle('ready', !!match);
}

function servePlate() {
  if (state.plate.length === 0) return;
  
  const match = findMatchingCustomer();
  if (!match) {
    // Wrong order
    Audio.wrong();
    if (window.TG) TG.haptic('notification', 'error');
    plateEl.classList.add('wrong');
    setTimeout(() => plateEl.classList.remove('wrong'), 400);
    screenShake();
    return;
  }

  // Success!
  Audio.serve();
  if (window.TG) TG.haptic('notification', 'success');
  plateEl.classList.add('correct');
  setTimeout(() => plateEl.classList.remove('correct'), 400);

  // Calculate reward
  const recipe = match.recipe;
  const speedBonus = match.patience > BAL.SPEED_BONUS_THRESH ? BAL.SPEED_BONUS_MULT : 1;
  
  // Combo
  state.combo++;
  if (state.combo > state.maxCombo) state.maxCombo = state.combo;
  clearTimeout(state.comboTimer);
  state.comboTimer = setTimeout(() => { state.combo = 0; updateHUD(); }, BAL.COMBO_TIMEOUT);

  const comboMult = 1 + Math.min(state.combo - 1, 10) * BAL.COMBO_BONUS;
  const tipBonus = getTipBonus();
  const coins = Math.round((recipe.points + BAL.BASE_TIP) * speedBonus * comboMult * tipBonus);
  const tip = Math.round(coins - recipe.points);

  state.sessionCoins += coins;
  state.coins += coins;
  state.served++;
  state.totalServed++;
  state.tipsEarned += tip;

  // Customer happy
  match.state = 'served';
  const faceEl = match.el?.querySelector('.customer-face');
  if (faceEl) faceEl.textContent = FACES_SERVED[Math.floor(Math.random() * FACES_SERVED.length)];

  // Float effects
  const seatEl = seatsRow.children[match.seat];
  if (seatEl) {
    const rect = seatEl.getBoundingClientRect();
    const wrapRect = wrapper.getBoundingClientRect();
    const x = rect.left - wrapRect.left + rect.width / 2;
    const y = rect.top - wrapRect.top;
    spawnFloat(x, y, `+${coins} ğŸ’°`, 'coin');
    spawnServeParticles(x, y);
    
    // Customer satisfaction emoji
    const satEmojis = ['ğŸ˜','ğŸ¥³','ğŸ¤¤','ğŸ’–','ğŸ‰','âœ¨'];
    spawnEmojiPop(x + (Math.random()-.5)*40, y - 20, satEmojis[Math.floor(Math.random()*satEmojis.length)]);
    
    if (speedBonus > 1) spawnFloat(x + 30, y + 20, 'FAST! âš¡', 'perfect');
    
    if (state.combo >= 2) {
      Audio.combo(state.combo);
      spawnFloat(x - 20, y - 10, `ğŸ”¥ COMBO x${state.combo}!`, 'combo');
      
      // Enhanced Japanese combo text
      if (state.combo === 3) spawnComboBig('ã™ã”ã„!', '#ff6b6b');
      else if (state.combo === 5) spawnComboBig('ã‚„ã£ãŸ!', '#ffab40');
      else if (state.combo === 7) spawnComboBig('ç¥æ¥­!', '#ffd700');
      else if (state.combo >= 10) spawnComboBig('ä¼èª¬! ğŸ‰', '#e040fb');
    }
  }

  // Remove after delay
  setTimeout(() => removeCustomer(match, 'served'), 500);

  // Clear plate
  state.plate = [];
  renderPlate();
  updateHUD();
  saveGame();

  // Check wave completion
  checkWaveComplete();
}

function spawnFloat(x, y, text, cls) {
  const el = document.createElement('div');
  el.className = `float-text ${cls}`;
  el.textContent = text;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  wrapper.appendChild(el);
  setTimeout(() => el.remove(), 1200);
}

// â•â•â• JUICE EFFECTS â•â•â•
const BG_EMOJIS = ['ğŸŒ¸','ğŸŒ¸','ğŸŒ¸','ğŸƒ','ğŸ‹','ğŸ™','ğŸŒº'];
let bgParticleTimer = null;
function startBgParticles() {
  stopBgParticles();
  const spawn = () => {
    if (!state.gameRunning || state.paused) return;
    const el = document.createElement('div');
    el.className = 'bg-particle';
    el.textContent = BG_EMOJIS[Math.floor(Math.random() * BG_EMOJIS.length)];
    el.style.left = Math.random() * 100 + '%';
    el.style.top = '-24px';
    el.style.fontSize = (10 + Math.random() * 14) + 'px';
    el.style.animationDuration = (7 + Math.random() * 9) + 's';
    wrapper.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
  };
  bgParticleTimer = setInterval(spawn, 1400);
  spawn();
}
function stopBgParticles() {
  clearInterval(bgParticleTimer);
  wrapper.querySelectorAll('.bg-particle').forEach(e => e.remove());
}

function spawnServeParticles(x, y) {
  const emojis = ['â­','âœ¨','ğŸ’›','ğŸŒŸ','â¤ï¸','ğŸ’«'];
  for (let i = 0; i < 8; i++) {
    const el = document.createElement('div');
    el.className = 'serve-particle';
    el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    const angle = (Math.PI * 2 / 8) * i + (Math.random() - .5) * .5;
    const dist = 35 + Math.random() * 55;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.setProperty('--dx', Math.cos(angle) * dist + 'px');
    el.style.setProperty('--dy', Math.sin(angle) * dist + 'px');
    el.style.setProperty('--rot', Math.floor(Math.random() * 360) + 'deg');
    el.style.animationDelay = (i * 25) + 'ms';
    wrapper.appendChild(el);
    setTimeout(() => el.remove(), 900);
  }
}

function screenShake() {
  wrapper.classList.remove('screen-shake');
  void wrapper.offsetWidth;
  wrapper.classList.add('screen-shake');
  wrapper.addEventListener('animationend', () => wrapper.classList.remove('screen-shake'), { once: true });
}

function spawnEmojiPop(x, y, emoji) {
  const el = document.createElement('div');
  el.className = 'emoji-pop';
  el.textContent = emoji;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  wrapper.appendChild(el);
  setTimeout(() => el.remove(), 1100);
}

function spawnComboBig(text, color) {
  const el = document.createElement('div');
  el.className = 'combo-big';
  el.textContent = text;
  el.style.color = color;
  el.style.left = '50%';
  el.style.top = '45%';
  wrapper.appendChild(el);
  setTimeout(() => el.remove(), 1300);
}

function waveFlash() {
  const el = document.createElement('div');
  el.className = 'wave-flash';
  wrapper.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

function arraysMatch(a, b) {
  if (a.length !== b.length) return false;
  const sa = [...a].sort();
  const sb = [...b].sort();
  return sa.every((v, i) => v === sb[i]);
}

// â•â•â• GAME LOOP â•â•â•
function gameLoop(ts) {
  if (!state.gameRunning) return;
  if (state.paused) { state.animFrame = requestAnimationFrame(gameLoop); return; }

  const dt = state.lastTick ? (ts - state.lastTick) / 1000 : 0;
  state.lastTick = ts;

  // Update patience
  for (const cust of [...state.customers]) {
    if (cust.state !== 'waiting') continue;
    cust.patience -= cust.patienceDecay * dt * 60;

    // Update face based on patience
    const pct = cust.patience / cust.maxPatience;
    if (pct < .3 && cust.face !== 'ğŸ˜¡') {
      cust.face = FACES_ANGRY[Math.floor(Math.random() * FACES_ANGRY.length)];
      const f = cust.el?.querySelector('.customer-face');
      if (f) f.textContent = cust.face;
      if (!cust.el?.classList.contains('angry')) cust.el?.classList.add('angry');
    } else if (pct < .6 && pct >= .3) {
      const f = cust.el?.querySelector('.customer-face');
      if (f && !FACES_WAITING.includes(f.textContent) && !FACES_ANGRY.includes(f.textContent)) {
        f.textContent = FACES_WAITING[Math.floor(Math.random() * FACES_WAITING.length)];
      }
    }

    // Update patience bar
    const bar = cust.el?.querySelector('.patience-fill');
    if (bar) {
      const w = Math.max(0, pct * 100);
      bar.style.width = w + '%';
      bar.style.backgroundColor = pct > .6 ? '#4caf50' : pct > .3 ? '#ff9800' : '#f44336';
    }

    // Customer leaves
    if (cust.patience <= 0) {
      cust.state = 'angry';
      Audio.angry();
      screenShake();
      if (window.TG) TG.haptic('notification', 'error');
      state.lives--;
      state.combo = 0;
      
      const faceEl = cust.el?.querySelector('.customer-face');
      if (faceEl) faceEl.textContent = 'ğŸ’¢';

      // Float effect
      const seatEl = seatsRow.children[cust.seat];
      if (seatEl) {
        const rect = seatEl.getBoundingClientRect();
        const wrapRect = wrapper.getBoundingClientRect();
        spawnFloat(rect.left - wrapRect.left + rect.width/2, rect.top - wrapRect.top, 'ğŸ’” -1', 'combo');
      }

      setTimeout(() => removeCustomer(cust, 'angry'), 600);
      updateHUD();

      if (state.lives <= 0) {
        gameOver();
        return;
      }
      checkWaveComplete();
    }
  }

  state.animFrame = requestAnimationFrame(gameLoop);
}

// â•â•â• WAVE SYSTEM â•â•â•
function startWave() {
  const cfg = waveConfig(state.wave);
  state.waveCustomersLeft = cfg.total;

  // Build seats for this wave
  buildSeats(cfg.seats);
  renderIngredients();

  // Show wave banner
  $('wave-num').textContent = `ğŸŒŠ Wave ${state.wave}`;
  const waveTexts = ['', 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›!', 'Let\'s go!', 'Getting busy!', 'Rush hour!', 'Full house!',
    'Non-stop!', 'Expert mode!', 'Master chef!', 'Legendary!', 'Insane!', 'Ultra!', 'MAXIMUM!', 'ç¥ãƒ¢ãƒ¼ãƒ‰!'];
  $('wave-sub').textContent = waveTexts[Math.min(state.wave, waveTexts.length - 1)] || 'é™ç•Œçªç ´!';
  
  const banner = $('wave-banner');
  banner.classList.add('show');
  if (state.wave > 1) waveFlash();
  Audio.startBGM();
  if (state.wave > 1) Audio.levelUp();
  Audio.wave();
  setTimeout(() => banner.classList.remove('show'), 2000);

  // Start spawning
  clearInterval(state.spawnTimer);
  setTimeout(() => {
    spawnCustomer();
    state.spawnTimer = setInterval(spawnCustomer, cfg.interval);
  }, 1500);
}

function checkWaveComplete() {
  // Wave done when: no customers left to spawn AND no waiting customers
  if (state.waveCustomersLeft <= 0 && state.customers.filter(c => c.state === 'waiting').length === 0) {
    // Next wave
    clearInterval(state.spawnTimer);
    state.wave++;
    if (state.wave > state.bestWave) {
      state.bestWave = state.wave;
    }
    saveGame();
    setTimeout(() => startWave(), 1500);
  }
}

// â•â•â• HUD â•â•â•
function updateHUD() {
  $('hud-coins').textContent = state.sessionCoins.toLocaleString();
  $('hud-lives').textContent = 'â¤ï¸'.repeat(state.lives);
  $('hud-wave').textContent = state.wave;
  
  const comboEl = $('hud-combo');
  if (state.combo >= 2) {
    comboEl.style.display = 'flex';
    $('hud-combo-val').textContent = state.combo;
  } else {
    comboEl.style.display = 'none';
  }
}

// â•â•â• TUTORIAL â•â•â•
function showTutorial(onDone) {
  const steps = [
    { big: 'ğŸ£', text: 'Welcome to <b>Sushi Sprint</b>!<br>Customers order sushi â€” you make it!' },
    { big: 'ğŸ‘†', text: 'Tap <b>ingredient buttons</b> below<br>to add them to your plate' },
    { big: 'âœ“', text: 'When the plate matches an order,<br>tap <b>Serve âœ“</b> to deliver!' },
    { big: 'â±ï¸', text: 'Watch the <b>patience bar</b>!<br>Serve before it runs out!' },
    { big: 'ğŸ”¥', text: 'Serve fast for <b>combos</b> &<br>earn bonus tips! Good luck!' },
  ];
  let step = 0;
  
  const overlay = document.createElement('div');
  overlay.className = 'tutorial-overlay';
  
  function show() {
    const s = steps[step];
    overlay.innerHTML = `
      <div class="tutorial-step">
        <span class="big">${s.big}</span>
        ${s.text}
      </div>
      <div class="tutorial-tap">tap to continue (${step + 1}/${steps.length})</div>
    `;
  }
  show();
  
  overlay.addEventListener('click', () => {
    Audio.tap();
    step++;
    if (step >= steps.length) {
      overlay.remove();
      state.tutorialDone = true;
      saveGame();
      if (onDone) onDone();
    } else {
      show();
    }
  });
  
  wrapper.appendChild(overlay);
}

// â•â•â• GAME START / END â•â•â•
function startGame() {
  Audio.init();
  state.wave = 1;
  state.lives = BAL.LIVES_MAX;
  state.sessionCoins = 0;
  state.combo = 0;
  state.maxCombo = 0;
  state.served = 0;
  state.tipsEarned = 0;
  state.customers = [];
  state.plate = [];
  state.selectedSeat = -1;
  state.paused = false;
  state.gameRunning = true;
  state.nextCustId = 0;
  state.lastTick = 0;

  showScreen('game');
  startBgParticles();
  updateHUD();
  renderPlate();

  // Welcome text
  const welc = document.createElement('div');
  welc.className = 'welcome-text';
  welc.textContent = 'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›!';
  wrapper.appendChild(welc);
  Audio.welcome();
  setTimeout(() => welc.remove(), 2200);

  if (!state.tutorialDone) {
    showTutorial(() => {
      startWave();
      state.animFrame = requestAnimationFrame(gameLoop);
    });
  } else {
    setTimeout(() => {
      startWave();
      state.animFrame = requestAnimationFrame(gameLoop);
    }, 800);
  }
}

function gameOver() {
  state.gameRunning = false;
  clearInterval(state.spawnTimer);
  cancelAnimationFrame(state.animFrame);
  stopBgParticles();
  Audio.gameOver();
  if (window.TG) TG.haptic('notification', 'error');

  const isNewBest = state.sessionCoins > state.bestScore;
  if (isNewBest) state.bestScore = state.sessionCoins;
  saveGame();

  // Record score
  if (window.GameScore) {
    GameScore.save(GAME_ID, state.sessionCoins);
  }

  // Show game over screen
  $('go-wave').textContent = `Wave ${state.wave} reached`;
  $('go-score').textContent = state.sessionCoins.toLocaleString();
  $('go-best').textContent = `ğŸ… Best: ${state.bestScore.toLocaleString()}`;
  if (isNewBest) {
    $('go-best').classList.add('go-newbest');
    $('go-best').textContent = 'ğŸ† New Best! ' + state.bestScore.toLocaleString();
  } else {
    $('go-best').classList.remove('go-newbest');
  }
  $('go-served').textContent = state.served;
  $('go-maxcombo').textContent = state.maxCombo;
  $('go-tips').textContent = state.tipsEarned;

  showScreen('gameover');
}

// â•â•â• PAUSE â•â•â•
function togglePause() {
  state.paused = !state.paused;
  $('pause-overlay').classList.toggle('show', state.paused);
  if (state.paused) Audio.stopBGM(); else Audio.startBGM();
}

// â•â•â• EVENT BINDINGS â•â•â•
$('btn-play').addEventListener('click', () => { Audio.init(); Audio.tap(); startGame(); });
$('btn-shop').addEventListener('click', () => { Audio.tap(); renderShop(); showScreen('shop'); });
$('btn-shop-back').addEventListener('click', () => { Audio.tap(); updateTitle(); showScreen('title'); });
$('btn-reset').addEventListener('click', clearPlate);
$('btn-serve').addEventListener('click', servePlate);
$('btn-resume').addEventListener('click', togglePause);
$('btn-quit').addEventListener('click', () => { state.gameRunning = false; clearInterval(state.spawnTimer); cancelAnimationFrame(state.animFrame); Audio.stopBGM(); stopBgParticles(); updateTitle(); showScreen('title'); });
$('btn-retry').addEventListener('click', () => { Audio.tap(); startGame(); });
$('btn-go-home').addEventListener('click', () => { Audio.tap(); updateTitle(); showScreen('title'); });
$('mute-btn').addEventListener('click', () => { const m = Audio.toggleMute(); $('mute-btn').textContent = m ? 'ğŸ”‡' : 'ğŸ”Š'; });

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (state.screen !== 'game' || !state.gameRunning) return;
  if (e.key === 'Escape' || e.key === 'p') togglePause();
  if (e.key === 'Enter') servePlate();
  if (e.key === 'Backspace' || e.key === 'Delete') clearPlate();
  // Number keys for ingredients
  const n = parseInt(e.key);
  if (n >= 1 && n <= 8) {
    const ing = INGREDIENTS[n - 1];
    if (ing) addToPlate(ing.type);
  }
  // Select seat with arrow keys or tab
  if (e.key >= '1' && e.key <= '5' && e.shiftKey) {
    selectSeat(parseInt(e.key) - 1);
  }
});

// Prevent zoom on double tap
document.addEventListener('dblclick', e => e.preventDefault());

// Handle visibility change (pause when app goes background)
document.addEventListener('visibilitychange', () => {
  if (document.hidden && state.gameRunning && !state.paused) {
    togglePause();
  }
});

// TG back button
if (window.TG && TG.onBack) {
  TG.onBack(() => {
    if (state.screen === 'shop') { updateTitle(); showScreen('title'); return true; }
    if (state.screen === 'game' && state.gameRunning) { 
      if (state.paused) { state.gameRunning = false; clearInterval(state.spawnTimer); cancelAnimationFrame(state.animFrame); updateTitle(); showScreen('title'); }
      else { togglePause(); }
      return true; 
    }
    if (state.screen === 'gameover') { updateTitle(); showScreen('title'); return true; }
    return false;
  });
}

// â•â•â• INIT â•â•â•
loadGame();
updateTitle();
</script>
<script src="../cross-promo.js"></script>
</body>
</html>
