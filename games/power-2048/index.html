<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, user-scalable=no">
<title>ğŸ”¥ Power 2048</title>
<meta property="og:title" content="ğŸ”¥ Power 2048">
<meta property="og:type" content="website">
<meta property="og:url" content="https://eastsea.monster/games/power-2048/">
<meta property="og:description" content="Play Power 2048 - Free HTML5 game. No download required!">
<meta property="og:image" content="https://eastsea.monster/games/power-2048/og.png">
<meta property="og:site_name" content="East Sea Games">
<meta name="description" content="Play Power 2048 - Free HTML5 browser game. No download, no install.">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eastsea.monster/games/power-2048/og.png">
<meta name="twitter:title" content="ğŸ”¥ Power 2048">
<meta name="description" content="Classic 2048 with Power-ups! Bomb, Freeze, Double, Undo, Sniper. Classic, Stage & Daily Challenge modes.">
<style>
:root {
    --bg: #0a0a1a;
    --bg2: #12122a;
    --bg3: #1a1a3a;
    --border: #2a2a4a;
    --text: #e8e8ff;
    --muted: #8888aa;
    --dim: #555577;
    --accent: #667eea;
    --accent2: #764ba2;
    --pink: #ff6b9d;
    --cyan: #00d4ff;
    --gold: #ffd700;
    --green: #00ff88;
    --red: #ff4444;
    --cell-bg: #1e1e3e;
    --grid-bg: #0e0e2e;
    --radius: 12px;
    --grid-gap: 10px;
    --cell-size: 75px;
    --grid-total: calc(4 * var(--cell-size) + 5 * var(--grid-gap));
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;touch-action:none;}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR','Noto Sans JP','Noto Sans SC',sans-serif;
    background:var(--bg);color:var(--text);
    display:flex;justify-content:center;align-items:center;
    user-select:none;-webkit-user-select:none;
}
#app{
    width:100%;max-width:500px;height:100%;max-height:900px;
    display:flex;flex-direction:column;position:relative;overflow:hidden;
}
.screen{
    position:absolute;inset:0;display:flex;flex-direction:column;
    transition:opacity .3s,transform .3s;
    padding:16px;overflow-y:auto;
}
.screen.hidden{opacity:0;pointer-events:none;transform:translateY(20px);}

/* ===== MENU ===== */
.menu-screen{justify-content:center;align-items:center;text-align:center;gap:16px;}
.menu-title{
    font-size:2.4rem;font-weight:900;
    background:linear-gradient(135deg,var(--cyan),var(--accent),var(--pink));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;text-shadow:none;
    filter:drop-shadow(0 0 20px rgba(0,212,255,.3));
    margin-bottom:4px;
}
.menu-sub{color:var(--muted);font-size:.9rem;margin-bottom:20px;}
.menu-stats{
    display:flex;gap:20px;justify-content:center;margin-bottom:24px;
    font-size:.85rem;color:var(--muted);
}
.menu-stats span{color:var(--gold);font-weight:700;}
.menu-btn{
    width:260px;padding:16px;border:none;border-radius:var(--radius);
    font-size:1.05rem;font-weight:700;cursor:pointer;
    transition:transform .2s,box-shadow .2s;
    display:flex;align-items:center;justify-content:center;gap:10px;
    color:#fff;
}
.menu-btn:hover{transform:scale(1.03);}
.menu-btn:active{transform:scale(.97);}
.btn-classic{background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 4px 20px rgba(102,126,234,.4);}
.btn-stage{background:linear-gradient(135deg,var(--green),#00aa66);box-shadow:0 4px 20px rgba(0,255,136,.3);}
.btn-daily{background:linear-gradient(135deg,var(--pink),#cc4477);box-shadow:0 4px 20px rgba(255,107,157,.3);}
.menu-bottom{display:flex;gap:12px;margin-top:16px;}
.menu-sm-btn{
    padding:10px 20px;border:1px solid var(--border);border-radius:var(--radius);
    background:var(--bg2);color:var(--muted);font-size:.85rem;cursor:pointer;
    transition:border-color .2s;
}
.menu-sm-btn:hover{border-color:var(--accent);color:var(--text);}

/* ===== GAME SCREEN ===== */
.game-screen{gap:8px;align-items:center;}
.game-top{
    width:100%;max-width:var(--grid-total);
    display:flex;justify-content:space-between;align-items:center;
    padding:4px 0;
}
.game-top-left{display:flex;gap:8px;align-items:center;}
.back-btn{
    width:36px;height:36px;border:1px solid var(--border);border-radius:8px;
    background:var(--bg2);color:var(--muted);font-size:1.1rem;cursor:pointer;
    display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.back-btn:hover{border-color:var(--accent);color:var(--text);}
.mode-label{
    font-size:.75rem;color:var(--accent);font-weight:600;
    padding:4px 10px;background:rgba(102,126,234,.15);border-radius:6px;
}
.score-area{display:flex;gap:8px;}
.score-box{
    text-align:center;padding:6px 14px;
    background:var(--bg2);border-radius:8px;min-width:70px;
}
.score-label{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.score-value{font-size:1.1rem;font-weight:800;color:var(--text);}

.game-info{
    width:100%;max-width:var(--grid-total);
    display:flex;justify-content:space-between;align-items:center;
    padding:4px 0;font-size:.8rem;
}
.combo-display{
    color:var(--gold);font-weight:700;
    transition:transform .2s;
}
.combo-display.pop{animation:comboPop .3s ease;}
@keyframes comboPop{0%{transform:scale(1);}50%{transform:scale(1.4);}100%{transform:scale(1);}}
.moves-display{color:var(--muted);}
.stage-goal{color:var(--green);font-weight:600;font-size:.78rem;}

/* ===== GRID ===== */
.grid-container{
    position:relative;
    width:var(--grid-total);height:var(--grid-total);
    background:var(--grid-bg);border-radius:var(--radius);
    border:2px solid var(--border);
    flex-shrink:0;
}
.grid-cell{
    position:absolute;
    width:var(--cell-size);height:var(--cell-size);
    background:var(--cell-bg);border-radius:8px;
}
.tile{
    position:absolute;
    width:var(--cell-size);height:var(--cell-size);
    border-radius:8px;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:1.6rem;
    transition:transform 130ms ease-in-out;
    z-index:2;
}
.tile-inner{
    display:flex;align-items:center;justify-content:center;
    width:100%;height:100%;border-radius:8px;
    transition:transform 100ms ease;
}
.tile-new .tile-inner{animation:tileAppear .2s ease;}
@keyframes tileAppear{0%{transform:scale(0);}60%{transform:scale(1.1);}100%{transform:scale(1);}}
.tile-merged .tile-inner{animation:tileMerge .25s ease;}
@keyframes tileMerge{0%{transform:scale(1);}40%{transform:scale(1.25);}100%{transform:scale(1);}}
.tile-remove{animation:tileRemove .2s ease forwards;z-index:1;}
@keyframes tileRemove{to{opacity:0;transform:scale(0);}}

.tile-frozen::after{
    content:'â„ï¸';position:absolute;top:-4px;right:-4px;font-size:.7rem;
    background:rgba(0,200,255,.8);border-radius:50%;width:18px;height:18px;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 8px rgba(0,200,255,.6);
}
.tile-stone{
    background:#333350!important;color:#666!important;
    box-shadow:none!important;
    border:2px dashed #555!important;
}
.tile-stone .tile-inner::after{content:'ğŸª¨';position:absolute;font-size:1.5rem;}

/* Tile Colors - Neon Theme */
.tile-2{background:linear-gradient(135deg,#0d1b3e,#1a2a5e);color:#00d4ff;box-shadow:0 0 12px rgba(0,212,255,.25);}
.tile-4{background:linear-gradient(135deg,#0d1b4e,#1a2a6e);color:#4d9fff;box-shadow:0 0 12px rgba(77,159,255,.25);}
.tile-8{background:linear-gradient(135deg,#1a0d3e,#2e1a5e);color:#bb86fc;box-shadow:0 0 15px rgba(187,134,252,.3);}
.tile-16{background:linear-gradient(135deg,#2e0d2e,#4a1a3e);color:#ff6b9d;box-shadow:0 0 15px rgba(255,107,157,.35);}
.tile-32{background:linear-gradient(135deg,#2e0d1a,#4a1a2a);color:#ff4444;box-shadow:0 0 18px rgba(255,68,68,.4);}
.tile-64{background:linear-gradient(135deg,#2e1a0d,#4a2a1a);color:#ff8800;box-shadow:0 0 18px rgba(255,136,0,.4);}
.tile-128{background:linear-gradient(135deg,#2e2e0d,#4a4a1a);color:#ffd700;box-shadow:0 0 22px rgba(255,215,0,.45);font-size:1.4rem;}
.tile-256{background:linear-gradient(135deg,#0d2e1a,#1a4a2a);color:#00ff88;box-shadow:0 0 22px rgba(0,255,136,.45);font-size:1.4rem;}
.tile-512{background:linear-gradient(135deg,#0d2e2e,#1a4a4a);color:#00ffcc;box-shadow:0 0 25px rgba(0,255,204,.5);font-size:1.4rem;}
.tile-1024{background:linear-gradient(135deg,#2e0d2e,#5a1a5a);color:#ff00ff;box-shadow:0 0 28px rgba(255,0,255,.5);font-size:1.2rem;}
.tile-2048{background:linear-gradient(135deg,#ffd700,#ff8800);color:#fff;box-shadow:0 0 35px rgba(255,215,0,.7);font-size:1.2rem;animation:glow2048 1.5s ease-in-out infinite;}
@keyframes glow2048{0%,100%{box-shadow:0 0 35px rgba(255,215,0,.7);}50%{box-shadow:0 0 50px rgba(255,215,0,1);}}
.tile-4096{background:linear-gradient(135deg,#ff0080,#7b2ff7,#00d4ff);color:#fff;box-shadow:0 0 35px rgba(255,0,128,.5);font-size:1.1rem;}
.tile-8192{background:linear-gradient(135deg,#00ff88,#00d4ff,#ff6b9d);color:#fff;box-shadow:0 0 40px rgba(0,255,136,.5);font-size:1.1rem;}
.tile-super{background:linear-gradient(135deg,#ff0000,#ff8800,#ffd700,#00ff88,#00d4ff,#8800ff);color:#fff;box-shadow:0 0 40px rgba(255,255,255,.5);font-size:1rem;animation:rainbow 2s linear infinite;}
@keyframes rainbow{0%{filter:hue-rotate(0deg);}100%{filter:hue-rotate(360deg);}}

/* ===== POWER-UPS BAR ===== */
.powerup-bar{
    width:100%;max-width:var(--grid-total);
    display:flex;gap:6px;justify-content:center;
    padding:8px 0;
}
.pu-btn{
    flex:1;max-width:68px;padding:8px 4px;
    background:var(--bg2);border:1px solid var(--border);border-radius:10px;
    cursor:pointer;text-align:center;transition:all .2s;
    display:flex;flex-direction:column;align-items:center;gap:2px;
}
.pu-btn:hover:not(.disabled){border-color:var(--accent);background:var(--bg3);}
.pu-btn.active{border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,.4);background:rgba(255,215,0,.1);}
.pu-btn.disabled{opacity:.35;cursor:default;}
.pu-icon{font-size:1.3rem;}
.pu-count{font-size:.65rem;color:var(--muted);font-weight:600;}
.pu-name{font-size:.55rem;color:var(--dim);white-space:nowrap;}

.target-hint{
    width:100%;max-width:var(--grid-total);text-align:center;
    color:var(--gold);font-size:.85rem;font-weight:600;
    padding:6px;animation:pulse2 1s infinite;
}
@keyframes pulse2{0%,100%{opacity:1;}50%{opacity:.5;}}

/* ===== DIALOGS ===== */
.overlay{
    position:absolute;inset:0;background:rgba(0,0,0,.75);
    display:flex;align-items:center;justify-content:center;
    z-index:100;opacity:0;pointer-events:none;transition:opacity .3s;
    backdrop-filter:blur(4px);
}
.overlay.show{opacity:1;pointer-events:auto;}
.dialog{
    background:var(--bg2);border:1px solid var(--border);border-radius:16px;
    padding:30px;text-align:center;max-width:320px;width:90%;
    transform:scale(.9);transition:transform .3s;
}
.overlay.show .dialog{transform:scale(1);}
.dialog-icon{font-size:3rem;margin-bottom:12px;}
.dialog-title{font-size:1.4rem;font-weight:800;margin-bottom:8px;}
.dialog-text{color:var(--muted);font-size:.9rem;margin-bottom:20px;line-height:1.5;}
.dialog-score{font-size:2rem;font-weight:900;color:var(--gold);margin-bottom:16px;}
.dialog-btns{display:flex;flex-direction:column;gap:10px;}
.dlg-btn{
    padding:14px;border:none;border-radius:var(--radius);
    font-size:1rem;font-weight:700;cursor:pointer;color:#fff;
    transition:transform .2s;
}
.dlg-btn:active{transform:scale(.95);}
.dlg-btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));}
.dlg-btn-secondary{background:var(--bg3);border:1px solid var(--border);color:var(--muted);}
.dlg-btn-gold{background:linear-gradient(135deg,var(--gold),#ff8800);}

/* ===== STAGE SELECT ===== */
.stage-screen{gap:12px;align-items:center;}
.stage-title{font-size:1.3rem;font-weight:800;margin-bottom:8px;}
.stage-grid{
    display:grid;grid-template-columns:repeat(5,1fr);gap:8px;
    width:100%;max-width:var(--grid-total);
}
.stage-cell{
    aspect-ratio:1;border-radius:10px;
    background:var(--bg2);border:1px solid var(--border);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    cursor:pointer;transition:all .2s;font-size:.9rem;font-weight:700;
}
.stage-cell:hover{border-color:var(--accent);transform:scale(1.05);}
.stage-cell.locked{opacity:.4;cursor:default;}
.stage-cell.locked:hover{border-color:var(--border);transform:none;}
.stage-cell.cleared{border-color:var(--green);color:var(--green);}
.stage-cell .stars{font-size:.6rem;margin-top:2px;}

/* ===== SETTINGS ===== */
.settings-screen{gap:16px;align-items:center;}
.settings-title{font-size:1.3rem;font-weight:800;margin-bottom:4px;}
.setting-group{
    width:100%;max-width:var(--grid-total);
    background:var(--bg2);border-radius:var(--radius);padding:16px;
}
.setting-label{font-size:.85rem;color:var(--muted);margin-bottom:10px;}
.setting-options{display:flex;gap:8px;flex-wrap:wrap;}
.setting-opt{
    padding:8px 16px;border:1px solid var(--border);border-radius:8px;
    background:var(--bg3);color:var(--muted);font-size:.85rem;cursor:pointer;transition:all .2s;
}
.setting-opt:hover{border-color:var(--accent);}
.setting-opt.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600;}

/* ===== POWER-UP GAINED TOAST ===== */
.toast{
    position:absolute;top:40%;left:50%;transform:translate(-50%,-50%) scale(0);
    background:rgba(0,0,0,.9);border:2px solid var(--gold);border-radius:16px;
    padding:20px 30px;text-align:center;z-index:200;
    transition:transform .3s cubic-bezier(.34,1.56,.64,1);
    box-shadow:0 0 40px rgba(255,215,0,.3);
}
.toast.show{transform:translate(-50%,-50%) scale(1);}
.toast-icon{font-size:2.5rem;margin-bottom:6px;}
.toast-text{font-size:1rem;font-weight:700;color:var(--gold);}

/* ===== RESPONSIVE ===== */
@media(max-width:400px){
    :root{--cell-size:65px;--grid-gap:8px;}
    .tile{font-size:1.3rem;}
    .tile-128,.tile-256,.tile-512{font-size:1.15rem;}
    .tile-1024,.tile-2048,.tile-4096,.tile-8192{font-size:1rem;}
    .menu-title{font-size:2rem;}
    .menu-btn{width:220px;padding:13px;font-size:.95rem;}
}
@media(max-width:340px){
    :root{--cell-size:58px;--grid-gap:7px;}
    .tile{font-size:1.15rem;}
}
@media(min-height:800px){
    .game-screen{gap:12px;}
}

/* ===== BOMB EXPLOSION ===== */
.bomb-fx{
    position:absolute;border-radius:50%;
    background:radial-gradient(circle,rgba(255,100,0,.8),rgba(255,50,0,.4),transparent);
    animation:bombExplode .5s ease-out forwards;z-index:50;pointer-events:none;
}
@keyframes bombExplode{
    0%{transform:scale(0);opacity:1;}
    60%{transform:scale(2.5);opacity:.8;}
    100%{transform:scale(3.5);opacity:0;}
}
</style>
    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/games/tg-sdk-wrapper.js?v=1769736738"></script>
</head>
<body>
<div id="app">
<!-- Menu Screen -->
<div class="screen menu-screen" id="menuScreen">
    <div class="menu-title" id="menuTitle">âš¡ POWER 2048 âš¡</div>
    <div class="menu-sub" id="menuSub"></div>
    <div class="menu-stats">
        <div id="menuBest"></div>
        <div id="menuLevel"></div>
    </div>
    <button class="menu-btn btn-classic" onclick="G.startGame('classic')"><span>â–¶</span><span id="btnClassic"></span></button>
    <button class="menu-btn btn-stage" onclick="G.showStages()"><span>ğŸ“‹</span><span id="btnStage"></span></button>
    <button class="menu-btn btn-daily" onclick="G.startGame('daily')"><span>ğŸ“…</span><span id="btnDaily"></span></button>
    <div class="menu-bottom">
        <button class="menu-sm-btn" onclick="G.showSettings()">âš™ <span id="btnSettings"></span></button>
        <button class="menu-sm-btn" onclick="G.showHelp()">â“ <span id="btnHelp"></span></button>
    </div>
</div>

<!-- Game Screen -->
<div class="screen game-screen hidden" id="gameScreen">
    <div class="game-top">
        <div class="game-top-left">
            <button class="back-btn" onclick="G.backToMenu()">â†</button>
            <div class="mode-label" id="modeLabel"></div>
        </div>
        <div class="score-area">
            <div class="score-box"><div class="score-label" id="scoreLbl"></div><div class="score-value" id="scoreVal">0</div></div>
            <div class="score-box"><div class="score-label" id="bestLbl"></div><div class="score-value" id="bestVal">0</div></div>
        </div>
    </div>
    <div class="game-info">
        <div class="combo-display" id="comboDisplay"></div>
        <div id="stageGoal" class="stage-goal"></div>
        <div class="moves-display" id="movesDisplay"></div>
    </div>
    <div class="grid-container" id="gridContainer"></div>
    <div class="target-hint hidden" id="targetHint"></div>
    <div class="powerup-bar" id="powerupBar"></div>
</div>

<!-- Stage Select -->
<div class="screen stage-screen hidden" id="stageScreen">
    <div class="game-top" style="max-width:var(--grid-total);">
        <button class="back-btn" onclick="G.showScreen('menu')">â†</button>
        <div class="stage-title" id="stageTitle"></div>
        <div></div>
    </div>
    <div class="stage-grid" id="stageGrid"></div>
</div>

<!-- Settings -->
<div class="screen settings-screen hidden" id="settingsScreen">
    <div class="game-top" style="max-width:var(--grid-total);">
        <button class="back-btn" onclick="G.showScreen('menu')">â†</button>
        <div class="settings-title" id="settingsTitle"></div>
        <div></div>
    </div>
    <div class="setting-group">
        <div class="setting-label" id="langLabel"></div>
        <div class="setting-options" id="langOptions"></div>
    </div>
</div>

<!-- Help -->
<div class="screen settings-screen hidden" id="helpScreen">
    <div class="game-top" style="max-width:var(--grid-total);">
        <button class="back-btn" onclick="G.showScreen('menu')">â†</button>
        <div class="settings-title" id="helpTitle"></div>
        <div></div>
    </div>
    <div class="setting-group" id="helpContent" style="line-height:1.8;font-size:.88rem;color:var(--muted);"></div>
</div>

<!-- Overlays -->
<div class="overlay" id="gameOverOverlay">
    <div class="dialog">
        <div class="dialog-icon" id="goIcon">ğŸ˜µ</div>
        <div class="dialog-title" id="goTitle"></div>
        <div class="dialog-score" id="goScore"></div>
        <div class="dialog-text" id="goText"></div>
        <div class="dialog-btns">
            <button class="dlg-btn dlg-btn-primary" id="goRetry" onclick="G.retryGame()"></button>
            <button class="dlg-btn dlg-btn-secondary" onclick="G.backToMenu()"></button>
        </div>
    </div>
</div>
<div class="overlay" id="winOverlay">
    <div class="dialog">
        <div class="dialog-icon">ğŸ‰</div>
        <div class="dialog-title" id="winTitle"></div>
        <div class="dialog-score" id="winScore"></div>
        <div class="dialog-btns">
            <button class="dlg-btn dlg-btn-gold" id="winContinue" onclick="G.continueAfterWin()"></button>
            <button class="dlg-btn dlg-btn-secondary" onclick="G.backToMenu()"></button>
        </div>
    </div>
</div>
<div class="overlay" id="stageClearOverlay">
    <div class="dialog">
        <div class="dialog-icon">â­</div>
        <div class="dialog-title" id="scTitle"></div>
        <div class="dialog-text" id="scText"></div>
        <div class="dialog-btns">
            <button class="dlg-btn dlg-btn-gold" id="scNext" onclick="G.nextStage()"></button>
            <button class="dlg-btn dlg-btn-secondary" onclick="G.backToMenu()"></button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><div class="toast-icon" id="toastIcon"></div><div class="toast-text" id="toastText"></div></div>
</div>

<script>
// ==================== I18N ====================
const I18N = {
en: {
    title:'âš¡ POWER 2048 âš¡',sub:'Classic 2048 + Power-ups!',
    classic:'Classic Mode',stage:'Stage Mode',daily:'Daily Challenge',
    settings:'Settings',help:'Help',
    score:'SCORE',best:'BEST',moves:'Moves',level:'Level',combo:'Combo',
    newGame:'New Game',gameOver:'Game Over!',youWin:'You Win! ğŸ‰',
    continue_:'Continue',tryAgain:'Try Again',backMenu:'Main Menu',
    bomb:'Bomb',freeze:'Freeze',double:'Double',undo:'Undo',sniper:'Sniper',
    selectTarget:'ğŸ‘† Tap a tile to use power-up',cancel:'(tap again to cancel)',
    stageCleared:'Stage Cleared! â­',nextStage:'Next Stage',
    goal:'Goal',reach:'Reach',within:'within',movesLeft:'moves left',
    language:'Language',stageSelect:'Stage Select',
    bestScore:'Best: ',stageLevel:'Stage: ',
    goalTile:'Create a {n} tile',goalScore:'Score {n} points',
    goalTileMoves:'Create {n} in {m} moves',goalScoreMoves:'Score {n} in {m} moves',
    helpContent:`<b>ğŸ® How to Play</b><br>Swipe or use arrow keys to move tiles.<br>Same numbers merge into one!<br><br><b>ğŸ”¥ Power-ups</b><br>ğŸ’£ <b>Bomb</b> â€” Remove tile + neighbors<br>â„ï¸ <b>Freeze</b> â€” Lock tile for 3 turns<br>âš¡ <b>Double</b> â€” Next merge = 4Ã— value<br>ğŸ”„ <b>Undo</b> â€” Revert last move<br>ğŸ¯ <b>Sniper</b> â€” Remove single tile<br><br><b>ğŸ’¥ Combo</b><br>3 merges in a row = free power-up!<br><br><b>ğŸ“‹ Modes</b><br>Classic: Chase high score<br>Stage: Clear objectives<br>Daily: Same puzzle for everyone`,
    dailyBest:'Today\'s Best: ',
    noMoves:'No moves left!',stoneBlock:'Stone block',
},
ko: {
    title:'âš¡ POWER 2048 âš¡',sub:'í´ë˜ì‹ 2048 + íŒŒì›Œì—…!',
    classic:'í´ë˜ì‹ ëª¨ë“œ',stage:'ìŠ¤í…Œì´ì§€ ëª¨ë“œ',daily:'ì¼ì¼ ì±Œë¦°ì§€',
    settings:'ì„¤ì •',help:'ë„ì›€ë§',
    score:'ì ìˆ˜',best:'ìµœê³ ',moves:'ì´ë™',level:'ë ˆë²¨',combo:'ì½¤ë³´',
    newGame:'ìƒˆ ê²Œì„',gameOver:'ê²Œì„ ì˜¤ë²„!',youWin:'ìŠ¹ë¦¬! ğŸ‰',
    continue_:'ê³„ì†í•˜ê¸°',tryAgain:'ë‹¤ì‹œ ë„ì „',backMenu:'ë©”ì¸ ë©”ë‰´',
    bomb:'í­íƒ„',freeze:'ë™ê²°',double:'ë”ë¸”',undo:'ë˜ëŒë¦¬ê¸°',sniper:'ìŠ¤ë‚˜ì´í¼',
    selectTarget:'ğŸ‘† íƒ€ì¼ì„ íƒ­í•˜ì—¬ íŒŒì›Œì—… ì‚¬ìš©',cancel:'(ë‹¤ì‹œ íƒ­í•˜ë©´ ì·¨ì†Œ)',
    stageCleared:'ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! â­',nextStage:'ë‹¤ìŒ ìŠ¤í…Œì´ì§€',
    goal:'ëª©í‘œ',reach:'ë‹¬ì„±',within:'ì´ë‚´',movesLeft:'ë‚¨ì€ ì´ë™',
    language:'ì–¸ì–´',stageSelect:'ìŠ¤í…Œì´ì§€ ì„ íƒ',
    bestScore:'ìµœê³ : ',stageLevel:'ìŠ¤í…Œì´ì§€: ',
    goalTile:'{n} íƒ€ì¼ ë§Œë“¤ê¸°',goalScore:'{n}ì  ë‹¬ì„±',
    goalTileMoves:'{m}ìˆ˜ ì•ˆì— {n} ë§Œë“¤ê¸°',goalScoreMoves:'{m}ìˆ˜ ì•ˆì— {n}ì  ë‹¬ì„±',
    helpContent:`<b>ğŸ® í”Œë ˆì´ ë°©ë²•</b><br>ìŠ¤ì™€ì´í”„ ë˜ëŠ” í™”ì‚´í‘œ í‚¤ë¡œ íƒ€ì¼ì„ ì´ë™í•˜ì„¸ìš”.<br>ê°™ì€ ìˆ«ìê°€ ë§Œë‚˜ë©´ í•©ì³ì§‘ë‹ˆë‹¤!<br><br><b>ğŸ”¥ íŒŒì›Œì—…</b><br>ğŸ’£ <b>í­íƒ„</b> â€” íƒ€ì¼ + ì£¼ë³€ ì œê±°<br>â„ï¸ <b>ë™ê²°</b> â€” 3í„´ê°„ ê³ ì •<br>âš¡ <b>ë”ë¸”</b> â€” ë‹¤ìŒ í•©ì¹˜ê¸° 4ë°°<br>ğŸ”„ <b>ë˜ëŒë¦¬ê¸°</b> â€” ë§ˆì§€ë§‰ ìˆ˜ ì·¨ì†Œ<br>ğŸ¯ <b>ìŠ¤ë‚˜ì´í¼</b> â€” ë‹¨ì¼ íƒ€ì¼ ì œê±°<br><br><b>ğŸ’¥ ì½¤ë³´</b><br>3ì—°ì† í•©ì¹˜ê¸° = ë¬´ë£Œ íŒŒì›Œì—…!<br><br><b>ğŸ“‹ ëª¨ë“œ</b><br>í´ë˜ì‹: ìµœê³ ì ìˆ˜ ë„ì „<br>ìŠ¤í…Œì´ì§€: ëª©í‘œ ë‹¬ì„±<br>ì¼ì¼: ëª¨ë‘ ê°™ì€ í¼ì¦`,
    dailyBest:'ì˜¤ëŠ˜ ìµœê³ : ',
    noMoves:'ì´ë™ íšŸìˆ˜ ì†Œì§„!',stoneBlock:'ëŒ',
},
ja: {
    title:'âš¡ POWER 2048 âš¡',sub:'ã‚¯ãƒ©ã‚·ãƒƒã‚¯2048 + ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼',
    classic:'ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰',stage:'ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰',daily:'ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
    settings:'è¨­å®š',help:'ãƒ˜ãƒ«ãƒ—',
    score:'ã‚¹ã‚³ã‚¢',best:'ãƒ™ã‚¹ãƒˆ',moves:'ç§»å‹•',level:'ãƒ¬ãƒ™ãƒ«',combo:'ã‚³ãƒ³ãƒœ',
    newGame:'æ–°ã—ã„ã‚²ãƒ¼ãƒ ',gameOver:'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼',youWin:'å‹åˆ©ï¼ğŸ‰',
    continue_:'ç¶šã‘ã‚‹',tryAgain:'ãƒªãƒˆãƒ©ã‚¤',backMenu:'ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼',
    bomb:'ãƒœãƒ ',freeze:'ãƒ•ãƒªãƒ¼ã‚º',double:'ãƒ€ãƒ–ãƒ«',undo:'ã‚¢ãƒ³ãƒ‰ã‚¥',sniper:'ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼',
    selectTarget:'ğŸ‘† ã‚¿ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ä½¿ç”¨',cancel:'(ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«)',
    stageCleared:'ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼â­',nextStage:'æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸',
    goal:'ç›®æ¨™',reach:'é”æˆ',within:'ä»¥å†…',movesLeft:'æ®‹ã‚Šç§»å‹•',
    language:'è¨€èª',stageSelect:'ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ',
    bestScore:'ãƒ™ã‚¹ãƒˆ: ',stageLevel:'ã‚¹ãƒ†ãƒ¼ã‚¸: ',
    goalTile:'{n}ã‚¿ã‚¤ãƒ«ã‚’ä½œã‚‹',goalScore:'{n}ç‚¹ã‚’é”æˆ',
    goalTileMoves:'{m}æ‰‹ä»¥å†…ã«{n}ã‚’ä½œã‚‹',goalScoreMoves:'{m}æ‰‹ä»¥å†…ã«{n}ç‚¹é”æˆ',
    helpContent:`<b>ğŸ® éŠã³æ–¹</b><br>ã‚¹ãƒ¯ã‚¤ãƒ—ã¾ãŸã¯çŸ¢å°ã‚­ãƒ¼ã§ã‚¿ã‚¤ãƒ«ã‚’ç§»å‹•ã€‚<br>åŒã˜æ•°å­—ãŒåˆä½“ã—ã¾ã™ï¼<br><br><b>ğŸ”¥ ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—</b><br>ğŸ’£ <b>ãƒœãƒ </b> â€” ã‚¿ã‚¤ãƒ«+å‘¨å›²ã‚’é™¤å»<br>â„ï¸ <b>ãƒ•ãƒªãƒ¼ã‚º</b> â€” 3ã‚¿ãƒ¼ãƒ³å›ºå®š<br>âš¡ <b>ãƒ€ãƒ–ãƒ«</b> â€” æ¬¡ã®åˆä½“4å€<br>ğŸ”„ <b>ã‚¢ãƒ³ãƒ‰ã‚¥</b> â€” 1æ‰‹æˆ»ã™<br>ğŸ¯ <b>ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼</b> â€” 1ã‚¿ã‚¤ãƒ«é™¤å»<br><br><b>ğŸ’¥ ã‚³ãƒ³ãƒœ</b><br>3é€£ç¶šåˆä½“=ç„¡æ–™ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ï¼`,
    dailyBest:'ä»Šæ—¥ã®ãƒ™ã‚¹ãƒˆ: ',
    noMoves:'ç§»å‹•å›æ•°åˆ‡ã‚Œï¼',stoneBlock:'çŸ³',
},
zh: {
    title:'âš¡ POWER 2048 âš¡',sub:'ç»å…¸2048 + è¶…èƒ½åŠ›ï¼',
    classic:'ç»å…¸æ¨¡å¼',stage:'å…³å¡æ¨¡å¼',daily:'æ¯æ—¥æŒ‘æˆ˜',
    settings:'è®¾ç½®',help:'å¸®åŠ©',
    score:'åˆ†æ•°',best:'æœ€ä½³',moves:'æ­¥æ•°',level:'å…³å¡',combo:'è¿å‡»',
    newGame:'æ–°æ¸¸æˆ',gameOver:'æ¸¸æˆç»“æŸï¼',youWin:'èƒœåˆ©ï¼ğŸ‰',
    continue_:'ç»§ç»­',tryAgain:'é‡è¯•',backMenu:'ä¸»èœå•',
    bomb:'ç‚¸å¼¹',freeze:'å†°å†»',double:'åŒå€',undo:'æ’¤é”€',sniper:'ç‹™å‡»',
    selectTarget:'ğŸ‘† ç‚¹å‡»æ–¹å—ä½¿ç”¨èƒ½åŠ›',cancel:'(å†æ¬¡ç‚¹å‡»å–æ¶ˆ)',
    stageCleared:'å…³å¡é€šå…³ï¼â­',nextStage:'ä¸‹ä¸€å…³',
    goal:'ç›®æ ‡',reach:'è¾¾æˆ',within:'ä»¥å†…',movesLeft:'å‰©ä½™æ­¥æ•°',
    language:'è¯­è¨€',stageSelect:'å…³å¡é€‰æ‹©',
    bestScore:'æœ€ä½³: ',stageLevel:'å…³å¡: ',
    goalTile:'åˆ›å»º {n} æ–¹å—',goalScore:'è·å¾— {n} åˆ†',
    goalTileMoves:'{m}æ­¥å†…åˆ›å»º{n}',goalScoreMoves:'{m}æ­¥å†…è·å¾—{n}åˆ†',
    helpContent:`<b>ğŸ® ç©æ³•</b><br>æ»‘åŠ¨æˆ–æ–¹å‘é”®ç§»åŠ¨æ–¹å—ã€‚<br>ç›¸åŒæ•°å­—åˆå¹¶ï¼<br><br><b>ğŸ”¥ è¶…èƒ½åŠ›</b><br>ğŸ’£ <b>ç‚¸å¼¹</b> â€” æ¶ˆé™¤æ–¹å—+å‘¨å›´<br>â„ï¸ <b>å†°å†»</b> â€” å›ºå®š3å›åˆ<br>âš¡ <b>åŒå€</b> â€” ä¸‹æ¬¡åˆå¹¶4å€<br>ğŸ”„ <b>æ’¤é”€</b> â€” æ’¤å›ä¸€æ­¥<br>ğŸ¯ <b>ç‹™å‡»</b> â€” æ¶ˆé™¤å•ä¸ª<br><br><b>ğŸ’¥ è¿å‡»</b><br>è¿ç»­3æ¬¡åˆå¹¶=å…è´¹è¶…èƒ½åŠ›ï¼`,
    dailyBest:'ä»Šæ—¥æœ€ä½³: ',
    noMoves:'æ­¥æ•°ç”¨å®Œï¼',stoneBlock:'çŸ³å¤´',
}
};

// ==================== CONSTANTS ====================
const STAGES = [
    {level:1,goalType:'tile',goalValue:128,moves:null,stones:0,pu:{undo:2}},
    {level:2,goalType:'tile',goalValue:128,moves:50,stones:0,pu:{undo:2}},
    {level:3,goalType:'tile',goalValue:256,moves:null,stones:0,pu:{undo:2}},
    {level:4,goalType:'score',goalValue:3000,moves:40,stones:0,pu:{undo:2}},
    {level:5,goalType:'tile',goalValue:256,moves:40,stones:0,pu:{undo:2,bomb:1}},
    {level:6,goalType:'tile',goalValue:512,moves:null,stones:0,pu:{undo:1,bomb:1}},
    {level:7,goalType:'score',goalValue:5000,moves:35,stones:0,pu:{bomb:1,double:1}},
    {level:8,goalType:'tile',goalValue:512,moves:45,stones:1,pu:{undo:1,bomb:1}},
    {level:9,goalType:'tile',goalValue:512,moves:35,stones:1,pu:{bomb:1,sniper:1}},
    {level:10,goalType:'score',goalValue:8000,moves:40,stones:1,pu:{undo:1,bomb:1,double:1}},
    {level:11,goalType:'tile',goalValue:1024,moves:null,stones:1,pu:{bomb:1}},
    {level:12,goalType:'tile',goalValue:1024,moves:50,stones:1,pu:{bomb:1,freeze:1}},
    {level:13,goalType:'score',goalValue:12000,moves:40,stones:2,pu:{bomb:2,double:1}},
    {level:14,goalType:'tile',goalValue:1024,moves:40,stones:2,pu:{bomb:1,sniper:1,undo:1}},
    {level:15,goalType:'tile',goalValue:2048,moves:null,stones:2,pu:{bomb:2,freeze:1,double:1,undo:2,sniper:1}},
];

const POWERUP_TYPES = ['bomb','freeze','double','undo','sniper'];
const PU_ICONS = {bomb:'ğŸ’£',freeze:'â„ï¸',double:'âš¡',undo:'ğŸ”„',sniper:'ğŸ¯'};
const BALANCE = {
    newTile4Chance: 0.1,
    comboThreshold: 3,
    puDropRate: 0.5,
    maxPU: {bomb:3,freeze:2,double:2,undo:3,sniper:2},
};

// ==================== SEEDED RANDOM ====================
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;var t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296;};}
function dailySeed(){const d=new Date().toISOString().slice(0,10);let h=0;for(let i=0;i<d.length;i++){h=((h<<5)-h)+d.charCodeAt(i);h&=h;}return Math.abs(h)||1;}

// ==================== SOUND (Web Audio) ====================
const SND = {
    ctx: null,
    init(){if(!this.ctx)try{this.ctx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}},
    play(freq,dur=.1,type='sine',vol=.15){
        if(!this.ctx)return;
        try{
            const o=this.ctx.createOscillator(),g=this.ctx.createGain();
            o.type=type;o.frequency.value=freq;
            g.gain.setValueAtTime(vol,this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(.001,this.ctx.currentTime+dur);
            o.connect(g);g.connect(this.ctx.destination);
            o.start();o.stop(this.ctx.currentTime+dur);
        }catch(e){}
    },
    merge(val){const f=200+Math.min(val,2048)/2048*600;this.play(f,.15,'triangle',.12);},
    powerup(){this.play(600,.05);setTimeout(()=>this.play(800,.05),60);setTimeout(()=>this.play(1000,.1),120);},
    bomb(){this.play(100,.3,'sawtooth',.2);},
    gameover(){this.play(300,.15);setTimeout(()=>this.play(200,.2),150);},
    win(){this.play(400,.1);setTimeout(()=>this.play(500,.1),100);setTimeout(()=>this.play(600,.1),200);setTimeout(()=>this.play(800,.2),300);},
};

// ==================== MAIN GAME ====================
const G = {
    lang: 'en',
    grid: [],         // 4Ã—4 of {value,frozen,isStone,id} or null
    score: 0,
    bestScore: 0,
    moveCount: 0,
    combo: 0,
    mode: 'classic',  // classic | stage | daily
    stageLevel: 1,
    powerUps: {bomb:0,freeze:0,double:0,undo:0,sniper:0},
    doubleActive: false,
    history: null,     // for undo
    won2048: false,
    gameActive: false,
    targeting: null,   // null or 'bomb'|'freeze'|'sniper'
    nextTileId: 1,
    tileElements: {},  // id â†’ DOM element
    dailyRng: null,
    stageCleared: {},  // {levelNum: stars}
    animating: false,

    // ===== INIT =====
    init(){
        this.loadData();
        this.updateI18N();
        this.showScreen('menu');
        this.setupInput();
        this.buildGridCells();
    },

    // ===== i18n =====
    t(key){return (I18N[this.lang]||I18N.en)[key]||(I18N.en[key]||key);},
    updateI18N(){
        const t=k=>this.t(k);
        document.getElementById('menuTitle').textContent=t('title');
        document.getElementById('menuSub').textContent=t('sub');
        document.getElementById('menuBest').innerHTML=t('bestScore')+'<span>'+this.bestScore.toLocaleString()+'</span>';
        document.getElementById('menuLevel').innerHTML=t('stageLevel')+'<span>'+this.getMaxStage()+'</span>';
        document.getElementById('btnClassic').textContent=t('classic');
        document.getElementById('btnStage').textContent=t('stage');
        document.getElementById('btnDaily').textContent=t('daily');
        document.getElementById('btnSettings').textContent=t('settings');
        document.getElementById('btnHelp').textContent=t('help');
        // Dialog buttons
        document.querySelectorAll('.dlg-btn-secondary').forEach(b=>b.textContent=t('backMenu'));
        document.getElementById('goRetry').textContent=t('tryAgain');
        document.getElementById('winContinue').textContent=t('continue_');
        document.getElementById('scNext').textContent=t('nextStage');
    },

    // ===== SCREEN MANAGEMENT =====
    showScreen(name){
        document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
        const el=document.getElementById(name+'Screen');
        if(el)el.classList.remove('hidden');
        this.hideAllOverlays();
        if(name==='menu')this.updateI18N();
    },
    hideAllOverlays(){
        document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('show'));
    },
    showOverlay(id){document.getElementById(id).classList.add('show');},

    // ===== SAVE / LOAD =====
    loadData(){
        try{
            const d=JSON.parse(localStorage.getItem('power2048')||'{}');
            this.lang=d.lang||this.detectLang();
            this.bestScore=d.bestScore||0;
            this.stageCleared=d.stageCleared||{};
        }catch(e){this.lang=this.detectLang();}
    },
    saveData(){
        try{
            localStorage.setItem('power2048',JSON.stringify({
                lang:this.lang,bestScore:this.bestScore,stageCleared:this.stageCleared
            }));
        }catch(e){}
    },
    saveDailyBest(score){
        try{
            const key='power2048_daily_'+new Date().toISOString().slice(0,10);
            const prev=parseInt(localStorage.getItem(key))||0;
            if(score>prev)localStorage.setItem(key,score);
        }catch(e){}
    },
    getDailyBest(){
        try{
            const key='power2048_daily_'+new Date().toISOString().slice(0,10);
            return parseInt(localStorage.getItem(key))||0;
        }catch(e){return 0;}
    },
    detectLang(){
        const l=(navigator.language||'en').slice(0,2).toLowerCase();
        return I18N[l]?l:'en';
    },
    getMaxStage(){
        let max=0;
        for(const k in this.stageCleared)if(parseInt(k)>max)max=parseInt(k);
        return max||0;
    },

    // ===== BUILD GRID CELLS =====
    buildGridCells(){
        const gc=document.getElementById('gridContainer');
        gc.innerHTML='';
        const cs=this.getCellSize();
        const gap=this.getGap();
        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
            const cell=document.createElement('div');
            cell.className='grid-cell';
            cell.style.left=(c*(cs+gap)+gap)+'px';
            cell.style.top=(r*(cs+gap)+gap)+'px';
            cell.style.width=cs+'px';cell.style.height=cs+'px';
            cell.dataset.row=r;cell.dataset.col=c;
            gc.appendChild(cell);
        }
    },
    getCellSize(){
        const s=getComputedStyle(document.documentElement);
        return parseFloat(s.getPropertyValue('--cell-size'));
    },
    getGap(){
        const s=getComputedStyle(document.documentElement);
        return parseFloat(s.getPropertyValue('--grid-gap'));
    },

    // ===== START GAME =====
    startGame(mode, stageLevel){
        SND.init();
        this.mode=mode;
        this.score=0;this.moveCount=0;this.combo=0;
        this.won2048=false;this.gameActive=true;
        this.targeting=null;this.doubleActive=false;
        this.history=null;this.nextTileId=1;
        this.tileElements={};
        this.animating=false;

        // Clear grid DOM
        const gc=document.getElementById('gridContainer');
        gc.querySelectorAll('.tile').forEach(t=>t.remove());

        // Init grid
        this.grid=Array.from({length:4},()=>Array(4).fill(null));

        if(mode==='classic'){
            this.powerUps={bomb:1,freeze:0,double:0,undo:1,sniper:0};
            this.addRandomTile();this.addRandomTile();
        }else if(mode==='stage'){
            this.stageLevel=stageLevel||1;
            const st=STAGES[this.stageLevel-1]||STAGES[STAGES.length-1];
            this.powerUps={bomb:0,freeze:0,double:0,undo:0,sniper:0};
            for(const k in st.pu)this.powerUps[k]=st.pu[k];
            // Place stone tiles
            if(st.stones>0)this.placeStones(st.stones);
            this.addRandomTile();this.addRandomTile();
        }else if(mode==='daily'){
            this.powerUps={bomb:1,freeze:0,double:1,undo:2,sniper:0};
            this.dailyRng=mulberry32(dailySeed());
            this.addRandomTile(this.dailyRng);this.addRandomTile(this.dailyRng);
        }

        this.showScreen('game');
        this.updateGameUI();
        this.renderPowerUps();
    },

    // ===== GRID OPERATIONS =====
    addRandomTile(rng){
        const empty=[];
        for(let r=0;r<4;r++)for(let c=0;c<4;c++)
            if(!this.grid[r][c])empty.push({r,c});
        if(!empty.length)return null;
        const rand=rng?rng:Math.random;
        const pos=empty[Math.floor(rand()*empty.length)];
        const value=(rand()<BALANCE.newTile4Chance)?4:2;
        return this.createTile(value,pos.r,pos.c,true);
    },

    createTile(value,row,col,animate){
        const id=this.nextTileId++;
        const tile={id,value,frozen:0,isStone:false};
        this.grid[row][col]=tile;

        const el=document.createElement('div');
        const cs=this.getCellSize(),gap=this.getGap();
        el.className='tile '+this.tileClass(value);
        el.style.width=cs+'px';el.style.height=cs+'px';
        el.style.transform=`translate(${col*(cs+gap)+gap}px,${row*(cs+gap)+gap}px)`;
        el.innerHTML=`<div class="tile-inner">${value}</div>`;
        el.dataset.id=id;
        if(animate)el.classList.add('tile-new');


        document.getElementById('gridContainer').appendChild(el);
        this.tileElements[id]=el;
        return tile;
    },

    createStoneTile(row,col){
        const id=this.nextTileId++;
        const tile={id,value:0,frozen:0,isStone:true};
        this.grid[row][col]=tile;

        const el=document.createElement('div');
        const cs=this.getCellSize(),gap=this.getGap();
        el.className='tile tile-stone';
        el.style.width=cs+'px';el.style.height=cs+'px';
        el.style.transform=`translate(${col*(cs+gap)+gap}px,${row*(cs+gap)+gap}px)`;
        el.innerHTML=`<div class="tile-inner"></div>`;
        el.dataset.id=id;

        document.getElementById('gridContainer').appendChild(el);
        this.tileElements[id]=el;
        return tile;
    },

    placeStones(count){
        const positions=[];
        // Avoid center and corners for fairness
        const candidates=[];
        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
            if((r===0&&c===0)||(r===0&&c===3)||(r===3&&c===0)||(r===3&&c===3))continue;
            candidates.push({r,c});
        }
        for(let i=candidates.length-1;i>0;i--){
            const j=Math.floor(Math.random()*i);
            [candidates[i],candidates[j]]=[candidates[j],candidates[i]];
        }
        for(let i=0;i<Math.min(count,candidates.length);i++){
            this.createStoneTile(candidates[i].r,candidates[i].c);
        }
    },

    tileClass(v){
        if(v<=0)return'';
        if(v<=8192)return'tile-'+v;
        return'tile-super';
    },

    // ===== MOVE =====
    move(dir){
        if(!this.gameActive||this.animating)return false;
        if(this.targeting)return false;

        // Save for undo
        this.saveHistory();

        const moved=this.executeMove(dir);
        if(!moved){this.history=null;return false;}

        this.animating=true;
        this.moveCount++;

        // After slide animation
        setTimeout(()=>{
            // Decrease freeze counters
            for(let r=0;r<4;r++)for(let c=0;c<4;c++){
                const t=this.grid[r][c];
                if(t&&t.frozen>0){
                    t.frozen--;
                    if(t.frozen===0){
                        const el=this.tileElements[t.id];
                        if(el)el.classList.remove('tile-frozen');
                    }
                }
            }

            // Add new tile
            const rng=(this.mode==='daily')?this.dailyRng:null;
            this.addRandomTile(rng);

            this.updateGameUI();
            this.animating=false;

            // Check win/lose
            this.checkGameState();
        },160);

        return true;
    },

    executeMove(dir){
        // dir: 0=up, 1=right, 2=down, 3=left
        let moved=false;
        let mergeCount=0;
        let scoreGained=0;
        const cs=this.getCellSize(),gap=this.getGap();

        const getLine=(i,dir)=>{
            const line=[];
            for(let j=0;j<4;j++){
                let r,c;
                if(dir===0){r=j;c=i;}        // up: column i, top to bottom
                else if(dir===1){r=i;c=3-j;}  // right: row i, right to left
                else if(dir===2){r=3-j;c=i;}  // down: column i, bottom to top
                else{r=i;c=j;}                 // left: row i, left to right
                line.push({r,c,tile:this.grid[r][c]});
            }
            return line;
        };

        const setPos=(r,c,tile)=>{this.grid[r][c]=tile;};

        for(let i=0;i<4;i++){
            const line=getLine(i,dir);

            // Extract non-null, movable tiles
            const tiles=[];
            const stonePositions=[];

            for(let j=0;j<4;j++){
                if(line[j].tile){
                    if(line[j].tile.isStone){
                        stonePositions.push(j);
                    }else{
                        tiles.push({...line[j],origJ:j});
                    }
                }
            }

            // Build result positions
            const result=Array(4).fill(null);

            // Place stones first
            for(const sp of stonePositions){
                result[sp]=line[sp].tile;
            }

            // Process movable tiles (compress + merge)
            let pos=0;
            const processed=[];
            let ti=0;
            while(ti<tiles.length){
                // Find next available position (skip stones)
                while(pos<4&&result[pos]!==null)pos++;
                if(pos>=4)break;

                const cur=tiles[ti];
                if(ti+1<tiles.length&&
                    cur.tile.value===tiles[ti+1].tile.value&&
                    cur.tile.frozen===0&&tiles[ti+1].tile.frozen===0){
                    // Merge
                    let newVal=cur.tile.value*2;
                    if(this.doubleActive){newVal=cur.tile.value*4;this.doubleActive=false;}
                    const mergedTile={...cur.tile,value:newVal,frozen:0};

                    // Animate both tiles to merge position
                    const targetR=line[pos].r,targetC=line[pos].c;
                    const keptId=cur.tile.id;
                    const consumedId=tiles[ti+1].tile.id;
                    const el1=this.tileElements[keptId];
                    const el2=this.tileElements[consumedId];

                    if(el1)el1.style.transform=`translate(${targetC*(cs+gap)+gap}px,${targetR*(cs+gap)+gap}px)`;
                    if(el2)el2.style.transform=`translate(${targetC*(cs+gap)+gap}px,${targetR*(cs+gap)+gap}px)`;

                    // After animation, update DOM (captured by value)
                    ((e1,e2,cid,nv,self)=>{
                        setTimeout(()=>{
                            if(e2){e2.remove();delete self.tileElements[cid];}
                            if(e1){
                                e1.className='tile '+self.tileClass(nv);
                                e1.querySelector('.tile-inner').textContent=nv;
                                e1.classList.add('tile-merged');
                                setTimeout(()=>e1.classList.remove('tile-merged'),250);
                            }
                        },140);
                    })(el1,el2,consumedId,newVal,this);

                    result[pos]=mergedTile;
                    this.tileElements[mergedTile.id]=el1;
                    scoreGained+=newVal;
                    mergeCount++;
                    moved=true;
                    ti+=2;
                }else{
                    // Just move
                    const targetR=line[pos].r,targetC=line[pos].c;
                    const el=this.tileElements[cur.tile.id];
                    if(el)el.style.transform=`translate(${targetC*(cs+gap)+gap}px,${targetR*(cs+gap)+gap}px)`;

                    if(cur.r!==targetR||cur.c!==targetC)moved=true;
                    result[pos]=cur.tile;
                    ti++;
                }
                pos++;
            }

            // Update grid
            for(let j=0;j<4;j++){
                setPos(line[j].r,line[j].c,result[j]);
            }

            SND.merge(scoreGained||2);
        }

        this.score+=scoreGained;
        if(this.score>this.bestScore){
            this.bestScore=this.score;
            this.saveData();
        }
        if(this.mode==='daily'){
            this.saveDailyBest(this.score);
        }

        // Combo
        if(mergeCount>0){
            this.combo++;
            if(this.combo>=BALANCE.comboThreshold){
                if(Math.random()<BALANCE.puDropRate){
                    this.awardRandomPU();
                }
                this.combo=0;
            }
        }else{
            this.combo=0;
        }

        return moved;
    },

    // ===== HISTORY (Undo) =====
    saveHistory(){
        this.history={
            grid:this.grid.map(row=>row.map(t=>t?{...t}:null)),
            score:this.score,
            moveCount:this.moveCount,
            combo:this.combo,
            doubleActive:this.doubleActive,
            powerUps:{...this.powerUps},
        };
    },

    restoreHistory(){
        if(!this.history)return false;
        this.grid=this.history.grid;
        this.score=this.history.score;
        this.moveCount=this.history.moveCount;
        this.combo=this.history.combo;
        this.doubleActive=this.history.doubleActive;
        this.powerUps=this.history.powerUps;
        this.history=null;
        this.rebuildTileDOM();
        this.updateGameUI();
        this.renderPowerUps();
        return true;
    },

    rebuildTileDOM(){
        const gc=document.getElementById('gridContainer');
        gc.querySelectorAll('.tile').forEach(t=>t.remove());
        this.tileElements={};
        this.nextTileId=1;
        const cs=this.getCellSize(),gap=this.getGap();

        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
            const t=this.grid[r][c];
            if(!t)continue;
            const id=this.nextTileId++;
            t.id=id;

            const el=document.createElement('div');
            if(t.isStone){
                el.className='tile tile-stone';
                el.innerHTML=`<div class="tile-inner"></div>`;
            }else{
                el.className='tile '+this.tileClass(t.value);
                el.innerHTML=`<div class="tile-inner">${t.value}</div>`;
                if(t.frozen>0)el.classList.add('tile-frozen');
            }
            el.style.width=cs+'px';el.style.height=cs+'px';
            el.style.transform=`translate(${c*(cs+gap)+gap}px,${r*(cs+gap)+gap}px)`;
            el.dataset.id=id;
            gc.appendChild(el);
            this.tileElements[id]=el;
        }
    },

    // ===== GAME STATE CHECK =====
    checkGameState(){
        // Stage mode: check goal
        if(this.mode==='stage'){
            const st=STAGES[this.stageLevel-1]||STAGES[STAGES.length-1];
            if(this.isStageGoalMet(st)){
                this.gameActive=false;
                this.stageCleared[this.stageLevel]=this.calcStars(st);
                this.saveData();
                SND.win();
                setTimeout(()=>{
                    document.getElementById('scTitle').textContent=this.t('stageCleared');
                    document.getElementById('scText').textContent=
                        this.t('level')+' '+this.stageLevel+' â€” '+this.t('score')+': '+this.score.toLocaleString();
                    this.showOverlay('stageClearOverlay');
                },200);
                return;
            }
            // Check move limit
            if(st.moves&&this.moveCount>=st.moves){
                if(!this.isStageGoalMet(st)){
                    this.gameActive=false;
                    SND.gameover();
                    setTimeout(()=>this.showGameOver(this.t('noMoves')),200);
                    return;
                }
            }
        }

        // Check for 2048 tile (classic/daily)
        if(!this.won2048&&this.mode!=='stage'){
            for(let r=0;r<4;r++)for(let c=0;c<4;c++){
                if(this.grid[r][c]&&this.grid[r][c].value>=2048){
                    this.won2048=true;
                    SND.win();
                    setTimeout(()=>{
                        document.getElementById('winTitle').textContent=this.t('youWin');
                        document.getElementById('winScore').textContent=this.score.toLocaleString();
                        this.showOverlay('winOverlay');
                    },200);
                    return;
                }
            }
        }

        // Check game over
        if(this.isGameOver()){
            this.gameActive=false;
            SND.gameover();
            setTimeout(()=>this.showGameOver(),300);
        }
    },

    isStageGoalMet(st){
        if(st.goalType==='tile'){
            for(let r=0;r<4;r++)for(let c=0;c<4;c++)
                if(this.grid[r][c]&&this.grid[r][c].value>=st.goalValue)return true;
            return false;
        }
        if(st.goalType==='score')return this.score>=st.goalValue;
        return false;
    },
    calcStars(st){
        if(st.moves){
            const used=this.moveCount;
            const limit=st.moves;
            if(used<=limit*0.5)return 3;
            if(used<=limit*0.75)return 2;
            return 1;
        }
        return this.score>=(st.goalValue*2)?3:this.score>=(st.goalValue*1.3)?2:1;
    },

    isGameOver(){
        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
            if(!this.grid[r][c])return false;
        }
        for(let r=0;r<4;r++)for(let c=0;c<4;c++){
            const t=this.grid[r][c];
            if(t.isStone)continue;
            if(t.frozen>0)continue;
            // Check neighbors
            const dirs=[[0,1],[1,0]];
            for(const[dr,dc]of dirs){
                const nr=r+dr,nc=c+dc;
                if(nr<4&&nc<4){
                    const n=this.grid[nr][nc];
                    if(n&&!n.isStone&&n.frozen===0&&n.value===t.value)return false;
                }
            }
        }
        return true;
    },

    showGameOver(extraMsg){
        document.getElementById('goIcon').textContent='ğŸ˜µ';
        document.getElementById('goTitle').textContent=this.t('gameOver');
        document.getElementById('goScore').textContent=this.score.toLocaleString();
        document.getElementById('goText').textContent=extraMsg||'';
        this.showOverlay('gameOverOverlay');
    },

    // ===== UI ACTIONS =====
    retryGame(){
        this.hideAllOverlays();
        if(this.mode==='stage')this.startGame('stage',this.stageLevel);
        else this.startGame(this.mode);
    },
    continueAfterWin(){
        this.hideAllOverlays();
        this.gameActive=true;
    },
    nextStage(){
        this.hideAllOverlays();
        const next=this.stageLevel+1;
        if(next<=STAGES.length)this.startGame('stage',next);
        else this.backToMenu();
    },
    backToMenu(){
        this.hideAllOverlays();
        this.gameActive=false;
        this.targeting=null;
        this.showScreen('menu');
    },

    // ===== UPDATE GAME UI =====
    updateGameUI(){
        const t=k=>this.t(k);
        // Mode label
        const labels={classic:t('classic'),stage:t('stage')+' '+this.stageLevel,daily:t('daily')};
        document.getElementById('modeLabel').textContent=labels[this.mode]||'';

        // Scores
        document.getElementById('scoreLbl').textContent=t('score');
        document.getElementById('bestLbl').textContent=t('best');
        document.getElementById('scoreVal').textContent=this.score.toLocaleString();
        document.getElementById('bestVal').textContent=
            (this.mode==='daily'?this.getDailyBest():this.bestScore).toLocaleString();

        // Combo
        const cd=document.getElementById('comboDisplay');
        if(this.combo>0){
            cd.textContent=t('combo')+' Ã—'+this.combo+(this.combo>=2?' ğŸ”¥':'');
            cd.classList.add('pop');
            setTimeout(()=>cd.classList.remove('pop'),300);
        }else{
            cd.textContent='';
        }

        // Moves
        const md=document.getElementById('movesDisplay');
        if(this.mode==='stage'){
            const st=STAGES[this.stageLevel-1]||STAGES[STAGES.length-1];
            if(st.moves){
                md.textContent=t('movesLeft')+': '+(st.moves-this.moveCount);
                md.style.color=(st.moves-this.moveCount<=5)?'var(--red)':'var(--muted)';
            }else{
                md.textContent=t('moves')+': '+this.moveCount;
                md.style.color='var(--muted)';
            }
        }else{
            md.textContent=t('moves')+': '+this.moveCount;
            md.style.color='var(--muted)';
        }

        // Stage goal
        const sg=document.getElementById('stageGoal');
        if(this.mode==='stage'){
            const st=STAGES[this.stageLevel-1]||STAGES[STAGES.length-1];
            sg.textContent=t('goal')+': '+this.formatGoal(st);
        }else{
            sg.textContent='';
        }

        // Double indicator
        if(this.doubleActive){
            document.getElementById('stageGoal').textContent+=' âš¡2Ã—';
        }
    },

    formatGoal(st){
        const t=k=>this.t(k);
        if(st.goalType==='tile'){
            return st.moves
                ?t('goalTileMoves').replace('{n}',st.goalValue).replace('{m}',st.moves)
                :t('goalTile').replace('{n}',st.goalValue);
        }
        return st.moves
            ?t('goalScoreMoves').replace('{n}',st.goalValue.toLocaleString()).replace('{m}',st.moves)
            :t('goalScore').replace('{n}',st.goalValue.toLocaleString());
    },

    // ===== POWER-UPS =====
    renderPowerUps(){
        const bar=document.getElementById('powerupBar');
        bar.innerHTML='';
        for(const type of POWERUP_TYPES){
            const btn=document.createElement('div');
            const count=this.powerUps[type];
            btn.className='pu-btn'+(count<=0?' disabled':'')+(this.targeting===type?' active':'');
            btn.innerHTML=`<div class="pu-icon">${PU_ICONS[type]}</div><div class="pu-count">Ã—${count}</div><div class="pu-name">${this.t(type)}</div>`;
            btn.onclick=()=>this.activatePowerUp(type);
            bar.appendChild(btn);
        }
    },

    activatePowerUp(type){
        if(!this.gameActive||this.animating)return;
        const count=this.powerUps[type];
        if(count<=0)return;

        if(type==='undo'){
            // Immediate use
            if(this.restoreHistory()){
                this.powerUps.undo--;
                SND.powerup();
                this.renderPowerUps();
            }
            return;
        }

        if(type==='double'){
            // Toggle double
            this.doubleActive=!this.doubleActive;
            if(this.doubleActive){
                this.powerUps.double--;
                SND.powerup();
                this.showToast('âš¡',this.t('double')+' ON!');
            }
            this.renderPowerUps();
            this.updateGameUI();
            return;
        }

        // Targeting power-ups: bomb, freeze, sniper
        if(this.targeting===type){
            // Cancel targeting
            this.targeting=null;
            document.getElementById('targetHint').classList.add('hidden');
        }else{
            this.targeting=type;
            document.getElementById('targetHint').textContent=this.t('selectTarget');
            document.getElementById('targetHint').classList.remove('hidden');
        }
        this.renderPowerUps();
    },

    onTileClick(row,col){
        if(!this.targeting||!this.gameActive)return;
        const tile=this.grid[row][col];
        if(!tile)return;

        const type=this.targeting;
        this.targeting=null;
        document.getElementById('targetHint').classList.add('hidden');
        this.powerUps[type]--;

        if(type==='bomb'){
            this.useBomb(row,col);
        }else if(type==='freeze'){
            this.useFreeze(row,col);
        }else if(type==='sniper'){
            this.useSniper(row,col);
        }

        this.renderPowerUps();
        this.updateGameUI();
    },

    useBomb(row,col){
        SND.bomb();
        // Show explosion FX
        const cs=this.getCellSize(),gap=this.getGap();
        const fx=document.createElement('div');
        fx.className='bomb-fx';
        const cx=col*(cs+gap)+gap+cs/2;
        const cy=row*(cs+gap)+gap+cs/2;
        fx.style.left=(cx-20)+'px';fx.style.top=(cy-20)+'px';
        fx.style.width='40px';fx.style.height='40px';
        document.getElementById('gridContainer').appendChild(fx);
        setTimeout(()=>fx.remove(),600);

        // Remove target + 8 neighbors
        for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
            const r=row+dr,c=col+dc;
            if(r<0||r>3||c<0||c>3)continue;
            const t=this.grid[r][c];
            if(!t)continue;
            const el=this.tileElements[t.id];
            if(el){
                el.classList.add('tile-remove');
                setTimeout(()=>{el.remove();delete this.tileElements[t.id];},200);
            }
            this.grid[r][c]=null;
        }
    },

    useFreeze(row,col){
        SND.powerup();
        const t=this.grid[row][col];
        if(!t||t.isStone)return;
        t.frozen=3;
        const el=this.tileElements[t.id];
        if(el)el.classList.add('tile-frozen');
        this.showToast('â„ï¸',this.t('freeze')+' (3)');
    },

    useSniper(row,col){
        SND.powerup();
        const t=this.grid[row][col];
        if(!t)return;
        const el=this.tileElements[t.id];
        if(el){
            el.classList.add('tile-remove');
            setTimeout(()=>{el.remove();delete this.tileElements[t.id];},200);
        }
        this.grid[row][col]=null;
    },

    awardRandomPU(){
        const available=POWERUP_TYPES.filter(t=>this.powerUps[t]<BALANCE.maxPU[t]);
        if(!available.length)return;
        const type=available[Math.floor(Math.random()*available.length)];
        this.powerUps[type]++;
        SND.powerup();
        this.showToast(PU_ICONS[type],'+1 '+this.t(type)+'!');
        this.renderPowerUps();
    },

    showToast(icon,text){
        const toast=document.getElementById('toast');
        document.getElementById('toastIcon').textContent=icon;
        document.getElementById('toastText').textContent=text;
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'),1500);
    },

    // ===== STAGES SCREEN =====
    showStages(){
        this.showScreen('stage');
        document.getElementById('stageTitle').textContent=this.t('stageSelect');
        const grid=document.getElementById('stageGrid');
        grid.innerHTML='';
        const maxUnlocked=this.getMaxStage()+1;

        for(let i=0;i<STAGES.length;i++){
            const lvl=i+1;
            const cleared=this.stageCleared[lvl];
            const locked=lvl>maxUnlocked&&!cleared;
            const cell=document.createElement('div');
            cell.className='stage-cell'+(locked?' locked':'')+(cleared?' cleared':'');
            const starsHtml=cleared?'â­'.repeat(cleared):'';
            cell.innerHTML=`<div>${locked?'ğŸ”’':lvl}</div><div class="stars">${starsHtml}</div>`;
            if(!locked)cell.onclick=()=>this.startGame('stage',lvl);
            grid.appendChild(cell);
        }
    },

    // ===== SETTINGS =====
    showSettings(){
        this.showScreen('settings');
        document.getElementById('settingsTitle').textContent=this.t('settings');
        document.getElementById('langLabel').textContent=this.t('language');
        const opts=document.getElementById('langOptions');
        opts.innerHTML='';
        const langs={en:'English',ko:'í•œêµ­ì–´',ja:'æ—¥æœ¬èª',zh:'ä¸­æ–‡'};
        for(const[code,name]of Object.entries(langs)){
            const btn=document.createElement('div');
            btn.className='setting-opt'+(this.lang===code?' active':'');
            btn.textContent=name;
            btn.onclick=()=>{
                this.lang=code;
                this.saveData();
                this.showSettings();
            };
            opts.appendChild(btn);
        }
    },

    showHelp(){
        this.showScreen('help');
        document.getElementById('helpTitle').textContent=this.t('help');
        document.getElementById('helpContent').innerHTML=this.t('helpContent');
    },

    // ===== INPUT =====
    handleGridTap(clientX,clientY){
        if(!this.targeting||!this.gameActive)return;
        const gc=document.getElementById('gridContainer');
        const rect=gc.getBoundingClientRect();
        const x=clientX-rect.left,y=clientY-rect.top;
        const cs=this.getCellSize(),gap=this.getGap();
        const col=Math.floor((x-gap*0.5)/(cs+gap));
        const row=Math.floor((y-gap*0.5)/(cs+gap));
        if(row>=0&&row<4&&col>=0&&col<4&&this.grid[row][col]){
            this.onTileClick(row,col);
        }
    },

    setupInput(){
        // Keyboard
        document.addEventListener('keydown',e=>{
            if(!this.gameActive)return;
            const map={ArrowUp:0,ArrowRight:1,ArrowDown:2,ArrowLeft:3,
                       w:0,d:1,s:2,a:3};
            if(e.key in map){
                e.preventDefault();
                this.move(map[e.key]);
            }
            // Escape to cancel targeting
            if(e.key==='Escape'&&this.targeting){
                this.targeting=null;
                document.getElementById('targetHint').classList.add('hidden');
                this.renderPowerUps();
            }
        });

        // Touch swipe + tap for targeting
        let sx,sy,active=false;
        const gc=document.getElementById('gridContainer');

        gc.addEventListener('touchstart',e=>{
            if(!this.gameActive)return;
            const t=e.touches[0];
            sx=t.clientX;sy=t.clientY;active=true;
            e.preventDefault();
        },{passive:false});

        gc.addEventListener('touchmove',e=>{
            e.preventDefault();
        },{passive:false});

        gc.addEventListener('touchend',e=>{
            if(!active||!this.gameActive)return;
            active=false;
            const t=e.changedTouches[0];
            const dx=t.clientX-sx,dy=t.clientY-sy;
            const absDx=Math.abs(dx),absDy=Math.abs(dy);
            if(Math.max(absDx,absDy)<20){
                // Short touch = tap â€” handle targeting
                this.handleGridTap(t.clientX,t.clientY);
                return;
            }
            if(absDx>absDy){
                this.move(dx>0?1:3);
            }else{
                this.move(dy>0?2:0);
            }
        },{passive:false});

        // Mouse swipe + click for targeting (desktop)
        let mx,my,mactive=false;
        gc.addEventListener('mousedown',e=>{
            if(!this.gameActive)return;
            mx=e.clientX;my=e.clientY;mactive=true;
        });
        document.addEventListener('mousemove',e=>{
            if(!mactive)return;
            e.preventDefault();
        });
        document.addEventListener('mouseup',e=>{
            if(!mactive||!this.gameActive)return;
            mactive=false;
            const dx=e.clientX-mx,dy=e.clientY-my;
            const absDx=Math.abs(dx),absDy=Math.abs(dy);
            if(Math.max(absDx,absDy)<20){
                // Short move = click â€” handle targeting
                this.handleGridTap(e.clientX,e.clientY);
                return;
            }
            if(absDx>absDy){
                this.move(dx>0?1:3);
            }else{
                this.move(dy>0?2:0);
            }
        });
    }
};

// ===== BOOT =====
G.init();
</script>
</body>
</html>
