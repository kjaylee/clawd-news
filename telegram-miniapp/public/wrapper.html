<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="color-scheme" content="light dark">
    <title>East Sea Games ğŸ®</title>

    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* â”€â”€ Telegram í…Œë§ˆ ë³€ìˆ˜ â”€â”€ */
        :root {
            --tg-bg: #ffffff;
            --tg-text: #000000;
            --tg-hint: #999999;
            --tg-link: #2481cc;
            --tg-button: #2481cc;
            --tg-button-text: #ffffff;
            --tg-secondary-bg: #f0f0f0;
            --tg-viewport-height: 100vh;
            --tg-viewport-stable-height: 100vh;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
            display: flex;
            flex-direction: column;
        }

        /* â”€â”€ ë¡œë”© í™”ë©´ â”€â”€ */
        #loading-screen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--tg-bg);
            transition: opacity 0.3s ease;
        }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loader { width: 50px; height: 50px; border: 4px solid var(--tg-secondary-bg); border-top-color: var(--tg-button); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { margin-top: 16px; color: var(--tg-hint); font-size: 14px; }

        /* â”€â”€ ê²Œì„ iframe â”€â”€ */
        #game-frame {
            flex: 1;
            width: 100%;
            border: none;
            background: transparent;
        }

        /* â”€â”€ ì˜¤ë²„ë ˆì´ UI (ìƒì , ê´‘ê³  ë“±) â”€â”€ */
        .overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .overlay.active { display: flex; }
        .overlay-panel {
            background: var(--tg-bg);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 360px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .overlay-panel h2 {
            font-size: 20px;
            margin-bottom: 16px;
            text-align: center;
        }

        /* â”€â”€ ìƒì  ì•„ì´í…œ â”€â”€ */
        .shop-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            background: var(--tg-secondary-bg);
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .shop-item:active { transform: scale(0.97); }
        .shop-item-icon { font-size: 28px; }
        .shop-item-info { flex: 1; }
        .shop-item-name { font-weight: 600; font-size: 14px; }
        .shop-item-desc { font-size: 12px; color: var(--tg-hint); }
        .shop-item-price {
            background: var(--tg-button);
            color: var(--tg-button-text);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* â”€â”€ ê´‘ê³  ìŠ¬ë¡¯ â”€â”€ */
        .ad-slot {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 600;
            transition: transform 0.1s;
        }
        .ad-slot:active { transform: scale(0.97); }

        /* â”€â”€ ë‹«ê¸° ë²„íŠ¼ â”€â”€ */
        .close-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            border: none;
            border-radius: 12px;
            background: var(--tg-secondary-bg);
            color: var(--tg-text);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- ë¡œë”© í™”ë©´ -->
<div id="loading-screen">
    <div class="loader"></div>
    <div class="loader-text">ê²Œì„ ë¡œë”© ì¤‘...</div>
</div>

<!-- ê²Œì„ iframe -->
<iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-popups" allow="autoplay"></iframe>

<!-- ìƒì  ì˜¤ë²„ë ˆì´ -->
<div id="shop-overlay" class="overlay">
    <div class="overlay-panel">
        <h2>ğŸ›’ ìƒì </h2>
        <div id="shop-items"></div>
        <div class="ad-slot" onclick="WrapperAds.showRewarded()">
            ğŸ“º ê´‘ê³  ë³´ê³  ë³´ìƒ ë°›ê¸°
        </div>
        <button class="close-btn" onclick="WrapperShop.hide()">ë‹«ê¸°</button>
    </div>
</div>

<script>
// ================================================================
// Telegram Mini App ê²Œì„ ë˜í¼ â€” í•µì‹¬ ëª¨ë“ˆ
// ================================================================

// â”€â”€ 1. Telegram WebApp ì´ˆê¸°í™” ëª¨ë“ˆ â”€â”€
const TG = {
    app: window.Telegram?.WebApp,
    user: null,
    isReady: false,

    init() {
        if (!this.app) {
            console.warn('[TG] Not running inside Telegram');
            return false;
        }

        // ì•± ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
        this.app.ready();

        // ì „ì²´í™”ë©´ í™•ì¥
        this.app.expand();

        // í’€ìŠ¤í¬ë¦° ìš”ì²­ (v8.0+)
        if (this.app.requestFullscreen) {
            try { this.app.requestFullscreen(); } catch(e) {}
        }

        // ìœ ì € ì •ë³´
        this.user = this.app.initDataUnsafe?.user || null;

        // í…Œë§ˆ ì ìš©
        this._applyTheme();

        // ë·°í¬íŠ¸ ì´ë²¤íŠ¸
        this.app.onEvent('viewportChanged', (e) => {
            if (e.isStateStable) this._syncViewport();
        });
        this._syncViewport();

        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
        this._setupBackButton();

        // ì„¸ì´í”„ ì—ë¦¬ì–´ (v8.0+)
        this._applySafeArea();

        this.isReady = true;
        console.log(`[TG] Initialized â€” user: ${this.user?.id || 'anonymous'}`);
        return true;
    },

    // í…Œë§ˆ íŒŒë¼ë¯¸í„° â†’ CSS ë³€ìˆ˜
    _applyTheme() {
        const tp = this.app.themeParams;
        if (!tp) return;
        const root = document.documentElement.style;
        root.setProperty('--tg-bg', tp.bg_color || '#ffffff');
        root.setProperty('--tg-text', tp.text_color || '#000000');
        root.setProperty('--tg-hint', tp.hint_color || '#999999');
        root.setProperty('--tg-link', tp.link_color || '#2481cc');
        root.setProperty('--tg-button', tp.button_color || '#2481cc');
        root.setProperty('--tg-button-text', tp.button_text_color || '#ffffff');
        root.setProperty('--tg-secondary-bg', tp.secondary_bg_color || '#f0f0f0');
    },

    _syncViewport() {
        const h = this.app.viewportStableHeight || this.app.viewportHeight;
        if (h) {
            document.documentElement.style.setProperty('--tg-viewport-height', `${h}px`);
            document.documentElement.style.setProperty('--tg-viewport-stable-height', `${h}px`);
        }
    },

    _applySafeArea() {
        if (this.app.safeAreaInset) {
            const sa = this.app.safeAreaInset;
            const root = document.documentElement.style;
            root.setProperty('--safe-top', `${sa.top || 0}px`);
            root.setProperty('--safe-bottom', `${sa.bottom || 0}px`);
            root.setProperty('--safe-left', `${sa.left || 0}px`);
            root.setProperty('--safe-right', `${sa.right || 0}px`);
        }
        // contentSafeAreaInset (v8.0+)
        if (this.app.contentSafeAreaInset) {
            const csa = this.app.contentSafeAreaInset;
            const root = document.documentElement.style;
            // Add content safe area on top of device safe area
            const totalTop = (this.app.safeAreaInset?.top || 0) + (csa.top || 0);
            root.setProperty('--safe-top', `${totalTop}px`);
        }
    },

    _setupBackButton() {
        if (!this.app.BackButton) return;
        this.app.BackButton.show();
        this.app.BackButton.onClick(() => {
            // ìƒì ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒì  ë‹«ê¸°
            if (document.getElementById('shop-overlay').classList.contains('active')) {
                WrapperShop.hide();
                return;
            }
            // ê²Œì„ ë‚´ ë’¤ë¡œê°€ê¸° ì‹œë„
            const frame = document.getElementById('game-frame');
            if (frame?.contentWindow) {
                frame.contentWindow.postMessage({ type: 'tg-back' }, '*');
            }
            // 0.5ì´ˆ í›„ì—ë„ ì²˜ë¦¬ ì•ˆë˜ë©´ ì•± ë‹«ê¸°
            setTimeout(() => { this.app.close(); }, 500);
        });
    },

    // â”€â”€ ìœ í‹¸ë¦¬í‹° â”€â”€
    getUserId()  { return this.user?.id || 'anonymous'; },
    getUserName(){ return this.user?.first_name || 'Player'; },
    isPremium()  { return !!this.user?.is_premium; },
    getLang()    { return this.user?.language_code || 'en'; },
    getInitData(){ return this.app?.initData || ''; },

    // í–…í‹± í”¼ë“œë°±
    haptic(type, style) {
        if (!this.app?.HapticFeedback) return;
        switch(type) {
            case 'impact':       this.app.HapticFeedback.impactOccurred(style || 'medium'); break;
            case 'notification': this.app.HapticFeedback.notificationOccurred(style || 'success'); break;
            case 'selection':    this.app.HapticFeedback.selectionChanged(); break;
        }
    },

    // ê³µìœ 
    share(text, url) {
        if (this.app) {
            this.app.openTelegramLink(
                `https://t.me/share/url?url=${encodeURIComponent(url || '')}&text=${encodeURIComponent(text)}`
            );
        }
    },

    // ìœ ì €ë³„ ë°ì´í„° ì €ì¥/ë¡œë“œ
    saveData(key, value) {
        localStorage.setItem(`tg_${this.getUserId()}_${key}`, JSON.stringify(value));
    },
    loadData(key, fallback = null) {
        try {
            const raw = localStorage.getItem(`tg_${this.getUserId()}_${key}`);
            return raw ? JSON.parse(raw) : fallback;
        } catch { return fallback; }
    },

    // í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ (v6.9+)
    async cloudGet(key) {
        return new Promise((resolve) => {
            if (this.app?.CloudStorage) {
                this.app.CloudStorage.getItem(key, (err, val) => resolve(err ? null : val));
            } else { resolve(null); }
        });
    },
    async cloudSet(key, value) {
        return new Promise((resolve) => {
            if (this.app?.CloudStorage) {
                this.app.CloudStorage.setItem(key, String(value), (err) => resolve(!err));
            } else { resolve(false); }
        });
    }
};


// â”€â”€ 2. ìƒì  ëª¨ë“ˆ (Stars ê²°ì œ) â”€â”€
const WrapperShop = {
    API_URL: '', // ì„œë²„ URL â€” ë°°í¬ ì‹œ ì„¤ì •

    // ìƒí’ˆ ì¹´íƒˆë¡œê·¸ (ê²Œì„ë³„ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
    products: [
        { id: 'coins_s',  icon: 'ğŸ’°', name: 'ì½”ì¸ 5,000',       desc: 'ê¸°ë³¸ ì½”ì¸ íŒ©',       stars: 10  },
        { id: 'coins_m',  icon: 'ğŸ’°', name: 'ì½”ì¸ 30,000',      desc: 'ëŒ€ëŸ‰ ì½”ì¸ íŒ©',       stars: 50  },
        { id: 'coins_l',  icon: 'ğŸ’°', name: 'ì½”ì¸ 75,000',      desc: 'ë©”ê°€ ì½”ì¸ íŒ©',       stars: 100 },
        { id: 'spins_5',  icon: 'ğŸ°', name: 'ì¶”ê°€ ìŠ¤í•€ 5íšŒ',    desc: 'ì¦‰ì‹œ ìŠ¤í•€ ì¶©ì „',     stars: 15  },
        { id: 'lives_5',  icon: 'â¤ï¸', name: 'ìƒëª… 5ê°œ',          desc: 'ì¦‰ì‹œ ìƒëª… ì¶©ì „',     stars: 10  },
        { id: 'shield',   icon: 'ğŸ›¡ï¸', name: 'ì‹¤ë“œ 1ê°œ',          desc: 'ê³µê²© 1íšŒ ë°©ì–´',      stars: 20  },
        { id: 'vip_1d',   icon: 'ğŸ‘‘', name: 'VIP 1ì¼',          desc: '24ì‹œê°„ 2x ë³´ìƒ',     stars: 50  },
    ],

    // ìƒì  ì—´ê¸°
    show(customProducts) {
        const items = customProducts || this.products;
        const container = document.getElementById('shop-items');
        container.innerHTML = items.map(p => `
            <div class="shop-item" onclick="WrapperShop.purchase('${p.id}')">
                <div class="shop-item-icon">${p.icon}</div>
                <div class="shop-item-info">
                    <div class="shop-item-name">${p.name}</div>
                    <div class="shop-item-desc">${p.desc}</div>
                </div>
                <div class="shop-item-price">â­ ${p.stars}</div>
            </div>
        `).join('');
        document.getElementById('shop-overlay').classList.add('active');
    },

    hide() {
        document.getElementById('shop-overlay').classList.remove('active');
    },

    // ê²°ì œ ì‹¤í–‰
    async purchase(productId) {
        if (!TG.app) {
            alert('í…”ë ˆê·¸ë¨ì—ì„œë§Œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }
        try {
            const res = await fetch(`${this.API_URL}/api/invoice`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Init-Data': TG.getInitData()
                },
                body: JSON.stringify({ productId, userId: TG.getUserId() })
            });
            if (!res.ok) throw new Error('Invoice creation failed');
            const { invoiceLink } = await res.json();

            TG.app.openInvoice(invoiceLink, (status) => {
                if (status === 'paid') {
                    TG.haptic('notification', 'success');
                    // ê²Œì„ì— ê²°ì œ ì„±ê³µ ì•Œë¦¼
                    const frame = document.getElementById('game-frame');
                    frame?.contentWindow?.postMessage({
                        type: 'tg-payment-success',
                        productId
                    }, '*');
                    this.hide();
                } else if (status === 'failed') {
                    TG.app.showAlert('ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        } catch(err) {
            console.error('[Shop] Purchase error:', err);
            TG.app?.showAlert?.('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') || alert('ê²°ì œ ì˜¤ë¥˜');
        }
    }
};


// â”€â”€ 3. ê´‘ê³  ëª¨ë“ˆ (ë³´ìƒí˜• ê´‘ê³  placeholder) â”€â”€
const WrapperAds = {
    ready: false,
    monetagZone: '', // Monetag Zone ID

    init() {
        // ê´‘ê³  SDK ë¡œë“œ (ì‹¤ì œ ë°°í¬ ì‹œ í™œì„±í™”)
        if (!this.monetagZone) {
            console.log('[Ads] No zone ID â€” ad SDK not loaded (placeholder mode)');
            this.ready = false;
            return;
        }
        // Monetag SDK ë™ì  ë¡œë“œ
        const s = document.createElement('script');
        s.src = `https://monetag.com/sdk/rewarded.js?zone=${this.monetagZone}`;
        s.async = true;
        s.onload = () => { this.ready = true; console.log('[Ads] SDK loaded'); };
        document.head.appendChild(s);
    },

    // ë³´ìƒí˜• ê´‘ê³  í‘œì‹œ
    showRewarded(onComplete) {
        if (!this.ready) {
            // Placeholder: ì‹¤ì œ ê´‘ê³  ì—†ìœ¼ë©´ ë°”ë¡œ ë³´ìƒ (ê°œë°œìš©)
            console.log('[Ads] Placeholder â€” simulating ad watch');
            TG.app?.showPopup?.({
                title: 'ğŸ“º ê´‘ê³  (ê°œë°œ ëª¨ë“œ)',
                message: 'ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë³´ìƒí˜• ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.\nê°œë°œ ëª¨ë“œì—ì„œëŠ” ì¦‰ì‹œ ë³´ìƒí•©ë‹ˆë‹¤.',
                buttons: [
                    { id: 'ok', type: 'ok', text: 'ë³´ìƒ ë°›ê¸°' }
                ]
            }, () => {
                TG.haptic('notification', 'success');
                if (onComplete) onComplete(true);
                // ê²Œì„ì— ê´‘ê³  ì™„ë£Œ ì•Œë¦¼
                const frame = document.getElementById('game-frame');
                frame?.contentWindow?.postMessage({ type: 'tg-ad-reward' }, '*');
            });
            return;
        }
        // ì‹¤ì œ Monetag í˜¸ì¶œ
        if (window.monetag?.show) {
            window.monetag.show({
                zone: this.monetagZone,
                type: 'rewarded',
                onComplete: () => {
                    TG.haptic('notification', 'success');
                    if (onComplete) onComplete(true);
                    const frame = document.getElementById('game-frame');
                    frame?.contentWindow?.postMessage({ type: 'tg-ad-reward' }, '*');
                },
                onClose: () => { if (onComplete) onComplete(false); },
                onError: () => { if (onComplete) onComplete(false); }
            });
        }
    }
};


// â”€â”€ 4. ê²Œì„ ë¡œë” â”€â”€
const GameLoader = {
    load(gameUrl) {
        const frame = document.getElementById('game-frame');
        const loading = document.getElementById('loading-screen');

        frame.src = gameUrl;
        frame.onload = () => {
            loading.classList.add('hidden');
            setTimeout(() => { loading.style.display = 'none'; }, 300);

            // ê²Œì„ì— TG ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬
            frame.contentWindow.postMessage({
                type: 'tg-init',
                user: TG.user,
                theme: TG.app?.themeParams || {},
                isPremium: TG.isPremium(),
                lang: TG.getLang()
            }, '*');
        };
    }
};


// â”€â”€ 5. ê²Œì„ â†” ë˜í¼ ë©”ì‹œì§€ ë¸Œë¦¿ì§€ â”€â”€
window.addEventListener('message', (event) => {
    const { type, data } = event.data || {};
    switch(type) {
        // ê²Œì„ â†’ ë˜í¼: ìƒì  ì—´ê¸°
        case 'tg-open-shop':
            WrapperShop.show(data?.products);
            break;
        // ê²Œì„ â†’ ë˜í¼: ê²°ì œ ìš”ì²­
        case 'tg-purchase':
            WrapperShop.purchase(data?.productId);
            break;
        // ê²Œì„ â†’ ë˜í¼: ë³´ìƒí˜• ê´‘ê³  ìš”ì²­
        case 'tg-show-ad':
            WrapperAds.showRewarded((ok) => {
                const frame = document.getElementById('game-frame');
                frame?.contentWindow?.postMessage({
                    type: 'tg-ad-result',
                    watched: ok,
                    rewardType: data?.rewardType
                }, '*');
            });
            break;
        // ê²Œì„ â†’ ë˜í¼: í–…í‹±
        case 'tg-haptic':
            TG.haptic(data?.hapticType || 'impact', data?.style || 'medium');
            break;
        // ê²Œì„ â†’ ë˜í¼: ê³µìœ 
        case 'tg-share':
            TG.share(data?.text, data?.url);
            break;
        // ê²Œì„ â†’ ë˜í¼: ì ìˆ˜ ì €ì¥ (ì„œë²„)
        case 'tg-save-score':
            fetch(`${WrapperShop.API_URL}/api/score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Init-Data': TG.getInitData()
                },
                body: JSON.stringify({
                    gameId: data?.gameId,
                    score: data?.score,
                    userId: TG.getUserId()
                })
            }).catch(err => console.error('[Score] Save error:', err));
            break;
        // ê²Œì„ â†’ ë˜í¼: ë’¤ë¡œê°€ê¸° ì²˜ë¦¬ ì™„ë£Œ
        case 'tg-back-handled':
            // ê²Œì„ì´ ìì²´ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì•± ë‹«ê¸° ì•ˆ í•¨
            break;
    }
});


// â”€â”€ ì´ˆê¸°í™” â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    const isTG = TG.init();

    // í™˜ê²½ì„¤ì •
    const params = new URLSearchParams(window.location.search);
    const gameUrl = params.get('game');
    const apiUrl = params.get('api');

    if (apiUrl) WrapperShop.API_URL = apiUrl;
    WrapperAds.monetagZone = params.get('ad_zone') || '';
    WrapperAds.init();

    // ê²Œì„ ë¡œë“œ
    if (gameUrl) {
        GameLoader.load(decodeURIComponent(gameUrl));
    } else {
        // ê¸°ë³¸: URLì—ì„œ ê²Œì„ ê²½ë¡œ ì¶”ì¶œ
        const gameName = params.get('name') || 'spin-village';
        const baseUrl = params.get('base') || '/games';
        GameLoader.load(`${baseUrl}/${gameName}/index.html`);
    }
});
</script>

</body>
</html>
